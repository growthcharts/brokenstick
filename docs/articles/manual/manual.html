<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="brokenstick">
<title>Broken Stick Model for Irregular Longitudinal Data • brokenstick</title>
<script src="../../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet">
<script src="../../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../../pkgdown.js"></script><meta property="og:title" content="Broken Stick Model for Irregular Longitudinal Data">
<meta property="og:description" content="brokenstick">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../../index.html">brokenstick</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.2.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../../articles/brokenstick.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../../articles/mainfunctions.html">Overview of main functions</a>
    <a class="dropdown-item" href="../../articles/manual/manual.html">Broken Stick Model for Irregular Longitudinal Data</a>
    <a class="dropdown-item" href="../../articles/perfectmodel.html">Check perfect model</a>
    <a class="dropdown-item" href="../../articles/oldfriends.html">Help for old friends</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/growthcharts/brokenstick/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">


<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Broken Stick Model for Irregular Longitudinal Data</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/growthcharts/brokenstick/blob/HEAD/vignettes/manual/manual.Rmd" class="external-link"><code>vignettes/manual/manual.Rmd</code></a></small>
      <div class="d-none name"><code>manual.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="abstract">Abstract<a class="anchor" aria-label="anchor" href="#abstract"></a>
</h2>
<p>Many longitudinal studies collect data that have irregular observation times, often requiring the application of linear mixed models with time-varying outcomes. This paper presents an alternative that splits the quantitative analysis into two steps. The first step converts irregularly observed data into a set of repeated measures through the broken stick model. The second step estimates the parameters of scientific interest from the repeated measurements at the subject level. The broken stick model approximates each subject’s trajectory by a series of connected straight lines. The breakpoints, specified by the user, divide the time axis into consecutive intervals common to all subjects. Specification of the model requires just three variables: time, measurement and subject. The model is a special case of the linear mixed model, with time as a linear <span class="math inline">\(B\)</span>-spline and subject as the grouping factor. The main assumptions are: subjects are exchangeable, trajectories between consecutive breakpoints are straight, random effects follow a multivariate normal distribution, and unobserved data are missing at random. The <strong>R</strong> package <strong>brokenstick</strong> v2.2.0 offers tools to calculate, predict, impute and visualise broken stick estimates. The package supports two optimisation methods, including options to constrain the variance-covariance matrix of the random effects. We demonstrate six applications of the model: detection of critical periods, estimation of the time-to-time correlations, profile analysis, curve interpolation, multiple imputation and personalised prediction of future outcomes by curve matching.</p>
</div>
<div class="section level2" number="1">
<h2 id="introduction">
<span class="header-section-number">1</span> Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>Most longitudinal studies plan data collection to occur at a fixed set of time points. In practice, the realised times can differ - sometimes substantially - from the scheduled times. There may be many reasons for such differences. For example, we planned a visit at the weekend or during a holiday, the subject didn’t show up, the measurement device was out of order, or the investigator got ill. Varying observation times may also result from combining data from multiple studies, each collected according to its own design. Timing variation can be substantial in observational studies, especially if the survey lacks a pre-specified schedule. Longitudinal data with timing differences between subjects are said to be <em>irregular</em>.</p>
<p>Irregular observation times present significant challenges for quantitative analysis. For example, it isn’t easy to calculate the time-to-time correlation matrix if the data spread thinly over time. It might also be complex to predict the future from past data if subject times differ. Observation times may also relate to the process of interest. For example, more severe patients get more frequent measurements; unmotivated cohort members respond more rarely, and so on. Conventional methods like MANOVA, regression or cluster analysis break down if observation times differ or if drop-out is selective.</p>
<p>While irregular observation times occur all over science, there is no universal or principled approach to resolve the problem. One straightforward fix is to take only those dates for which data are available (e.g., dates when stocks are traded), thus ignoring the times when markets are closed. One may also create bins of time intervals around the planned times, thereby ignoring within-period differences. Another ad-hoc method predicts the value at the scheduled time from neighbouring data, e.g., by linear interpolation or smoothing, typically reducing the variability in the data. Some quick fixes create data sets where the timing problem seems to have “gone away”, which may tempt the analyst to ignore the potential effects of data patch-up on the substantive conclusions. While convenient and straightforward, the thoughtless application of these fixes introduces significant spurious relations over time, especially if the spacing of observations is highly irregular <span class="citation">(Rehfeld et al. 2011)</span>. Binning can lead to “surprisingly large” biases <span class="citation">(Towers 2014)</span>. If timing variation is related to the outcome of interest, these methods may result in biased estimates and exaggerated claims <span class="citation">(Pullenayegum and Lim 2016)</span>.</p>
<p>The linear mixed model for longitudinal data <span class="citation">(Laird and Ware 1982; Fitzmaurice, Laird, and Ware 2011)</span> is the standard for analysing irregular data. The model represents each subject’s observed curve by a parametric function of time. The parameter estimates of this function are specific to each subject and modelled as random effects. The linear mixed model is beneficial for irregular data. It borrows strength across different realisations of the same process, summarising each trajectory by a small number of parameters that vary over subjects. The analyst can break down the distribution of these random effects as a function of individual characteristics. The linear mixed model is attractive when the number of measurements differs between individuals or when the measurements are taken at different times.</p>
<p>This paper explores the use of the <em>broken stick model</em> to transform irregularly observed data into <em>repeated measures</em>. The broken stick model describes a curve by a series of connected straight lines. The model has a long history and is known under many other names, amongst others, <em>segmented straight lines</em> <span class="citation">(Bellman and Roth 1969)</span>, <em>piecewise regression</em> <span class="citation">(Toms and Lesperance 2003)</span>, <em>structural change models</em> <span class="citation">(Bai and Perron 2003)</span>, <em>broken line smoothing</em> <span class="citation">(Koutsoyiannis 2000)</span> and <em>segmented regression</em> <span class="citation">(Lerman 1980)</span>. The term <em>broken stick</em> goes back to at least <span class="citation">MacArthur (1957)</span>, who used it in an analogy to indicate the abundance of species. Most of the literature on the broken stick model concentrates on the problem of finding optimal times at which the lines should connect. Instead, the present paper will focus on the problem of summarising irregular individual trajectories by estimates made at a <em>pre-specified time grid</em>. This time grid is identical for all individuals, but it needs not be equidistant. Our model formulation is a special case of the linear mixed model, with time modelled as a set of random effects coded as a linear <span class="math inline">\(B\)</span>-spline and subjects as the grouping factor. The output of the transformation is a set of repeated measures, where every subject obtains a score on every time point.</p>
<p>Many <strong>R</strong> packages offer tools for interpolation. The <strong>splines</strong> package <span class="citation">( Core Team 2020)</span> and the <strong>akima</strong> package <span class="citation">(Akima et al. 2021)</span> contains classic interpolation methods for one- and two-dimensional smoothing. Most contributed packages concentrate on time series or spatial interpolation. See <span class="citation">Li and Heap (2014)</span> and <span class="citation">Lepot, Aubin, and Clemens (2017)</span> for overviews of the different concepts and methodologies. Most interpolation techniques rely on neighbouring information, in time, space or both. The broken stick model addresses the problem where many independent replications provide short irregular multivariate time series, say of 5-30 time points. The scientific interest is to dynamically predict and update future observations. The model applies the linear mixed model to increase stability for such series by borrowing information across replicates. As there are no satisfactory solutions to this problem, the <strong>brokenstick</strong> package intends to fill this gap.</p>
<p>Substantive researchers often favour repeated measures over the use of linear mixed models because of their simplicity. For example, we can easily fit a subject-level model to predict future outcomes conditional on earlier data with repeated measures data. While such simple regression models may be less efficient than modelling the complete data <span class="citation">(Diggle et al. 2002, sec. 6.1)</span>, increased insight may be more valuable than increased precision.</p>
<p>The broken stick model requires a specification of a sensible set of time points at which the measurements ideally should have been taken. For each subject, the model predicts or imputes hypothetical observations at those times, so the substantive analysis applies to the repeated measures instead of the irregular data. This strategy is akin to Diggle’s multi-stage model-fitting approach <span class="citation">(Diggle 1988)</span>. The envisioned two-step analytic process aims to provide the best of both worlds.</p>
<p>Some applications of the broken stick model are:</p>
<ul>
<li>to approximate individual trajectories by a series of connected straight lines;</li>
<li>to align irregularly observed curves to a joint age grid;</li>
<li>to impute realisations of individual trajectories;</li>
<li>to estimate the time-to-time correlation matrix;</li>
<li>to predict future observations.</li>
</ul>
<p>The original motivation for developing the broken stick model was to facilitate the statistical analysis and testing of critical ages in the onset of childhood obesity <span class="citation">(de Kroon et al. 2010)</span>, with extensions to multiple imputation <span class="citation">(van Buuren 2018b)</span>. There is good support in <strong>R</strong> for fitting child growth data. We mention some related approaches. Methods for estimating growth references with parametric models are <code>gamlss()</code> from <strong>gamlss</strong> <span class="citation">(Stasinopoulos and Rigby 2007)</span> and its Bayesian incarnation <code>bamlss()</code> from <strong>bamlss</strong> <span class="citation">(Umlauf et al. 2021)</span>. Nonparametric alternatives that estimate quantiles directly are <code>rq()</code> from <strong>quantreg</strong> <span class="citation">(Koenker et al. 2018)</span> and <code>expectreg.ls()</code> from <strong>expectreg</strong> <span class="citation">(Otto-Sobotka et al. 2021)</span>. Methods for modelling and smoothing growth curves fit trajectories per child include <code>smooth.basisPar()</code> from <strong>fda</strong> <span class="citation">(Ramsay, Graves, and Hooker 2021)</span>, <code>gam()</code> from <strong>mgcv</strong> <span class="citation">(Wood 2011)</span>, <code><a href="https://rdrr.io/r/stats/loess.html" class="external-link">loess()</a></code> and <code><a href="https://rdrr.io/r/stats/smooth.spline.html" class="external-link">smooth.spline()</a></code> from base <strong>stats</strong> <span class="citation">( Core Team 2020)</span>. Models that smooth by borrowing strength across children are <code>face.sparse()</code> from <strong>face</strong> <span class="citation">(Xiao et al. 2021)</span>, <code>lmer()</code> from <strong>lme4</strong> <span class="citation">(Bates et al. 2015)</span>, and <code>sitar()</code> from <strong>sitar</strong> <span class="citation">(T. Cole 2021)</span>. The broken stick model fits in the latter tradition, and features an intuitive parametrisation of each individual growth curve as a series of connected straight lines. See <span class="citation">Anderson et al. (2019)</span> for an overview and comparison of these methods.</p>
<p>The present paper highlights various computational tools from the <strong>brokenstick</strong> v2.2.0 package. The package contains tools to fit the broken stick model to data, export the fitted model’s parameters, create imputed values of the model, and predict broken stick estimates for new data. Also, the text illustrates how the tool helps to solve various analytic problems.</p>
</div>
<div class="section level2" number="2">
<h2 id="illustration-of-broken-stick-model">
<span class="header-section-number">2</span> Illustration of broken stick model<a class="anchor" aria-label="anchor" href="#illustration-of-broken-stick-model"></a>
</h2>
<p>As a first step, let us study the variation in the age of measurement of 200 children from the SMOCC study <span class="citation">(Herngreen et al. 1994)</span>. <span class="citation">Lokku et al. (2020)</span> suggest the <em>abacus plot</em> to visualise this variation.</p>
<div class="figure">
<span style="display:block;" id="fig:visits"></span>
<img src="manual_files/figure-html/visits-1.png" alt="Abacus plot of observation times for the first 20 children of the SMOCC data. Data collection was done through 10 waves. Each dot represents the age at which an observation was made. The variability in timing between children rises with age." width="100%"><p class="caption">
Figure 1: Abacus plot of observation times for the first 20 children of the SMOCC data. Data collection was done through 10 waves. Each dot represents the age at which an observation was made. The variability in timing between children rises with age.
</p>
</div>
<p>The blue points in Figure <a href="#fig:visits">1</a> indicate the observation times. Generally, the blue points are close to the scheduled ages (indicated by vertical lines), especially in the first half-year. Observation times vary more for older children. Several children have one or more missing visits (e.g., 10002, 10008, 10024). Some children (10012, 10015) had fairly close visits. Child 10028 dropped out after month 9.</p>
<p>Let us fit two models, with two and nine lines, respectively, to body length’s standard deviation score (SDS).</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/brokenstick.html">brokenstick</a></span><span class="op">(</span><span class="va">hgt_z</span> <span class="op">~</span> <span class="va">age</span> <span class="op">|</span> <span class="va">id</span>, <span class="va">smocc_200</span>, seed <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                    knots <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">fit9</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/brokenstick.html">brokenstick</a></span><span class="op">(</span><span class="va">hgt_z</span> <span class="op">~</span> <span class="va">age</span> <span class="op">|</span> <span class="va">id</span>, <span class="va">smocc_200</span>, seed <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                    knots <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">6</span>, <span class="fl">9</span>, <span class="fl">12</span>, <span class="fl">15</span>, <span class="fl">18</span>, <span class="fl">24</span><span class="op">)</span><span class="op">/</span><span class="fl">12</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:plotfit2x"></span>
<img src="manual_files/figure-html/plotfit2x-1.png" alt="Data and fitted curves for three children (blue = observed data, red = fitted curves). The broken stick model with two lines (top) gives a crude approximation of the data. The model with nine lines (bottom) follows the data quite closely." width="100%"><p class="caption">
Figure 2: Data and fitted curves for three children (blue = observed data, red = fitted curves). The broken stick model with two lines (top) gives a crude approximation of the data. The model with nine lines (bottom) follows the data quite closely.
</p>
</div>
<p>Figure <a href="#fig:plotfit2x">2</a> shows the individual trajectories of three children. The blue points coincide with the observed data, whereas the red curves are calculated according to the broken stick model.</p>
<p>There are two fitted models. The simpler model (top) uses just two line segments. The first line starts at birth and ends at the age of exactly 1 year. The second line spans the period between 1 to 2 years. Note that the two lines connect at the breakpoint, the age of 1 year. The red curves for the two-line model are a crude approximation to the data.</p>
<p>We can create a better model by setting breakpoints equal to the scheduled ages. Since there are 10 scheduled ages, we construct nine straight lines. In contrast to the two-line model, the nine-line broken stick model is sensitive to small bumps in the observed trajectory and closely fits the empirical data. The residual variance of the nine-line model is low (0.059), and the proportion of explained variance in SDS is high (0.98).</p>
<p>While the observation times in the data differ between children, the broken stick curves use identical time points across subjects. The idea is now that we can add the broken stick estimates to the child-level data by a long-to-wide conversion and analyse supplemented columns as repeated measures. A repeated measures analysis is usually simpler than the equivalent for the temporally misaligned data. For example, it is easy to calculate mean profiles for arbitrary groups, estimate the time-to-time covariance matrix, or build predictive models at the child level. See <span class="citation">Hand and Taylor (1987)</span> for a lucid overview of linear techniques for repeated measures.</p>
</div>
<div class="section level2" number="3">
<h2 id="methodology">
<span class="header-section-number">3</span> Methodology<a class="anchor" aria-label="anchor" href="#methodology"></a>
</h2>
<div class="section level3" number="3.1">
<h3 id="notation">
<span class="header-section-number">3.1</span> Notation<a class="anchor" aria-label="anchor" href="#notation"></a>
</h3>
<p>We adopt the notation of <span class="citation">Fitzmaurice, Laird, and Ware (2011)</span>. Let <span class="math inline">\(Y_{ij}\)</span> denote the response variable for the <span class="math inline">\(i^{\rm th}\)</span> subject on the <span class="math inline">\(j^{\rm th}\)</span> measurement occasion at time <span class="math inline">\(t_{ij}\)</span>. Data are collected in a sample of <span class="math inline">\(N\)</span> persons <span class="math inline">\(i=1,\dots,N\)</span>. Let repeated measurements for the <span class="math inline">\(i^{\rm th}\)</span> subject be grouped as</p>
<p><span class="math display">\[
Y_i = \left( \begin{array} {l} Y_{i1} \\ Y_{i2} \\ \vdots \\ Y_{in_i} \end{array} \right), \quad i = 1, \dots, N.
\]</span></p>
<p>If the measures have been observed at a common same set of occasions, then we could drop the index <span class="math inline">\(i\)</span> in <span class="math inline">\(t_{ij}\)</span> since <span class="math inline">\(t_{ij} = t_j\)</span> for all <span class="math inline">\(i = 1, \dots, N\)</span>. Here we will focus on the case that <span class="math inline">\(t_{ij}\)</span> varies over <span class="math inline">\(i\)</span>.</p>
<p>In addition, let use define the <span class="math inline">\(n_i \times p\)</span> matrices</p>
<p><span class="math display">\[
X_i = \left( \begin{array} {llll}
X_{i11} &amp; X_{i12} &amp; \cdots &amp; X_{i1p} \\
X_{i21} &amp; X_{i22} &amp; \cdots &amp; X_{i2p} \\
\vdots  &amp; \vdots  &amp; \ddots &amp; \vdots  \\
X_{in_i1} &amp; X_{in_i2} &amp; \cdots &amp; X_{in_ip}
\end{array} \right), \quad i = 1, \dots, N,
\]</span></p>
<p>so that the rows of <span class="math inline">\(X_i\)</span> contain <span class="math inline">\(p\)</span> covariates associated with the responses at <span class="math inline">\(n_i\)</span> measurement occasions. The columns may be time-varying covariates. If a certain covariate is fixed in time (e.g., sex, treatment, education), then all values within the corresponding column in <span class="math inline">\(X_i\)</span> are identical.</p>
</div>
<div class="section level3" number="3.2">
<h3 id="broken-stick-model">
<span class="header-section-number">3.2</span> Broken stick model<a class="anchor" aria-label="anchor" href="#broken-stick-model"></a>
</h3>
<p>The broken stick model avoids modeling observation times <span class="math inline">\(t_{ij}\)</span> directly by representing each <span class="math inline">\(t_{ij}\)</span> as its relative position within a time interval. For example, suppose <span class="math inline">\(t_{ij} = 0.6\)</span> years and that the time interval is given by 0.5-1.0 years. The position relative to the left break age is <span class="math inline">\(x_{\rm left} = (1.0-0.6)/(1.0-0.5) = 0.8\)</span>, whereas relative to the right break age is <span class="math inline">\(x_{\rm right} = (0.6-0.5)/(1.0-0.5) = 0.2\)</span>. In order to fit the broken stick model, we need to replace time point <span class="math inline">\(t_{ij} = 0.6\)</span> by two values: 0.8 (for break age 0.5), and 0.2 (for break age 1.0). Note that both values add up to 1. Coding time in this way simplifies modeling continuous time by a set of discrete break ages.</p>
<p>More specifically, let <span class="math inline">\(t_{ij}\)</span> be coded by a second-order (linear) <span class="math inline">\(B\)</span>-spline using <span class="math inline">\(k\)</span> internal knots <span class="math inline">\(\kappa\)</span> placed at <span class="math inline">\(k+1\)</span> ordered ages</p>
<p><span class="math display">\[
\kappa_0 = \kappa_1 &lt; \dots &lt; \kappa_k &lt; \kappa_{k+1}
\]</span></p>
<p>The internal knots <span class="math inline">\(\kappa_1, \dots, \kappa_k\)</span> correspond to the set of ages for which we obtain broken stick estimates, and it could be specified by the user. The left boundary knot <span class="math inline">\(\kappa_0 = \kappa_1\)</span> is left-anchored to the minimum time <span class="math inline">\(\min(t_{ij})\)</span> in the data. This point defines the starting event of the participant, such as birth or study enrolment. The right hand boundary knot is <span class="math inline">\(\kappa_{k+1} \geq \max(t_{ij})\)</span>.</p>
<p>The second-order <span class="math inline">\(B\)</span>-spline <span class="citation">(de Boor 1978, 32)</span>,</p>
<p><span class="math display">\[
H_s(t) = \left\{ \begin{array} {l@{\quad,\quad}l}
(t-\kappa_{s-1})/(\kappa_s - \kappa_{s-1}) &amp; \kappa_{s-1} &lt; t \leq \kappa_s,\\
(\kappa_{s+1}-t)/(\kappa_{s+1} - \kappa_s) &amp; \kappa_s \leq t &lt; \kappa_{s+1},\\
0 &amp; {\rm otherwise.}
\end{array} \right.
\]</span></p>
<p>is applied to <span class="math inline">\(t_{ij}\)</span> to obtain <span class="math inline">\((k+1)\)</span> transformed variables <span class="math inline">\(x_{is} = t_{ij}\)</span> with <span class="math inline">\(s = 1,\dots,k+1\)</span>. These variables can conveniently be grouped into the <span class="math inline">\(n_i \times (k+1)\)</span> matrix of covariates <span class="math inline">\(X_i = (x_{i1}, \dots, x_{ik}, x_{i(k+1)})\)</span>. Each row in <span class="math inline">\(X_i\)</span> has only one or two non-zero elements, which sum to 1.</p>
<p>Using this <span class="math inline">\(X_i\)</span>, the broken stick model is a special case (with <span class="math inline">\(Z_i = X_i\)</span>) of the two-stage random-effects model <span class="citation">(Laird and Ware 1982)</span></p>
<p><span class="math display">\[
Y_i = X_i\beta + X_ib_i + \epsilon_i
\]</span></p>
<p>where the <span class="math inline">\(k+1\)</span> column vector <span class="math inline">\(\beta\)</span> contains <span class="math inline">\(k+1\)</span> fixed effect coefficients common to all persons, where the <span class="math inline">\(k+1\)</span> column vector <span class="math inline">\(b_i\)</span> accommodates for <span class="math inline">\(k+1\)</span> subject-specific random parameters, and where the <span class="math inline">\(n_i\)</span> column vector <span class="math inline">\(\epsilon_i\)</span> holds subject-specific residuals.</p>
<p>In order to complete the model specification, we assume that the residuals are identically and independently distributed as <span class="math inline">\(\epsilon_i \sim N(0,\sigma^2 I(n_i))\)</span>, where <span class="math inline">\(\sigma^2\)</span> is a common variance parameter, and where <span class="math inline">\(I(n_i)\)</span> is the identity matrix of order <span class="math inline">\(n_i\)</span>. Thus, the equation represents population parameters (fixed effects), individual effects (random effects), and an amount of within-person dispersion that is the same for all persons. Section <a href="#estimation-steps-explained">4.2</a> also considers a heterogeneous model that allows <span class="math inline">\(\sigma_i^2\)</span> to vary over subjects.</p>
<p>In summary, given the knot specification and the choice of the response scale, the parameters of the broken stick model are:</p>
<ul>
<li>
<span class="math inline">\(\beta\)</span>, a vector of <span class="math inline">\(k + 1\)</span> fixed parameters;</li>
<li>
<span class="math inline">\(\Omega\)</span>, a <span class="math inline">\((k+1) \times (k+1)\)</span> covariance matrix of the random effects;</li>
<li>
<span class="math inline">\(\sigma^2\)</span>, the within-person error variance.</li>
</ul>
<p>The total number of parameters for a solution with <span class="math inline">\(k\)</span> internal knots is thus equal to <span class="math inline">\((k^2 + 5k + 6)/2\)</span>. For example, a model of <span class="math inline">\(k = 3\)</span> knots (i.e., with two connected lines) has 15 parameters, a model with <span class="math inline">\(k = 4\)</span> has 21 parameters, and a model with <span class="math inline">\(k = 10\)</span> break ages has 78 parameters. The heterogeneous model has one additional parameter that measures the variation of <span class="math inline">\(\sigma_i^2\)</span>.</p>
</div>
<div class="section level3" number="3.3">
<h3 id="model-assumptions">
<span class="header-section-number">3.3</span> Model assumptions<a class="anchor" aria-label="anchor" href="#model-assumptions"></a>
</h3>
<p>At the person level, we assume <span class="math inline">\(b_i \sim N(0, \Omega)\)</span>, i.e., the random coefficients of the subjects have a multivariate normal distribution with zero mean and a <span class="math inline">\((k+1) \times (k+1)\)</span> covariance matrix <span class="math inline">\(\Omega\)</span>. The base model allows the elements of <span class="math inline">\(\Omega\)</span> to vary freely. For time-dependent data, constrained versions for <span class="math inline">\(\Omega\)</span> are also of interest <span class="citation">(Fitzmaurice, Laird, and Ware 2011, ch. 7)</span>. Section <a href="#estimation-steps-explained">4.2</a> highlights two such extensions. We also assume that the covariance between <span class="math inline">\(b_i\)</span> and <span class="math inline">\(\epsilon_i\)</span> is zero. For simplicity, this paper is restricted to the case where <span class="math inline">\(X_i\)</span> includes only time, and no other covariates.</p>
<p>The broken stick model builds upon three main modeling assumptions:</p>
<ul>
<li>The trajectory between break ages follows a straight line. This assumption may fail for processes that are convex or concave in time. For example, human height growth in centimeters growth is concave in time, so setting breakpoints far apart introduces a systematic negative bias. Modeling height SDS instead of raw height will prevent this bias.</li>
<li>The broken stick estimates follow a joint multivariate normal distribution. As this assumption may fail for skewed measurements, it could be beneficial to transform the outcomes so that their distribution will be closer to normal.</li>
<li>The data are <em>missing at random</em> (MAR) given the outcomes from all subjects at all observation times. This assumption is restrictive in the sense that missingness may only depend on the observed outcomes, and not on covariates other than time. At the same time, the assumption is liberal in the sense that the missingness may depend on future outcomes. While this MAR-future assumption is unusual in the literature on drop-out and observation time models, it is a sensible strategy for creating imputations that preserve relations over time, especially for intermittent missing data. Of course, the subsequent substantive analysis on the imputed data needs to be aware of the causal direction of time.</li>
</ul>
</div>
<div class="section level3" number="3.4">
<h3 id="interpretation">
<span class="header-section-number">3.4</span> Interpretation<a class="anchor" aria-label="anchor" href="#interpretation"></a>
</h3>
<p>Given the model estimates and the person data, we can calculate the random effect <span class="math inline">\(b_i\)</span>. The <em>broken stick parameter</em> <span class="math inline">\(\gamma_{is} = \beta_s + b_{is}\)</span> is the subject-specific mean of <span class="math inline">\(Y_i\)</span> at time <span class="math inline">\(\kappa_s\)</span>, <span class="math inline">\(s = 1,\dots, k + 1\)</span>. The set of <span class="math inline">\(\gamma_{is}\)</span> parameters describes the mean response profile for subject <span class="math inline">\(i\)</span> by <span class="math inline">\(k\)</span> lines that connect at the <span class="math inline">\(k + 1\)</span> coordinates <span class="math inline">\((\kappa_s, \gamma_{is})\)</span>.</p>
<p>The broken stick parameter is the most likely value of outcome <span class="math inline">\(Y_i\)</span> for subject <span class="math inline">\(i\)</span> at time <span class="math inline">\(\kappa_s\)</span>. The parameter is the centre of the posterior predictive distribution for normal <span class="math inline">\(Y_i\)</span>. The two-sided <span class="math inline">\(100(1-\alpha)\%\)</span> prediction interval for the true, though often unobserved, value <span class="math inline">\(Y_{i,\kappa_s}\)</span> is equal to</p>
<p><span class="math display">\[
[Y_{i,\kappa_s}^{\rm lo}, Y_{i,\kappa_s}^{\rm hi}] = \gamma_{is} \pm t_{(1-\alpha/2;N-1)}\sigma,
\]</span>
where <span class="math inline">\(t_{(1-\alpha/2;N-1)}\)</span> is the <span class="math inline">\(100(1-\alpha/2)\)</span> percentile of Student’s <span class="math inline">\(t\)</span>-distribution with <span class="math inline">\(N - 1\)</span> degrees of freedom. For example, the 50% prediction interval <span class="math inline">\(\gamma_{is} \pm 0.68\sigma\)</span> will contain 50% of true values. For normal <span class="math inline">\(Y_i\)</span>, the length of the 50% prediction interval is equivalent to the interquartile range (IQR). If the residual variation <span class="math inline">\(\sigma^2\)</span> is small (say <span class="math inline">\(\sigma^2 &lt; 0.1\)</span>), the IQR is about 0.22, so half of the true values will be within 0.22 SD of <span class="math inline">\(\gamma_{is}\)</span>, a small difference. For large <span class="math inline">\(\sigma^2\)</span> (e.g., <span class="math inline">\(\sigma^2 &gt; 0.2\)</span>), the <span class="math inline">\(\gamma_{i}\)</span> vector is a smoothed representation of <span class="math inline">\(Y_{i}\)</span>. While smoothness amplifies low-frequency features of the trajectories, it could also introduce biases in the subsequent analysis by suppressing high-frequency variation. In that case, the analyst needs to check whether this reduction in variation does not affect the parameters of substantive interest. We may restore high-frequency variation by adding random draws from the residual distribution <span class="math inline">\(N(0, \sigma^2)\)</span>. From there, it is a small step to multiple imputation, a well-developed methodology for drawing valid inferences from incomplete data <span class="citation">(Rubin 1987; van Buuren 2018b)</span>.</p>
<p>If <span class="math inline">\(n_i &gt;&gt; k\)</span> then the broken stick model provides a parsimonious representation of the measurements. Reversely, if <span class="math inline">\(n_i &lt;&lt; k\)</span> then the model infers plausible values for subject <span class="math inline">\(i\)</span> by building strength across persons. The broken stick model converts <span class="math inline">\(n_i\)</span> irregularly observed measurements into a new set of <span class="math inline">\(k\)</span> values <span class="math inline">\(\gamma_{is}\)</span> at common ages <span class="math inline">\(\kappa_1, ..., \kappa_k\)</span>, <span class="math inline">\(s = 1,\dots, k\)</span>.</p>
<p>Since each row in <span class="math inline">\(X_i\)</span> sums to unity, the broken stick model does not have a global intercept. The linear <span class="math inline">\(B\)</span>-spline coding effectively replaces the global random intercept term by <span class="math inline">\(k + 1\)</span> <em>local intercepts</em>, one at each break age. The local intercept summarizes the information available in the adjacent left and right age intervals and ignores any information beyond the two adjacent knots. The broken stick estimates are thus primarily local. Outcome data observed outside the two adjacent age intervals influence the broken stick estimates only through the subject-level part of the model, in particular through <span class="math inline">\(\Omega\)</span>.</p>
</div>
</div>
<div class="section level2" number="4">
<h2 id="estimation">
<span class="header-section-number">4</span> Estimation<a class="anchor" aria-label="anchor" href="#estimation"></a>
</h2>
<div class="section level3" number="4.1">
<h3 id="main-function">
<span class="header-section-number">4.1</span> Main function<a class="anchor" aria-label="anchor" href="#main-function"></a>
</h3>
<p>The <code><a href="../../reference/brokenstick.html">brokenstick()</a></code> function estimates the parameters of the broken stick model. The user needs to specify the outcome, the predictor and the grouping variable, as well as the location of the knots on the predictor variable. A call produces an object of class <code>brokenstick</code>:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/brokenstick.html">brokenstick</a></span><span class="op">(</span><span class="va">hgt_z</span> <span class="op">~</span> <span class="va">age</span> <span class="op">|</span> <span class="va">id</span>, data <span class="op">=</span> <span class="va">smocc_200</span>,</span>
<span>                   knots <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>, seed <span class="op">=</span> <span class="fl">12321</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Class        brokenstick (kr)</span></span>
<span><span class="co">## Variables    hgt_z (outcome), age (predictor), id (group)</span></span>
<span><span class="co">## Data         1942 (n), 36 (nmis), 200 (groups)</span></span>
<span><span class="co">## Parameters   22 (total), 5 (fixed), 5 (variance), 10 (covariance), 2 (error)</span></span>
<span><span class="co">## Knots        0 0.5 1 2 2.68 </span></span>
<span><span class="co">## Means        -0.094 0.093 -0.014 0.084 0.268 </span></span>
<span><span class="co">## Residuals    0.106 0.129 0.146 0.169 0.361 (min, P25, P50, P75, max)</span></span>
<span><span class="co">## Mean resid   0.156 </span></span>
<span><span class="co">## R-squared    0.893 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Variance-covariance matrix</span></span>
<span><span class="co">##            age_0 age_0.5 age_1 age_2 age_2.6776</span></span>
<span><span class="co">## age_0      1.409                               </span></span>
<span><span class="co">## age_0.5    0.718   0.905                       </span></span>
<span><span class="co">## age_1      0.521   0.755 0.765                 </span></span>
<span><span class="co">## age_2      0.395   0.721 0.783 0.941           </span></span>
<span><span class="co">## age_2.6776  0.44   0.017 0.172 0.018       3.42</span></span></code></pre>
<p>The object contains the model setting, the data and the results. The column names of <span class="math inline">\(X\)</span> consist of the name of the time variable with the knot values appended. Thus, <code>age_0</code> is birth length and <code>age_1</code> is the length at the age of 1y. Here we find estimates of the fixed effects <span class="math inline">\(\beta\)</span> under <code>means</code>, the residual variance <span class="math inline">\(\sigma^2\)</span> under <code>mean resid</code> and the variance-covariance matrix of the random effects <span class="math inline">\(\Omega\)</span> as <code>get_omega(fit)</code>. We calculate the broken stick estimates at the knot locations as a wide matrix through the <code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code> function as follows:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bse</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit</span>, x <span class="op">=</span> <span class="st">"knots"</span>, shape <span class="op">=</span> <span class="st">"wide"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">bse</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 200   6</span></span></code></pre>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">bse</span>, <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 3 × 6</span></span></span>
<span><span class="co">##      id    `0`  `0.5`     `1`     `2` `2.6776`</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> <span style="text-decoration: underline;">10</span>001  0.789  0.247  0.025<span style="text-decoration: underline;">6</span>  0.034<span style="text-decoration: underline;">1</span>    0.656</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span> <span style="text-decoration: underline;">10</span>002 -<span style="color: #BB0000;">0.267</span> -<span style="color: #BB0000;">0.228</span> -<span style="color: #BB0000;">0.421</span>  -<span style="color: #BB0000;">0.514</span>     0.314</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">3</span> <span style="text-decoration: underline;">10</span>003  1.67   2.00   1.28    1.10      0.162</span></span></code></pre>
<p>The specification <code>x = "knots"</code> uses the special keyword <code>"knots"</code> to set the predictor values equal to the knot locations used to fit the model. The argument <code>shape = "wide"</code> returns the predicted values as a wide matrix (one row per group, one column per predictor value). As a result we now have each individual trajectory summarised by six estimates.</p>
</div>
<div class="section level3" number="4.2">
<h3 id="estimation-steps-explained">
<span class="header-section-number">4.2</span> Estimation steps explained<a class="anchor" aria-label="anchor" href="#estimation-steps-explained"></a>
</h3>
<p>We may break up the estimation process into two main steps. The first step calculates the matrix of <span class="math inline">\(B\)</span>-splines for the time variable <code>age</code> by the core <code><a href="https://rdrr.io/r/splines/bs.html" class="external-link">splines::bs()</a></code> <span class="citation">( Core Team 2020)</span> function:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st">"splines"</span><span class="op">)</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">brokenstick</span><span class="fu">::</span><span class="va"><a href="../../reference/smocc_200.html">smocc_200</a></span></span>
<span><span class="va">internal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/splines/bs.html" class="external-link">bs</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">age</span>, knots <span class="op">=</span> <span class="va">internal</span>, Boundary.knots <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2.68</span><span class="op">)</span>,</span>
<span>        degree <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"age"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">internal</span>, <span class="fl">2.68</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"id"</span>, <span class="st">"age"</span>, <span class="st">"hgt_z"</span><span class="op">)</span><span class="op">]</span>, <span class="va">X</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##      id    age  hgt_z age_0 age_0.5  age_1 age_2 age_2.68</span></span>
<span><span class="co">## 1 10001 0.0000  0.575 1.000   0.000 0.0000     0        0</span></span>
<span><span class="co">## 2 10001 0.0821  0.888 0.836   0.164 0.0000     0        0</span></span>
<span><span class="co">## 3 10001 0.1588  0.797 0.682   0.318 0.0000     0        0</span></span>
<span><span class="co">## 4 10001 0.2546  0.661 0.491   0.509 0.0000     0        0</span></span>
<span><span class="co">## 5 10001 0.5038  0.290 0.000   0.992 0.0076     0        0</span></span>
<span><span class="co">## 6 10001 0.7529 -0.398 0.000   0.494 0.5058     0        0</span></span></code></pre>
<p>The numerical example shows that the <code><a href="https://rdrr.io/r/splines/bs.html" class="external-link">bs()</a></code> function transforms the <code>age</code> variable into five columns, the <span class="math inline">\(B\)</span>-spline basis, with names like <code>age_0</code> and <code>age_0.5</code>. If <code>age</code> coincides with one of these (e.g., as in the top row), then the corresponding column receives a <code>1</code>. In all other cases, age distributes over two adjacent columns. To make things fit, we need an additional column (here <code>age_2.68</code>) at the last position, the right boundary knot. There is also a left boundary knot, and I have conveniently set that equal to the first breakpoint, marking the start of time. Setting <code>degree = 1</code> specifies a <span class="math inline">\(B\)</span>-spline gives the broken stick model its name and its characteristic shape.</p>
<p>The second step is to specify the model and estimate its parameters. We have two methods for this: <code>"kr"</code> and <code>"lmer"</code>. Method <code>"lmer"</code> relies on the popular function <code><a href="https://rdrr.io/pkg/lme4/man/lmer.html" class="external-link">lme4::lmer()</a></code> <span class="citation">(Bates et al. 2015)</span> to fit a linear mixed normal model.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ctl_lmer</span> <span class="op">&lt;-</span> <span class="fu">lme4</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmerControl.html" class="external-link">lmerControl</a></span><span class="op">(</span></span>
<span>  check.conv.grad <span class="op">=</span> <span class="fu">lme4</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmerControl.html" class="external-link">.makeCC</a></span><span class="op">(</span><span class="st">"warning"</span>, tol <span class="op">=</span> <span class="fl">0.04</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">f</span> <span class="op">&lt;-</span> <span class="va">hgt_z</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">age_0</span> <span class="op">+</span> <span class="va">age_0.5</span> <span class="op">+</span> <span class="va">age_1</span> <span class="op">+</span> <span class="va">age_2</span> <span class="op">+</span> <span class="va">age_2.68</span> <span class="op">+</span></span>
<span>  <span class="op">(</span><span class="fl">0</span> <span class="op">+</span> <span class="va">age_0</span> <span class="op">+</span> <span class="va">age_0.5</span> <span class="op">+</span> <span class="va">age_1</span> <span class="op">+</span> <span class="va">age_2</span> <span class="op">+</span> <span class="va">age_2.68</span> <span class="op">|</span> <span class="va">id</span><span class="op">)</span></span>
<span><span class="va">mod_lmer</span> <span class="op">&lt;-</span> <span class="fu">lme4</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmer.html" class="external-link">lmer</a></span><span class="op">(</span><span class="va">f</span>, <span class="va">data</span>, control <span class="op">=</span> <span class="va">ctl_lmer</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">mod_lmer</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "lmerMod"</span></span>
<span><span class="co">## attr(,"package")</span></span>
<span><span class="co">## [1] "lme4"</span></span></code></pre>
<p>The formula removes the intercept and specifies each knot as a random effect with child <code>id</code> as grouping factor. The <code>control</code> argument suppresses the warning <code>Model failed to converge with max|grad| = 0.0360913</code>. Such warnings occur often if the model has many random effects. These warnings may also be thrown if some of the child data are outliers (for example pre-terms). I found that the broken estimates generally look sound and reasonable despite the warnings. Note however that my experience derives primarily from child growth data, so there is no guarantee that this apparent robustness will hold for other types of data. Warnings from <code>lmer()</code> become more frequent with a higher number of knots, for smaller samples and for data with observations made at more irregular time points.</p>
<p>Object <code>mod_lmer</code> has class <code>lmerMod</code> so we may use standard <code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code>, <code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code> and <code>summary</code> methods offered by the <strong>lme4</strong> package. Converting the result into broken stick estimates requires summing the fixed and random effects.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bse_lmer</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu">lme4</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/nlme/man/random.effects.html" class="external-link">ranef</a></span><span class="op">(</span><span class="va">mod_lmer</span><span class="op">)</span><span class="op">$</span><span class="va">id</span><span class="op">)</span> <span class="op">+</span> <span class="fu">lme4</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/nlme/man/fixed.effects.html" class="external-link">fixef</a></span><span class="op">(</span><span class="va">mod_lmer</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">bse_lmer</span>, <span class="fl">3</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##        age_0 age_0.5 age_1  age_2 age_2.68</span></span>
<span><span class="co">## 10001  0.778   0.272 -0.01  0.076    0.095</span></span>
<span><span class="co">## 10002 -0.278  -0.206 -0.46 -0.477   -0.223</span></span>
<span><span class="co">## 10003  1.681   1.969  1.28  1.115   -0.256</span></span></code></pre>
<p>The calculation time of <code><a href="https://rdrr.io/pkg/lme4/man/lmer.html" class="external-link">lme4::lmer()</a></code> rapidly increases with the number of random effects. More than ten random effects (knots) takes significant time, and beyond 15 knots is generally impossible to fit. For example, using a dataset with 33,000 records and 2,600 individuals, an Apple M1 Max takes 8 seconds (5 knots), 107 seconds (9 knots), 403 seconds (12 knots) and 1172 seconds (15 knots).</p>
<p>The <strong>brokenstick</strong> package provides another alternative, the <em>Kasim-Raudenbush (KR) sampler</em> <span class="citation">(Kasim and Raudenbush 1998)</span>. The method simulates draws from the posterior distributions of parameters from a two-level normal model with heterogeneous within-subject variances. The speed of the Kasim-Raudenbush sampler is almost insensitive to the number of random effects and depends primarily on the total number of iterations and somewhat on sample size. Execution of the KR method for the same problem takes 15 seconds (5 knots), 17 seconds (9 knots), 19 seconds (12 knots) and 20 seconds (15 knots). The method is available as the function <code><a href="../../reference/kr.html">kr()</a></code> in the <strong>brokenstick</strong> package and is the default since version 2.0.0. The <code><a href="../../reference/control_kr.html">control_kr()</a></code> function tweaks estimation options:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ctl_kr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/control_kr.html">control_kr</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">mod_kr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/kr.html">kr</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">hgt_z</span>, x <span class="op">=</span> <span class="va">X</span>, g <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">id</span>, control <span class="op">=</span> <span class="va">ctl_kr</span><span class="op">)</span></span></code></pre></div>
<p>The call to <code><a href="../../reference/control_kr.html">control_kr()</a></code> produces a list with settings for the sampler according to the conventions of the <strong>coda</strong> package <span class="citation">(Plummer et al. 2006)</span>. The defaults in <code><a href="../../reference/control_kr.html">control_kr()</a></code> should be reasonable across a wide range of cases. The list component <code>mod_kr$mod</code> contains various objects of class <code>mcmc</code> with the sampling history and detailed results. For example, inspect the fixed effect estimates as</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st">"coda"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mod_kr</span><span class="op">$</span><span class="va">mod</span><span class="op">$</span><span class="va">beta</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Iterations = 101:300</span></span>
<span><span class="co">## Thinning interval = 1 </span></span>
<span><span class="co">## Number of chains = 1 </span></span>
<span><span class="co">## Sample size per chain = 200 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## 1. Empirical mean and standard deviation for each variable,</span></span>
<span><span class="co">##    plus standard error of the mean:</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##             Mean     SD Naive SE Time-series SE</span></span>
<span><span class="co">## age_0    -0.0966 0.0875  0.00619        0.01001</span></span>
<span><span class="co">## age_0.5   0.0897 0.0625  0.00442        0.00442</span></span>
<span><span class="co">## age_1    -0.0196 0.0626  0.00443        0.00526</span></span>
<span><span class="co">## age_2     0.0768 0.0749  0.00530        0.00715</span></span>
<span><span class="co">## age_2.68  0.2087 0.4594  0.03249        0.15269</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## 2. Quantiles for each variable:</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##             2.5%     25%     50%     75%  97.5%</span></span>
<span><span class="co">## age_0    -0.2623 -0.1582 -0.0897 -0.0354 0.0600</span></span>
<span><span class="co">## age_0.5  -0.0188  0.0454  0.0943  0.1320 0.2139</span></span>
<span><span class="co">## age_1    -0.1502 -0.0633 -0.0183  0.0223 0.0922</span></span>
<span><span class="co">## age_2    -0.0623  0.0257  0.0806  0.1263 0.2168</span></span>
<span><span class="co">## age_2.68 -0.6762 -0.0168  0.1983  0.4737 1.2039</span></span></code></pre>
<p>Also, we may obtain trace plots and densities. For example try <code>plot(mod_kr$mod$beta)</code>.</p>
<p>We obtain results for method <code>"lmer"</code> as</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_lmer</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/brokenstick.html">brokenstick</a></span><span class="op">(</span><span class="va">hgt_z</span> <span class="op">~</span> <span class="va">age</span> <span class="op">|</span> <span class="va">id</span>, data <span class="op">=</span> <span class="va">smocc_200</span>,</span>
<span>                        knots <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>                        method <span class="op">=</span> <span class="st">"lmer"</span>, control <span class="op">=</span> <span class="va">ctl_lmer</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit_lmer</span>, x <span class="op">=</span> <span class="st">"knots"</span>, shape <span class="op">=</span> <span class="st">"wide"</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 3 × 6</span></span></span>
<span><span class="co">##      id    `0`  `0.5`     `1`     `2` `2.6776`</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> <span style="text-decoration: underline;">10</span>001  0.778  0.272 -<span style="color: #BB0000;">0.010</span><span style="color: #BB0000; text-decoration: underline;">1</span>  0.076<span style="text-decoration: underline;">3</span>   0.093<span style="text-decoration: underline;">9</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span> <span style="text-decoration: underline;">10</span>002 -<span style="color: #BB0000;">0.278</span> -<span style="color: #BB0000;">0.206</span> -<span style="color: #BB0000;">0.460</span>  -<span style="color: #BB0000;">0.477</span>   -<span style="color: #BB0000;">0.222</span> </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">3</span> <span style="text-decoration: underline;">10</span>003  1.68   1.97   1.28    1.12    -<span style="color: #BB0000;">0.249</span></span></span></code></pre>
<p>The argument <code>shape = "wide"</code> specifies the form of the return value. The broken stick estimates from the <code>kr</code> and <code>lmer</code> methods are similar, but not identical. In fact, substantial discrepancies may occur in areas where data are sparse, for example, at the right boundary knot. Apart from being faster for more complex models, the KR-sampler opens up interesting analytic options:</p>
<ol style="list-style-type: decimal">
<li><p>It is relatively easy to constrain the fitted covariance of random effects, <span class="math inline">\(\Omega\)</span>, to a matrix of simple structure. Informing the sampler of the time-dependent structure of the random effect leads to stabler estimates of <span class="math inline">\(\Omega\)</span>. The package currently implements two <em>correlations models</em>. These models express the correlation <span class="math inline">\(\rho(t_1, t_2)\)</span> between two Z -scores <span class="math inline">\(Z_1\)</span> and <span class="math inline">\(Z_2\)</span> at successive ages <span class="math inline">\(t_1\)</span> and <span class="math inline">\(t_2\)</span> as a function of those ages. The <em>Argyle model</em> <span class="citation">(Argyle, Seheult, and Wooff 2008)</span> is <span class="math inline">\(\rho(t_1, t_2) = \exp(-\lambda|T_1-T_2|)\)</span>, where <span class="math inline">\(T_i = \log(\tau+t_i)\)</span> is a logarithmic rescaling of the time axis and <span class="math inline">\(\rho=exp(-\lambda)\)</span>. The Cole correlation model <span class="citation">(T. J. Cole 1995)</span> describes the Fisher-transformed correlation as a function of the average <span class="math inline">\((t_1+t_2)/2\)</span> and the difference <span class="math inline">\((t_2-t_1)\)</span>, including two multiplicative terms. Note that both models were proposed in the context of child growth, so may fit less well for other types of time-dependent data.</p></li>
<li><p>The Kasim-Raudenbush sampler fits the slightly more general linear-mixed model with heterogeneous within-subject variances, i.e., with a residual variance <span class="math inline">\(\sigma_i^2\)</span> per subject <span class="math inline">\(i\)</span> instead of the global residual <span class="math inline">\(\sigma^2\)</span>. This makes it easier to identify, study and weight subjects based on how well they fit the model.</p></li>
<li><p>A third option is to simulate imputations as an extra step to the sampler. For subject with large <span class="math inline">\(\sigma_i^2\)</span>, the random effect estimates are a too smooth representation of the data, leading to inappropriate variance estimates when those estimates are analysed as “just data”. Section 11.3 of <span class="citation">van Buuren (2018b)</span> pioneered a solution that constructs multiple trajectories by adding a proper amount of residual noise to random effect estimates. The variance estimation then proceeds according to the principles of multiple imputation <span class="citation">(Rubin 1987)</span>.</p></li>
</ol>
</div>
</div>
<div class="section level2" number="5">
<h2 id="functionality">
<span class="header-section-number">5</span> Functionality<a class="anchor" aria-label="anchor" href="#functionality"></a>
</h2>
<div class="section level3" number="5.1">
<h3 id="overview">
<span class="header-section-number">5.1</span> Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h3>
<p>The <strong>brokenstick</strong> package contains functions to fit, predict and plot data. The main functions in the <code>brokenstick</code> package are:</p>
<table class="table">
<thead><tr class="header">
<th>Function name</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code><a href="../../reference/brokenstick.html">brokenstick()</a></code></td>
<td>Fit a broken stick model to irregular data</td>
</tr>
<tr class="even">
<td><code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code></td>
<td>Predict broken stick estimates</td>
</tr>
<tr class="odd">
<td><code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code></td>
<td>Plot individual trajectories</td>
</tr>
</tbody>
</table>
<p>The following functions are user-oriented helpers:</p>
<table class="table">
<thead><tr class="header">
<th>Function name</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef()</a></code></td>
<td>Extract coefficients</td>
</tr>
<tr class="even">
<td><code><a href="https://rdrr.io/r/stats/fitted.values.html" class="external-link">fitted()</a></code></td>
<td>Calculate fitted values</td>
</tr>
<tr class="odd">
<td><code><a href="../../reference/get_knots.html">get_knots()</a></code></td>
<td>Obtain the knots used by model</td>
</tr>
<tr class="even">
<td><code><a href="../../reference/get_omega.html">get_omega()</a></code></td>
<td>Extract the variance-covariance matrix</td>
</tr>
<tr class="odd">
<td><code><a href="../../reference/get_r2.html">get_r2()</a></code></td>
<td>Obtain proportion of explained variance</td>
</tr>
<tr class="even">
<td><code><a href="https://rdrr.io/r/stats/model.frame.html" class="external-link">model.frame()</a></code></td>
<td>Extract training data</td>
</tr>
<tr class="odd">
<td><code><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix()</a></code></td>
<td>Extract design matrix</td>
</tr>
<tr class="even">
<td><code><a href="https://rdrr.io/r/base/print.html" class="external-link">print()</a></code></td>
<td>Print object</td>
</tr>
<tr class="odd">
<td><code><a href="https://rdrr.io/r/stats/residuals.html" class="external-link">residuals()</a></code></td>
<td>Extract residuals from model</td>
</tr>
<tr class="even">
<td><code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code></td>
<td>Summarise object</td>
</tr>
</tbody>
</table>
<p>The following functions implement the calculations:</p>
<table class="table">
<colgroup>
<col width="22%">
<col width="77%">
</colgroup>
<thead><tr class="header">
<th>Function name</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code><a href="../../reference/set_control.html">set_control()</a></code></td>
<td>Generic control function</td>
</tr>
<tr class="even">
<td><code><a href="../../reference/control_kr.html">control_kr()</a></code></td>
<td>Set controls for Kasim-Raudenbush sampler</td>
</tr>
<tr class="odd">
<td><code><a href="../../reference/kr.html">kr()</a></code></td>
<td>Kasim-Raudenbush sampler for two-level model</td>
</tr>
<tr class="even">
<td><code><a href="../../reference/EB.html">EB()</a></code></td>
<td>Empirical Bayes predictor for random effects (internal)</td>
</tr>
<tr class="odd">
<td><code><a href="../../reference/make_basis.html">make_basis()</a></code></td>
<td>Create linear splines basis (internal)</td>
</tr>
</tbody>
</table>
<p>The package exports S3 methods for the class <code>brokenstick</code> for the following generic functions <code><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef()</a></code>, <code><a href="https://rdrr.io/r/stats/fitted.values.html" class="external-link">fitted()</a></code>, <code><a href="https://rdrr.io/r/stats/model.frame.html" class="external-link">model.frame()</a></code>, <code><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix()</a></code>, <code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code>, <code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code>, <code><a href="https://rdrr.io/r/base/print.html" class="external-link">print()</a></code>, <code><a href="https://rdrr.io/r/stats/residuals.html" class="external-link">residuals()</a></code> and <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code>. An object of class <code>brokenstick</code> stores the training data by default. When this is not desired, specify <code>brokenstick(..., light = TRUE)</code> to create a small object with just the parameter estimates. Of course, we cannot extract the original data from a light object. However, we can still use it to calculate brokenstick estimates for new cases using <code>predict(object, newdata = ...)</code>.</p>
</div>
<div class="section level3" number="5.2">
<h3 id="data-preparation">
<span class="header-section-number">5.2</span> Data preparation<a class="anchor" aria-label="anchor" href="#data-preparation"></a>
</h3>
<p>Before we can fit the model, the data need to be in shape. The <code><a href="../../reference/brokenstick.html">brokenstick()</a></code> function takes tidy data in the long-form. Every row in the data corresponds to one visit. Two columns identify a visit: a subject variable and a time variable. Thus, if subject one has three visits and subject two has five visits, the combined data will have of eight records. This section uses the built-in <code>smocc_200</code> data, containing the heights of 200 children measured at ten visits up to two years <span class="citation">(Herngreen et al. 1994)</span>.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/growthcharts/brokenstick" class="external-link">"brokenstick"</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">smocc_200</span>, <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 3 × 7</span></span></span>
<span><span class="co">##      id    age sex       ga    bw   hgt hgt_z</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> <span style="text-decoration: underline;">10</span>001 0      female    40  <span style="text-decoration: underline;">3</span>960  52   0.575</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span> <span style="text-decoration: underline;">10</span>001 0.082<span style="text-decoration: underline;">1</span> female    40  <span style="text-decoration: underline;">3</span>960  55.6 0.888</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">3</span> <span style="text-decoration: underline;">10</span>001 0.159  female    40  <span style="text-decoration: underline;">3</span>960  58.2 0.797</span></span></code></pre>
<p>The subject variable is <code>id</code> and the time variable is <code>age</code>.</p>
</div>
<div class="section level3" number="5.3">
<h3 id="transformation-to-standard-deviation-scores-sds">
<span class="header-section-number">5.3</span> Transformation to Standard Deviation Scores (SDS)<a class="anchor" aria-label="anchor" href="#transformation-to-standard-deviation-scores-sds"></a>
</h3>
<p>The broken stick model can fit observations in either the raw scale <span class="math inline">\(Y\)</span> (cm, kg, and so on) or as a <span class="math inline">\(Z\)</span>-score. Under a normal distribution with mean <span class="math inline">\(\mu\)</span> and standard deviation <span class="math inline">\(\sigma\)</span> the <span class="math inline">\(Z\)</span>-score for a data value <span class="math inline">\(Y\)</span> is defined as <span class="math inline">\(Z = (Y - \mu)/\sigma\)</span>. In statistics, it is customary to estimate <span class="math inline">\(\mu\)</span> and <span class="math inline">\(\sigma\)</span> from the data, but we can also take those values from an external <em>reference table</em>. For example, heights of boys with an age <span class="math inline">\(t\)</span> follow an approximate normal distribution with an age-specific mean <span class="math inline">\(\mu_t\)</span> and an age-specific standard deviation <span class="math inline">\(\sigma_t\)</span>. A reference table consists of estimates of <span class="math inline">\(\mu_t\)</span> and <span class="math inline">\(\sigma_t\)</span> at different ages <span class="math inline">\(t\)</span>. We calculate the <em>standard deviation score</em> (SDS) for a boy with height <span class="math inline">\(Y\)</span> at age <span class="math inline">\(t\)</span> as <span class="math inline">\(Z = (Y - \mu_t)/\sigma_t\)</span>, with <span class="math inline">\(\mu_t\)</span> and <span class="math inline">\(\sigma_t\)</span> taken from the reference table. We can compare this <span class="math inline">\(Z\)</span>-score directly to the reference population, or compare two measurements taken at different ages with the age effect removed. SDS calculation is standard methodology in child growth, and is available under many distributions. See <span class="citation">Stasinopoulos and Rigby (2007)</span> for details.</p>
<p>Analysis of <span class="math inline">\(Z\)</span>-scores is preferable to the raw scale for several reasons:</p>
<ol style="list-style-type: decimal">
<li>A growth curve that follows a centile in the reference distribution translates into a horizontal line in the <span class="math inline">\(Z\)</span>-score scale, which simplifies modeling;</li>
<li>Observations in the <span class="math inline">\(Z\)</span>-score scale are closer to multivariate normality;</li>
<li>Analysis of <span class="math inline">\(Z\)</span>-scores removes the overpowering impact of age and sex on growth, so it becomes easier to highlight interesting variation within and between children;</li>
<li>Fitting <span class="math inline">\(Z\)</span>-score data leads to fewer convergence issues.</li>
</ol>
<p>In the area of child growth, it is easy to convert raw measurements into the <span class="math inline">\(Z\)</span>-score scale, fit the model, and convert back to the raw scale afterwards, if desired. There are several <strong>R</strong> packages that assist in the calculations: <strong>AGD</strong> <span class="citation">(van Buuren 2018a)</span>, <strong>anthro</strong> <span class="citation">(Schumacher, Borghi, and Polonsky 2020)</span>, <strong>childsds</strong> <span class="citation">(Vogel 2020)</span>, <strong>growthstandards</strong> <span class="citation">(Hafen 2021)</span>, <strong>nlreferences</strong> <span class="citation">(van Buuren 2021b)</span> and <strong>zscorer</strong> <span class="citation">(Myatt and Guevarra 2019)</span>.</p>
<p>The <code>smocc_200</code> data contains the height measurement both in the original scale in cm (<code>hgt</code>) and the <span class="math inline">\(Z\)</span>-score scale (<code>hgt_z</code>) relative to the height references from the Fourth Dutch Growth study <span class="citation">(Fredriks et al. 2000)</span>. For illustration, let us calculate and check height SDS using the <strong>AGD</strong> package.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/stefvanbuuren/AGD" class="external-link">"AGD"</a></span><span class="op">)</span></span>
<span><span class="va">z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">smocc_200</span>, <span class="fu"><a href="https://rdrr.io/pkg/AGD/man/y2z.html" class="external-link">y2z</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">hgt</span>,</span>
<span>                         x <span class="op">=</span> <span class="va">age</span>,</span>
<span>                         sex <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">sex</span> <span class="op">==</span> <span class="st">"male"</span>, <span class="st">"M"</span>, <span class="st">"F"</span><span class="op">)</span>,</span>
<span>                         ref <span class="op">=</span> <span class="va">nl4.hgt</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">z</span>, <span class="va">smocc_200</span><span class="op">$</span><span class="va">hgt_z</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] TRUE</span></span></code></pre>
<div class="figure">
<span style="display:block;" id="fig:zscores"></span>
<img src="manual_files/figure-html/zscores-1.png" alt="Distribution of height SDS for 200 SMOCC children aged 0-2 years relative to the Dutch 1997 length references. The distribution closely follows the normal distribution. A few outliers in the left tail are genuine observations from children born pre-term." width="100%"><p class="caption">
Figure 3: Distribution of height SDS for 200 SMOCC children aged 0-2 years relative to the Dutch 1997 length references. The distribution closely follows the normal distribution. A few outliers in the left tail are genuine observations from children born pre-term.
</p>
</div>
<p>Figure <a href="#fig:zscores">3</a> shows that, as expected, the empirical Z-score distribution is close to the standard normal. The few very extremely low heights correspond to pre-term born infants. Section <a href="#model-fitting">5.4</a> concentrates on modelling <code>hgt_z</code>. Function <code><a href="https://rdrr.io/pkg/AGD/man/z2y.html" class="external-link">z2y()</a></code> applies the inverse transformation of <span class="math inline">\(Z\)</span>-scores to the original scale. The following snippet converts <code>hgt_z</code> into the cm scale.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">smocc_200</span>, <span class="fu">AGD</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/AGD/man/z2y.html" class="external-link">z2y</a></span><span class="op">(</span>z <span class="op">=</span> <span class="va">hgt_z</span>,</span>
<span>                              x <span class="op">=</span> <span class="va">age</span>,</span>
<span>                              sex <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">sex</span> <span class="op">==</span> <span class="st">"male"</span>, <span class="st">"M"</span>, <span class="st">"F"</span><span class="op">)</span>,</span>
<span>                              ref <span class="op">=</span> <span class="va">nl4.hgt</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">smocc_200</span><span class="op">$</span><span class="va">hgt</span>, tol <span class="op">=</span> <span class="fl">0.0001</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] TRUE</span></span></code></pre>
<p>We have used the Dutch 1997 height references here, but similar transforms could be made using other references. Many age- and sex-conditional references exist in the field of child growth. In other fields, such references may be rare or uncommon. In that case, we may achieve the benefits of <span class="math inline">\(Z\)</span>-scale analysis by applying the broken stick model to the standardized residuals of a preliminary non-linear regression of the outcome on time.</p>
</div>
<div class="section level3" number="5.4">
<h3 id="model-fitting">
<span class="header-section-number">5.4</span> Model fitting<a class="anchor" aria-label="anchor" href="#model-fitting"></a>
</h3>
<div class="figure">
<span style="display:block;" id="fig:plotsds"></span>
<img src="manual_files/figure-html/plotsds-1.png" alt="Detrended growth chart. Length growth of 52 infants 0-2 years expressed in the Z-score scale. Each trajectory represents a child. Trajectories are almost flat in this representation. More centile crossings occur near the start of the trajectory." width="100%"><p class="caption">
Figure 4: Detrended growth chart. Length growth of 52 infants 0-2 years expressed in the Z-score scale. Each trajectory represents a child. Trajectories are almost flat in this representation. More centile crossings occur near the start of the trajectory.
</p>
</div>
<p>Figure <a href="#fig:plotsds">4</a> displays the growth curves of a subset of 52 children. The <span class="math inline">\(Z\)</span>-score transformation takes away the major time trend, so all trajectories are more or less flat. This display allows us to see an extremely detailed assessment of individual growth. Note how the measurements cluster around ten ages: birth, 1, 2, 3, 6, 9, 12, 15, 18 and 24 months. While the data collectors rigorously followed the study design, variation in timing is inevitable because of weekends, holidays, sickness, and other events.</p>
<div class="section level4" number="5.4.1">
<h4 id="fit-one-line">
<span class="header-section-number">5.4.1</span> Fit one line<a class="anchor" aria-label="anchor" href="#fit-one-line"></a>
</h4>
<p>As a start, let us fit a simple straight line model over the age range 0y-2y.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/brokenstick.html">brokenstick</a></span><span class="op">(</span><span class="va">hgt_z</span> <span class="op">~</span> <span class="va">age</span> <span class="op">|</span> <span class="va">id</span>, <span class="va">smocc_200</span>, knots <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../../reference/get_knots.html">get_knots</a></span><span class="op">(</span><span class="va">fit1</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0.00 2.00 2.68</span></span></code></pre>
<p>The argument <code>knots = c(0, 2)</code> specifies that we wish to model the data over age range 0y-2y as a straight line. Closer inspection by <code>get_knots(fit1)</code> reveals that there is actually another knot at the right boundary at age 2.68 years. This knot needs to be there to ensure that all data are taken into account, but it is not of direct interest. We can plot individual trajectories as:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10001</span>, <span class="fl">10005</span>, <span class="fl">10022</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fit1</span>, group <span class="op">=</span> <span class="va">ids</span>, xlab <span class="op">=</span> <span class="st">"Age (years)"</span>, ylab <span class="op">=</span> <span class="st">"Length (SDS)"</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:line1plot"></span>
<img src="manual_files/figure-html/line1plot-1.png" alt="Observed data (blue) and fitted broken stick model (red) with a straight line between birth and two years. While this model picks up the overall trend, it ignores any systematic patterns around the line." width="100%"><p class="caption">
Figure 5: Observed data (blue) and fitted broken stick model (red) with a straight line between birth and two years. While this model picks up the overall trend, it ignores any systematic patterns around the line.
</p>
</div>
<p>Figure <a href="#fig:line1plot">5</a> shows the observed (blue) and fitted (red) trajectories of three selected children. As a side note, we can actually plot the model over the full age range of the data by adding argument <code>what = "all"</code> to the <code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code> function (not shown). Observe that the model only captures the overall age trend, so the fit to the data is moderate.</p>
</div>
<div class="section level4" number="5.4.2">
<h4 id="fit-two-lines">
<span class="header-section-number">5.4.2</span> Fit two lines<a class="anchor" aria-label="anchor" href="#fit-two-lines"></a>
</h4>
<p>We now extend to two connected lines. The first line should start at birth and end at the age of one year. The second line spans the period between one to two years. The lines must connect at the age of one year. We estimate and plot the model as follows:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/brokenstick.html">brokenstick</a></span><span class="op">(</span><span class="va">hgt_z</span> <span class="op">~</span> <span class="va">age</span> <span class="op">|</span> <span class="va">id</span>, <span class="va">smocc_200</span>, knots <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fit2</span>, group <span class="op">=</span> <span class="va">ids</span>,</span>
<span>     xlab <span class="op">=</span> <span class="st">"Age (years)"</span>, ylab <span class="op">=</span> <span class="st">"Length (SDS)"</span><span class="op">)</span></span></code></pre></div>
<p>The resulting plot was already shown as Figure <a href="#fig:plotfit2x">2</a> (top line). The <code>fit2</code> object holds the parameter estimates of the model:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit2</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Class        brokenstick (kr)</span></span>
<span><span class="co">## Variables    hgt_z (outcome), age (predictor), id (group)</span></span>
<span><span class="co">## Data         1942 (n), 36 (nmis), 200 (groups)</span></span>
<span><span class="co">## Parameters   16 (total), 4 (fixed), 4 (variance), 6 (covariance), 2 (error)</span></span>
<span><span class="co">## Knots        0 1 2 2.68 </span></span>
<span><span class="co">## Means        -0.045 0.018 0.061 0.136 </span></span>
<span><span class="co">## Residuals    0.125 0.15 0.17 0.2 0.379 (min, P25, P50, P75, max)</span></span>
<span><span class="co">## Mean resid   0.182 </span></span>
<span><span class="co">## R-squared    0.866 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Variance-covariance matrix</span></span>
<span><span class="co">##            age_0 age_1 age_2 age_2.6776</span></span>
<span><span class="co">## age_0      1.226                       </span></span>
<span><span class="co">## age_1      0.494 0.841                 </span></span>
<span><span class="co">## age_2      0.454 0.794 0.874           </span></span>
<span><span class="co">## age_2.6776 0.288  0.21 0.346      0.588</span></span></code></pre>
<p>The printed output lists the knots of the model at 0, 1, 2 and 2.6776 years. The left and right boundaries are located at 0 and 2.6776, respectively, corresponding to the lowest and highest ages in the data. The <code>means</code> entry lists the fixed effect estimates, which we interpret as the average SDS per time point. The time-to-time variance-covariance matrix covers four random effects (3 visits + 1 end knot). The two error parameters measure the the variability of the discrepancies between the model and the observed data. These three parameters (fixed, random, residual variance) are well interpretable and fully record the fitted broken stick model.</p>
</div>
<div class="section level4" number="5.4.3">
<h4 id="fit-nine-lines">
<span class="header-section-number">5.4.3</span> Fit nine lines<a class="anchor" aria-label="anchor" href="#fit-nine-lines"></a>
</h4>
<p>The two-line model does not fit well. We substantially refine the model by adding a knot for each scheduled visit. We code and run the model as</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit9</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/brokenstick.html">brokenstick</a></span><span class="op">(</span><span class="va">hgt_z</span> <span class="op">~</span> <span class="va">age</span> <span class="op">|</span> <span class="va">id</span>, <span class="va">smocc_200</span>, seed <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                    knots <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">6</span>, <span class="fl">9</span>, <span class="fl">12</span>, <span class="fl">15</span>, <span class="fl">18</span>, <span class="fl">24</span><span class="op">)</span><span class="op">/</span><span class="fl">12</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>With a small residual variance of 0.077, the nine-line broken stick model fits the observed data very well.</p>
<p>Figure <a href="#fig:plotfit2x">2</a> (bottom line) illustrates that the nine-line model follows that data much better. The training set includes all subjects. Depending on the study goals, we may wish to further improve the model fit by removing children from the data. For example, there might be children for which few observations are available, children with diseases, or children with trajectories that are very unusual or faulty. Use <code>hist(fit9$sigma2j)</code> to spot the outlier. Of course, such removals may affect external generalisability.</p>
</div>
</div>
<div class="section level3" number="5.5">
<h3 id="prediction">
<span class="header-section-number">5.5</span> Prediction<a class="anchor" aria-label="anchor" href="#prediction"></a>
</h3>
<p>Once we have a fitted model, we may obtain predictions. The subject(s) could be part of the training sample, but could also consist of new children.</p>
<div class="section level4" number="5.5.1">
<h4 id="all-subjects">
<span class="header-section-number">5.5.1</span> All subjects<a class="anchor" aria-label="anchor" href="#all-subjects"></a>
</h4>
<p>The <code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code> function obtains predictions from the broken stick model. The function is flexible, and allows for prediction of new subjects at arbitrary ages in a variety of output formats. The simplest call</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit9</span>, shape <span class="op">=</span> <span class="st">"vector"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">p1</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1]  0.574  0.852  0.750  0.643  0.231 -0.168</span></span></code></pre>
<p>produces a vector of length with predictions at the observed ages. These values represent a compromise between each person’s measurement and the global mean. In general, the fewer and less extreme data points of a person are, the closer the compromise will be toward the global mean. The compromise is called the <em>conditional mean</em> of the posterior distribution, the sum of the fixed and random effects.</p>
<p>We can obtain the predictions at each knot for every person by specifying the <code>x = "knots"</code> argument, e.g.,</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit9</span>, x <span class="op">=</span> <span class="st">"knots"</span>, shape <span class="op">=</span> <span class="st">"wide"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">p2</span>, <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 3 × 12</span></span></span>
<span><span class="co">##      id    `0` 0.083…¹ 0.166…² `0.25`  `0.5` `0.75`    `1` `1.25`  `1.5`</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> <span style="text-decoration: underline;">10</span>001  0.574   0.856   0.739  0.650  0.237 -<span style="color: #BB0000;">0.172</span>  0.121  0.163 -<span style="color: #BB0000;">0.193</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span> <span style="text-decoration: underline;">10</span>002 -<span style="color: #BB0000;">0.189</span>  -<span style="color: #BB0000;">0.311</span>  -<span style="color: #BB0000;">0.260</span> -<span style="color: #BB0000;">0.315</span> -<span style="color: #BB0000;">0.229</span> -<span style="color: #BB0000;">0.282</span> -<span style="color: #BB0000;">0.336</span> -<span style="color: #BB0000;">0.494</span> -<span style="color: #BB0000;">0.490</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">3</span> <span style="text-decoration: underline;">10</span>003  1.17    2.10    1.98   2.02   2.04   1.81   1.31   1.14   0.880</span></span>
<span><span class="co">## <span style="color: #949494;"># … with 2 more variables: `2` &lt;dbl&gt;, `2.6776` &lt;dbl&gt;, and abbreviated</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   variable names ¹​`0.0833`, ²​`0.1667`</span></span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ Use `colnames()` to see all variable names</span></span></span></code></pre>
<p>The result <code>p2</code> is a table with 200 rows with the values at 11 knots. These values represent the regularised version of each observed curve, i.e., having a predicted value at each knot location.</p>
<p>We may request the combination of both types of predictions in one call as</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit9</span>, x <span class="op">=</span> <span class="st">"knots"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">p3</span>, <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   .source    id    age    sex ga   bw  hgt hgt_z .pred</span></span>
<span><span class="co">## 1    data 10001 0.0000 female 40 3960 52.0 0.575 0.574</span></span>
<span><span class="co">## 2    data 10001 0.0821 female 40 3960 55.6 0.888 0.852</span></span>
<span><span class="co">## 3    data 10001 0.1588 female 40 3960 58.2 0.797 0.750</span></span></code></pre>
<p>The result is a long matrix with 4142 rows. There are two special columns. Column <code>.pred</code> contains the predicted values. Column <code>.source</code> identifies whether the row comes from the training data (value “data”) or corresponds to one of the knots (value “added”). The number of records from the training data and the knots is:</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">p3</span><span class="op">$</span><span class="va">.source</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## added  data </span></span>
<span><span class="co">##  2200  1942</span></span></code></pre>
<p>This dataset is perfectly suited to plot and summarise data and model predictions.</p>
<p>Now suppose that we desire to predict height SDS at other ages, e.g., at 0.42, 1.33 and 4 years. We can do so by</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit9</span>, x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.42</span>, <span class="fl">1.33</span>, <span class="fl">4</span><span class="op">)</span>, shape <span class="op">=</span> <span class="st">"wide"</span>,</span>
<span>             include_data <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 3 × 4</span></span></span>
<span><span class="co">##      id `0.42`  `1.33`   `4`</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> <span style="text-decoration: underline;">10</span>001  0.369  0.049<span style="text-decoration: underline;">2</span>    <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span> <span style="text-decoration: underline;">10</span>002 -<span style="color: #BB0000;">0.257</span> -<span style="color: #BB0000;">0.493</span>     <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">3</span> <span style="text-decoration: underline;">10</span>003  2.03   1.05      <span style="color: #BB0000;">NA</span></span></span></code></pre>
<p>The <code>include_data = FALSE</code> argument removes the observed data from the result to prevent conversion into an overly large and inefficient wide matrix. Thus, we have considerable flexibility to work with times that are not breakpoints. Remember though that the underlying model does not change. For example, we cannot magically predict outside the model at age 4, so those values all get <code>NA</code>.</p>
</div>
<div class="section level4" number="5.5.2">
<h4 id="single-subject">
<span class="header-section-number">5.5.2</span> Single subject<a class="anchor" aria-label="anchor" href="#single-subject"></a>
</h4>
<p>Obtaining predicted values for selected subjects requires the <code>group</code> argument (case 3 in <code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code>). For example</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit9</span>, group <span class="op">=</span> <span class="fl">10001</span>, shape <span class="op">=</span> <span class="st">"vector"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1]  0.574  0.852  0.750  0.643  0.231 -0.168  0.121  0.151 -0.150</span></span>
<span><span class="co">## [10]  0.142</span></span></code></pre>
<p>returns the vector of predictions for child 10001. Appending the child’s data is conveniently done by removing the <code>shape</code> argument. Also, we can predict at other times using the <code>x</code> argument, e.g. at ages 0.42 and 1.33 (case 4 in <code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code>).</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit9</span>, x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.42</span>, <span class="fl">1.33</span><span class="op">)</span>, group <span class="op">=</span> <span class="fl">10001</span>, shape <span class="op">=</span> <span class="st">"vector"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1]  0.5744  0.8519  0.7503  0.6428  0.2308 -0.1682  0.1214  0.1505</span></span>
<span><span class="co">##  [9] -0.1500  0.1424  0.3693  0.0492</span></span></code></pre>
<p>Now suppose that for subject 10001 we have additional height data at ages 0.42 and 1.33 years, say -0.5 SDS and -1 SDS, respectively. Can we predict the child’s trajectory with these new points included? The answer is yes:</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit9</span>, x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.42</span>, <span class="fl">1.33</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.5</span>, <span class="op">-</span><span class="fl">1</span><span class="op">)</span>, group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10001</span>, <span class="fl">10001</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    .source    id    age    sex ga   bw  hgt  hgt_z    .pred</span></span>
<span><span class="co">## 1     data 10001 0.0000 female 40 3960 52.0  0.575  0.61363</span></span>
<span><span class="co">## 2     data 10001 0.0821 female 40 3960 55.6  0.888  0.78191</span></span>
<span><span class="co">## 3     data 10001 0.1588 female 40 3960 58.2  0.797  0.67251</span></span>
<span><span class="co">## 4     data 10001 0.2546 female 40 3960 61.2  0.661  0.46165</span></span>
<span><span class="co">## 5     data 10001 0.5038 female 40 3960 67.2  0.290  0.00908</span></span>
<span><span class="co">## 6     data 10001 0.7529 female 40 3960 70.2 -0.398 -0.28561</span></span>
<span><span class="co">## 7     data 10001 1.0021 female 40 3960 75.7  0.202 -0.01344</span></span>
<span><span class="co">## 8     data 10001 1.1745 female 40 3960 78.5  0.268 -0.13440</span></span>
<span><span class="co">## 9     data 10001 1.5661 female 40 3960 81.8 -0.332 -0.39919</span></span>
<span><span class="co">## 10    data 10001 2.0096 female 40 3960 88.3  0.227  0.05064</span></span>
<span><span class="co">## 11   added 10001 0.4200   &lt;NA&gt; NA   NA   NA -0.500  0.15972</span></span>
<span><span class="co">## 12   added 10001 1.3300   &lt;NA&gt; NA   NA   NA -1.000 -0.27760</span></span></code></pre>
<p>The command (case 5 in <code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code>) appends two new records to the data of child 10001, and recalculates the trajectory using all data from child 10001. Note the last two rows contain the specified values in columns <code>age</code> and <code>hgt_z</code>, as well as the predicted value in <code>.pred</code>. These predicted values are different from those calculated above under case 4 because of the two additional observations. If desired the user could also fill values for columns <code>sex</code>, <code>ga</code>, and so on.</p>
</div>
<div class="section level4" number="5.5.3">
<h4 id="new-subject">
<span class="header-section-number">5.5.3</span> New subject<a class="anchor" aria-label="anchor" href="#new-subject"></a>
</h4>
<p>Suppose we have measured two new children, Fred and Alice. We wish to obtain predictions for both using the model <code>fit9</code>. The following snippet calculates predictions at both the observed ages and at the knot locations:</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.12</span>, <span class="fl">0.32</span>, <span class="fl">0.62</span>, <span class="fl">1.1</span>, <span class="fl">0.25</span>, <span class="fl">0.46</span><span class="op">)</span>,</span>
<span>  hgt_z <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1.2</span>, <span class="op">-</span><span class="fl">1.8</span>, <span class="op">-</span><span class="fl">1.7</span>, <span class="op">-</span><span class="fl">1.9</span>, <span class="op">-</span><span class="fl">2.1</span>, <span class="op">-</span><span class="fl">1.9</span>, <span class="op">-</span><span class="fl">1.5</span><span class="op">)</span>,</span>
<span>  id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"Fred"</span>, <span class="fl">5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"Alice"</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit9</span>, newdata <span class="op">=</span> <span class="va">data</span>, x <span class="op">=</span> <span class="st">"knots"</span><span class="op">)</span></span></code></pre></div>
<p>We can plot the trajectories data by</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fit9</span>, newdata <span class="op">=</span> <span class="va">data</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2.5</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>     xlab <span class="op">=</span> <span class="st">"Age (years)"</span>, ylab <span class="op">=</span> <span class="st">"Length (SDS)"</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:unnamed-chunk-15"></span>
<img src="manual_files/figure-html/unnamed-chunk-15-1.png" alt="Broken stick model prediction for sparse data. Alice and Fred have few observations (blue points). The broken stick model borrows information from other children to calculate fitted trajectories over the full age range (red points)." width="67%"><p class="caption">
Figure 6: Broken stick model prediction for sparse data. Alice and Fred have few observations (blue points). The broken stick model borrows information from other children to calculate fitted trajectories over the full age range (red points).
</p>
</div>
<p>Alice contributes only two data points in the first half-year. The model expects that her height SDS will be around -1 SD at the age of two years. Using the data up to 1.1 years, the model predicts that Fred’s growth curve remains around -2.0 SD until Fred is 1.5 years, and then increases to around -1.8 SD. While both predicted trajectories are extreme extrapolations, the example illustrates that it is possible to make informed predictions using just a handful of data points.</p>
<p>The <code>brokenstick:::EB()</code> function implements the empirical Bayes (EB) estimate (<span class="citation">Skrondal and Rabe‐Hesketh (2009)</span>, p. 683). The procedure is the workhorse underlying the <code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code> method.</p>
</div>
</div>
<div class="section level3" number="5.6">
<h3 id="quality-of-prediction">
<span class="header-section-number">5.6</span> Quality of prediction<a class="anchor" aria-label="anchor" href="#quality-of-prediction"></a>
</h3>
<div class="figure">
<span style="display:block;" id="fig:obspred"></span>
<img src="manual_files/figure-html/obspred-1.png" alt="Comparison between predicted (vertical) and observed (horizontal) height in the SDS scale (left) and CM scale (right) in the SMOCC data. The model almost perfectly recreates the observed data." width="100%"><p class="caption">
Figure 7: Comparison between predicted (vertical) and observed (horizontal) height in the SDS scale (left) and CM scale (right) in the SMOCC data. The model almost perfectly recreates the observed data.
</p>
</div>
<p>Figure <a href="#fig:obspred">7</a> is the scatterplot of the observed versus predicted values and provides a visual representation of the accuracy of the prediction of the model in height SDS and cm scales. Both plots suggest an excellent fit between the observed and fitted data. The percentage of explained variance for the height SDS is high: 98.1%. The standard deviation of the residuals is equal to 0.077 SD, a small value in the <span class="math inline">\(Z\)</span>-scale. When back-converted to centimetres, the scatterplot of the observed versus predicted values is even a little tighter. The estimate of the proportion of explained variance is close to perfection: 99.9%. The standard deviation of the residuals is 4 mm, about the size of the technical error of measurement (TEM) for duplicate measurements in infants <span class="citation">(Ismail et al. 2016, Table 2)</span>. The out-of-sample predictive behaviour is comparable. If we randomly split the data 100 times into 2/3 training data and 1/3 test data and calculate the proportion in the test data, we obtain even slightly higher out-of-sample values: 98.4% and 99.9% over the 100 replications.</p>
<p>The model is as good as it can get. The uncertainties associated with the transformation from varying observation times to repeated measures will be small. For all practical purposes, the results from a linear mixed or multilevel model and a repeated measures model are likely to be same.</p>
</div>
<div class="section level3" number="5.7">
<h3 id="knot-placement-strategies">
<span class="header-section-number">5.7</span> Knot placement strategies<a class="anchor" aria-label="anchor" href="#knot-placement-strategies"></a>
</h3>
<p>Fitting the broken stick model requires a specification of the knots. The choice of the knots influences the quality and usefulness of the solution, so exercise some care in setting appropriate knot locations.</p>
<p>The <code><a href="../../reference/brokenstick.html">brokenstick()</a></code> function uses the same set of knots for all subjects. By default, the procedure places five internal knots (through the default argument <code>k = 5</code>) and sets the boundary knots equal to the range of the predictor variable. The <code>k</code> argument is a quick way to add <code>k</code> internal knots at equidense quantiles of the time variable. For example, specifying <code>k = 1</code> puts a knot at the 50th quantile (median), setting <code>k = 3</code> puts knots at the 25th, 50th and 75th quantiles, and so on. While convenient and quick, this option can result in suboptimal knot placement that is not adequate for the problem at hand. In general, it is best to specify explicit values for the <code>knots</code> argument. In some cases, it may also be useful to set the <code>boundary</code> argument explicitly. This action makes the model specification less data-dependent and can restrict the range of the predictor that enters model fitting.</p>
<p>Here are some suggestions for knot placement:</p>
<ol style="list-style-type: decimal">
<li>Rule of thumb: Limit the number of knots to the (average) number of data points per subject;</li>
<li>If you want to predict at specific times, then specify knots at those time points. For example, if the scientific interest includes prediction at the age of 1 and 2 years, then include these time points as knots;</li>
<li>Setting knots at scheduled visits is a sensible strategy for obtaining predictions at precisely the scheduled times. Set equidistant knots if the analysis requires a fixed time interval;</li>
<li>Keep the number of knots low, for speed and simplicity. Having many (<span class="math inline">\(\geq 10\)</span>) knots can improve the fit to the data. Still, it will also increase calculation time and may result in unstable solutions. For problems that require more than 10 knots, <code>method = "kr"</code> (default) is faster than <code>method = "lmer"</code>. Use <code><a href="../../reference/control_kr.html">control_kr()</a></code> to improve stability by setting a correlation model;</li>
<li>Do not place knots in sparsely filled areas of the data, e.g., in-between two visits. Doing so may result in erratic joins;</li>
<li>Define a starting time common to all subjects (e.g., birth) and set the first breakpoint <code>knots[1]</code> equal to the left boundary knot <code>boundary[1]</code>. The <code><a href="../../reference/brokenstick.html">brokenstick()</a></code> already cautions to ensure this;</li>
<li>Use the <code><a href="../../reference/get_knots.html">get_knots()</a></code> function to extract knots from a fitted model;</li>
<li>Set maximum value in <code>knots</code> to the highest time of scientific interest, but still within the data range. Set boundary knot <code>boundary[2]</code> larger than this value, e.g., equal to the maximum of the time variable. Broken stick estimates at the right boundary knot have no useful interpretation, so exclude those estimates from plots and ignore them in subsequent analyses;</li>
<li>Set knots to explicit values to support generalisation over the time variable in the training data.</li>
</ol>
</div>
</div>
<div class="section level2" number="6">
<h2 id="applications">
<span class="header-section-number">6</span> Applications<a class="anchor" aria-label="anchor" href="#applications"></a>
</h2>
<div class="section level3" number="6.1">
<h3 id="critical-periods">
<span class="header-section-number">6.1</span> Critical periods<a class="anchor" aria-label="anchor" href="#critical-periods"></a>
</h3>
<p>The following question motivated the development of the broken stick model: <em>At what ages do children become overweight?</em> Knowing the answer to this question provides handles for preventive interventions to counter obesity. <span class="citation">Dietz (1994)</span> suggested the existence of three critical periods for obesity at adult age: the prenatal period, the period of adiposity rebound (roughly around the age of 5-6 years), and adolescence. Obesity formed in these periods is likely to increase the obesity risk at adult age and its complications.</p>
<p>A growth period, bounded by ages <span class="math inline">\(T_1\)</span> and <span class="math inline">\(T_2\)</span>, is critical for adult overweight if the following criteria hold: <span class="citation">(de Kroon et al. 2010)</span></p>
<ol style="list-style-type: lower-alpha">
<li>there is a significant difference in mean gain score <span class="math inline">\(Z_2-Z_1\)</span> between subjects with and without adult overweight;</li>
<li>the gain score <span class="math inline">\(Z_2-Z_1\)</span> has an independent contribution over <span class="math inline">\(Z_2\)</span> to the prediction of <span class="math inline">\(Z_{\rm adult}\)</span>. It not only matters where you were at <span class="math inline">\(T_2\)</span> but also how you got there;</li>
<li>
<span class="math inline">\(Z_2\)</span> correlates highly with <span class="math inline">\(Z_{\rm adult}\)</span>, so it is easier (i.e., with higher sensitivity and specificity) to identify children at risk for adult overweight.</li>
</ol>
<p><span class="citation">de Kroon et al. (2010)</span> found that the age interval 2-6 years met all criteria for a critical period. Our re-analysis tests the requirements for the following age intervals: birth-4 months, 4 months-1 year, 1-2 years, 2-4 years, 4-6 years, 6-10 years and 10-14 years. Hence, we define the following break ages:</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">knots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">/</span><span class="fl">3</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">4</span>, <span class="fl">6</span>, <span class="fl">10</span>, <span class="fl">14</span>, <span class="fl">24</span>, <span class="fl">29</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">labels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"birth"</span>, <span class="st">"4m"</span>, <span class="st">"1y"</span>, <span class="st">"2y"</span>, <span class="st">"4y"</span>, <span class="st">"6y"</span>, <span class="st">"10y"</span>, <span class="st">"14y"</span>, <span class="st">"24y"</span>,</span>
<span>            <span class="st">""</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:tbc1"></span>
<img src="manual_files/figure-html/tbc1-1.png" alt="Scatterplot of BMI SDS and log(age + 0.2) for the Terneuzen cohort data. The plot shows differential amounts of clustering of measurements around the specified break ages. Clustering is tighter at some ages (birth, 1y, 14y) than at others (4m, 2y, 24y)." width="100%"><p class="caption">
Figure 8: Scatterplot of BMI SDS and log(age + 0.2) for the Terneuzen cohort data. The plot shows differential amounts of clustering of measurements around the specified break ages. Clustering is tighter at some ages (birth, 1y, 14y) than at others (4m, 2y, 24y).
</p>
</div>
<p>The Terneuzen Birth Cohort <span class="citation">(de Kroon et al. 2008)</span> comprises of 2604 children born around the year 1980 in Terneuzen, The Netherlands. Figure <a href="#fig:tbc1">8</a> shows the body mass index (BMI) standard deviation scores (SDS) against age in a random subset of 306 children. While we may easily recognise scheduled visits at birth, 1y and 14y, the figure shows that observations at other periods are less structured. Compared to the analysis in <span class="citation">de Kroon et al. (2010)</span>, we removed the knots at 8 days and 18 years (because these appear in sparse data areas) and added knots at 4, 14 and 24 years. For aesthetic reasons, we set the right boundary knot to 29y, slightly higher than the maximum age in the data.</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ctl</span> <span class="op">&lt;-</span> <span class="fu">lme4</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmerControl.html" class="external-link">lmerControl</a></span><span class="op">(</span></span>
<span>  check.conv.grad <span class="op">=</span> <span class="fu">lme4</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmerControl.html" class="external-link">.makeCC</a></span><span class="op">(</span><span class="st">"warning"</span>, <span class="fl">0.02</span>, <span class="cn">NULL</span><span class="op">)</span>,</span>
<span>  check.conv.singular <span class="op">=</span> <span class="fu">lme4</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmerControl.html" class="external-link">.makeCC</a></span><span class="op">(</span><span class="st">"ignore"</span>, <span class="fl">0.001</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">fit_lmer</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/brokenstick.html">brokenstick</a></span><span class="op">(</span><span class="va">bmi.z</span> <span class="op">~</span> <span class="va">age</span> <span class="op">|</span> <span class="va">id</span>, data <span class="op">=</span> <span class="fu">mice</span><span class="fu">::</span><span class="va"><a href="https://amices.org/mice/reference/tbc.html" class="external-link">tbc</a></span>,</span>
<span>                        knots <span class="op">=</span> <span class="va">knots</span>, boundary <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">29</span><span class="op">)</span>,</span>
<span>                        method <span class="op">=</span> <span class="st">"lmer"</span>, control <span class="op">=</span> <span class="va">ctl</span><span class="op">)</span></span></code></pre></div>
<p>The control specification prevents warnings and messages that result from the over-parametrised nature of the model. One may stabilise the model by restricting the variance-covariance matrix, for example by the Argyle correlation model. As a result, the fitted trajectories will be stabler in regions with sparse data. The following snippet applies the Argyle model.</p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_kr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/brokenstick.html">brokenstick</a></span><span class="op">(</span><span class="va">bmi.z</span> <span class="op">~</span> <span class="va">age</span> <span class="op">|</span> <span class="va">id</span>, data <span class="op">=</span> <span class="fu">mice</span><span class="fu">::</span><span class="va"><a href="https://amices.org/mice/reference/tbc.html" class="external-link">tbc</a></span>,</span>
<span>                      knots <span class="op">=</span> <span class="va">knots</span>, boundary <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">29</span><span class="op">)</span>,</span>
<span>                      seed <span class="op">=</span> <span class="fl">41441</span>, cormodel <span class="op">=</span> <span class="st">"argyle"</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:tbc-trajectories"></span>
<img src="manual_files/figure-html/tbc-trajectories-1.png" alt="Observed and fitted BMI SDS trajectories of six subjects as predicted by the lmer (red) and Argyle (green) models. The figure illustrates that fitted trajectories from the Argyle model are stabler in areas with sparse data." width="100%"><p class="caption">
Figure 9: Observed and fitted BMI SDS trajectories of six subjects as predicted by the lmer (red) and Argyle (green) models. The figure illustrates that fitted trajectories from the Argyle model are stabler in areas with sparse data.
</p>
</div>
<p>Figure <a href="#fig:tbc-trajectories">9</a> shows the observed and fitted BMI SDS trajectories for both models. The per cent explained variance of BMI SDS is similar in both: 84 per cent. For the lmer model, the fitted trajectory for subject 8 reveals a pretty rough estimate at the age of 24y. Persons 1259 and 7460 have very low (-2.5 SD) and high (+2.5 SD) BMI SDS at adult age, respectively. Note that the model pulls the adult BMI SDS estimates (in red) towards the global mean, due to the well-known bias-variance tradeoff <span class="citation">(Gelman and Hill 2007, 394)</span>. Pulling is more vigorous at the extremes. The effect is negligible for more average trajectories, such as for subject 2447. In the Argyle model, the trajectories are slightly smoother and more stable at adult ages with limited data. The rough estimate for subject 8 has gone. There is still some gravity towards the global mean at knot 24y for persons 1259 and 7460, but it is of lesser magnitude. All fitted trajectories are well behaved. We, therefore, select the <code>kr</code> solution for further analysis.</p>
<p>To identify critical periods, we need to predict adult overweight. In Figure <a href="#fig:tbc-trajectories">9</a>, only three out of six subjects had a BMI measurement at adult age. Since we do not want the results to overly depend on fitted extrapolations, we restrict the analysis sample to persons with an adult measurement. The following lines extract the repeated measures for 92 (out of 306) individuals for whom we observed adult BMI.</p>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tbc1</span> <span class="op">&lt;-</span> <span class="fu">mice</span><span class="fu">::</span><span class="va"><a href="https://amices.org/mice/reference/tbc.html" class="external-link">tbc</a></span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">ao</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">first</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">nocc</span>, <span class="va">sex</span><span class="op">)</span></span>
<span><span class="va">tbc2</span> <span class="op">&lt;-</span> <span class="fu">mice</span><span class="fu">::</span><span class="va"><a href="https://amices.org/mice/reference/tbc.html" class="external-link">tbc.target</a></span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">tbc1</span><span class="op">$</span><span class="va">id</span><span class="op">)</span></span>
<span><span class="va">prd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit_kr</span>, <span class="fu">mice</span><span class="fu">::</span><span class="va"><a href="https://amices.org/mice/reference/tbc.html" class="external-link">tbc</a></span>, x <span class="op">=</span> <span class="st">"knots"</span>, shape <span class="op">=</span> <span class="st">"wide"</span>,</span>
<span>               group <span class="op">=</span> <span class="va">tbc1</span><span class="op">$</span><span class="va">id</span><span class="op">)</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html" class="external-link">bind_cols</a></span><span class="op">(</span><span class="va">prd</span>,</span>
<span>                  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">tbc1</span>, <span class="op">-</span><span class="va">id</span><span class="op">)</span>,</span>
<span>                  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">tbc2</span>, <span class="op">-</span><span class="va">id</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">data</span>, <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 3 × 15</span></span></span>
<span><span class="co">##      id   `0` `0.333`     `1`    `2`    `4`    `6`   `10`   `14`   `24`</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span>     8 0.371  -<span style="color: #BB0000;">0.440</span>  0.366   1.45   1.10   0.606  0.489  0.544 -<span style="color: #BB0000;">0.822</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span>    60 0.159  -<span style="color: #BB0000;">0.372</span> -<span style="color: #BB0000;">0.044</span><span style="color: #BB0000; text-decoration: underline;">2</span> -<span style="color: #BB0000;">0.360</span> -<span style="color: #BB0000;">0.595</span> -<span style="color: #BB0000;">0.818</span> -<span style="color: #BB0000;">1.03</span>  -<span style="color: #BB0000;">1.16</span>  -<span style="color: #BB0000;">1.46</span> </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">3</span>    97 1.68    0.569  0.948   1.90   1.28   0.838  0.444  0.238  0.397</span></span>
<span><span class="co">## <span style="color: #949494;"># … with 5 more variables: `29` &lt;dbl&gt;, nocc &lt;dbl&gt;, sex &lt;dbl&gt;, ao &lt;dbl&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   bmi.z.jv &lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ Use `colnames()` to see all variable names</span></span></span></code></pre>
<div class="figure">
<span style="display:block;" id="fig:tbc-trajectories-all"></span>
<img src="manual_files/figure-html/tbc-trajectories-all-1.png" alt="Fitted BMI SDS trajectories for 92 subjects, of which 18 persons have adult overweight (red = observed BMI at adult age &gt; 1.3 SDS), while 74 individuals (grey) do not have adult overweight. The figure shows that the BMI distribution before the age of 2y is similar in both groups, whereas BMI at ages 10y and 14y is highly predictive of adult overweight." width="100%"><p class="caption">
Figure 10: Fitted BMI SDS trajectories for 92 subjects, of which 18 persons have adult overweight (red = observed BMI at adult age &gt; 1.3 SDS), while 74 individuals (grey) do not have adult overweight. The figure shows that the BMI distribution before the age of 2y is similar in both groups, whereas BMI at ages 10y and 14y is highly predictive of adult overweight.
</p>
</div>
<p>Figure <a href="#fig:tbc-trajectories-all">10</a> shows the 92 fitted trajectories coloured by adult overweight status (observed BMI SDS &gt; 1.3). It is evident that BMI SDS at ages of 14y or 10y is highly predictive of adult overweight, but does that also hold in early childhood? Also, does a change in specific periods predict later overweight? To answer such questions, we fit simple linear models to predict observed (not fitted!) BMI SDS at adult age from the fitted BMI SDS trajectories. The following code block fits two models for the period 4y-6y.</p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">bmi.z.jv</span> <span class="op">~</span> <span class="va">`6`</span>, <span class="va">data</span><span class="op">)</span></span>
<span><span class="va">m2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">bmi.z.jv</span> <span class="op">~</span> <span class="va">`6`</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">`6`</span><span class="op">-</span><span class="va">`4`</span><span class="op">)</span>, <span class="va">data</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/anova.html" class="external-link">anova</a></span><span class="op">(</span><span class="va">m1</span>, <span class="va">m2</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Analysis of Variance Table</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Model 1: bmi.z.jv ~ `6`</span></span>
<span><span class="co">## Model 2: bmi.z.jv ~ `6` + I(`6` - `4`)</span></span>
<span><span class="co">##   Res.Df  RSS Df Sum of Sq    F  Pr(&gt;F)    </span></span>
<span><span class="co">## 1     90 74.3                              </span></span>
<span><span class="co">## 2     89 63.4  1      10.8 15.2 0.00019 ***</span></span>
<span><span class="co">## ---</span></span>
<span><span class="co">## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span></code></pre>
<p>Model <code>m1</code> predicts adult BMI SDS from BMI SDS 6y, and explains 45.3 per cent of the variance. Model <code>m2</code> extends the model with the pre-gain between 4y and 6y. If the pre-gain improves the prediction, then it matters how much you gained between 4y and 6y. In that case, we would call the interval 4y-6y a critical period. Here we found that model 2 explain 53.6 per cent variance, thus 8.3 per cent more. The <code>anova</code> statement performs the formal test. In this case, the pre-gain is significant over the last predictor at 6y. Thus, interval 4y-6y classifies as a critical period. We can repeat these analyses for other age intervals, similar to Table 3 in <span class="citation">Kenward (1987)</span>.</p>
</div>
<div class="section level3" number="6.2">
<h3 id="time-to-time-correlations">
<span class="header-section-number">6.2</span> Time-to-time correlations<a class="anchor" aria-label="anchor" href="#time-to-time-correlations"></a>
</h3>
<p>The <em>conditional gain score</em> is defined as <span class="citation">(T. J. Cole 1995)</span></p>
<p><span class="math display">\[
{\rm conditional}\ Z_{\rm gain} = \frac{Z_2 - rZ_1}{\sqrt{1-r^2}},
\]</span></p>
<p>where <span class="math inline">\(Z_1\)</span> and <span class="math inline">\(Z_2\)</span> are the standard deviation scores at times <span class="math inline">\(T_1\)</span> and <span class="math inline">\(T_2\)</span>, with <span class="math inline">\(T_2&gt;T_1\)</span>, and where <span class="math inline">\(r\)</span> is the correlation between <span class="math inline">\(Z_1\)</span> and <span class="math inline">\(Z_2\)</span>. The conditional gain corrects for regression to the mean, which is its selling point over traditional velocity measures and is less sensitive to measurement error <span class="citation">(van Buuren 2007)</span>. A practical difficulty is to obtain <span class="math inline">\(r\)</span> for a given <span class="math inline">\(T_1\)</span> and <span class="math inline">\(T_2\)</span>. The time-to-time correlation matrix needs to be known. Also, we need to interpolate <span class="math inline">\(r\)</span> if <span class="math inline">\(T_1\)</span> or <span class="math inline">\(T_2\)</span> differs from the tabulated ages.</p>
<p>The broken stick model provides an estimate of the time-to-time correlation matrix. The <code>brokenstick</code> object stores the variance-covariance matrix <span class="math inline">\(\Omega\)</span> of the random effects. For a perfectly fitting model (with <span class="math inline">\(\sigma^2=0\)</span>) <span class="math inline">\(\Omega\)</span> equals the time-to-time covariance matrix, so then <code>get_omega(fit, what = "cor")</code> gives the desired time-to-time correlation matrix. If <span class="math inline">\(\sigma^2 &gt; 0\)</span> then <span class="math inline">\(\Omega\)</span> overestimates the covariances between the observed data. In general, we need to add the within-residual variance estimate to the diagonal, thus <span class="math inline">\(\Omega + \hat\sigma^2 I(n_i)\)</span> to estimate the time-to-time covariance matrix.</p>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/brokenstick.html">brokenstick</a></span><span class="op">(</span><span class="va">hgt_z</span> <span class="op">~</span> <span class="va">age</span> <span class="op">|</span> <span class="va">id</span>, data <span class="op">=</span> <span class="va">smocc_200</span>,</span>
<span>                   knots <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">omega</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/get_omega.html">get_omega</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span>
<span><span class="va">t2t</span> <span class="op">&lt;-</span> <span class="va">omega</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">sigma2</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">omega</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cov2cor</a></span><span class="op">(</span><span class="va">t2t</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##         age_0 age_0.5 age_1 age_1.5 age_2</span></span>
<span><span class="co">## age_0    1.00    0.57  0.42    0.37  0.31</span></span>
<span><span class="co">## age_0.5  0.57    1.00  0.76    0.71  0.67</span></span>
<span><span class="co">## age_1    0.42    0.76  1.00    0.80  0.78</span></span>
<span><span class="co">## age_1.5  0.37    0.71  0.80    1.00  0.82</span></span>
<span><span class="co">## age_2    0.31    0.67  0.78    0.82  1.00</span></span></code></pre>
<p>In child growth, we expect that the correlation tapers off as the difference between <span class="math inline">\(T_1\)</span> and <span class="math inline">\(T_2\)</span> grows. Also, for a fixed interval <span class="math inline">\(T_2-T_1\)</span> we expect the correlation to increase with age. Ignoring the uninteresting estimate for <code>age_3</code>, we find that both expectations hold. Altering the number and location of the knots may change this. It is often useful to scan the time-to-time correlation matrix for gross deviations of the expectations. If such happens, one could simplify the model, for example, by subjecting <span class="math inline">\(\Omega\)</span> to a correlation model.</p>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/brokenstick.html">brokenstick</a></span><span class="op">(</span><span class="va">hgt_z</span> <span class="op">~</span> <span class="va">age</span> <span class="op">|</span> <span class="va">id</span>, data <span class="op">=</span> <span class="va">smocc_200</span>,</span>
<span>                   knots <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">0.1</span><span class="op">)</span>, cormodel <span class="op">=</span> <span class="st">"argyle"</span><span class="op">)</span></span>
<span><span class="va">omega</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/get_omega.html">get_omega</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span>
<span><span class="va">t2t</span> <span class="op">&lt;-</span> <span class="va">omega</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">sigma2</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">omega</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">t2t</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 21 21</span></span></code></pre>
<p>The above code fits a model with 22 equidistant breakpoints, which is likely large enough for most purposes. It works because it restricts the covariance-matrix by the Argyle correlation model, which summarises the information by just two parameters. We may extract or re-estimate these parameters and create a one-liner for calculating <span class="math inline">\(r\)</span>.</p>
<p>We cannot indefinitely add breakpoints. Suppose we double the number of knots by setting <code>knots = seq(0, 2, 0.05)</code>. Then even <code>kr</code> is not able to cope and will abort with <code>Error: Sigma is symmetric but not positive</code>. Thus, as always, be sensible in what you ask the software to do for you.</p>
</div>
<div class="section level3" number="6.3">
<h3 id="profile-analysis">
<span class="header-section-number">6.3</span> Profile analysis<a class="anchor" aria-label="anchor" href="#profile-analysis"></a>
</h3>
<p>Profile analysis <span class="citation">(Morrison 1976; Johnson and Wichern 1988)</span> refers linear multivariate linear methods to test for differences in population means or treatment effects, typically by regression analysis or multivariate analysis of variance (MANOVA). These methods assume independence of subjects, organise the data at the subject level, and express parameters of interest by linear combinations of outcomes, like change scores, means or other derived quantities.</p>
<p><span class="citation">Krone et al. (2020)</span> report a statistical analyses using the linear mixed model with time-varying individual subject data. This section re-analyses the data from their Figure 4 using the broken stick model. The data are available as the <code><a href="../../reference/weightloss.html">brokenstick::weightloss</a></code> object.</p>
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">brokenstick</span><span class="fu">::</span><span class="va"><a href="../../reference/weightloss.html">weightloss</a></span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">day</span>, <span class="va">body_weight</span>, group <span class="op">=</span> <span class="va">subject</span>,</span>
<span>                 colour <span class="op">=</span> <span class="va">condition</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Day"</span>, breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">21</span>, <span class="fl">42</span>, <span class="fl">63</span><span class="op">)</span>, minor_breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">7</span>, <span class="fl">14</span>, <span class="fl">28</span>, <span class="fl">35</span>, <span class="fl">49</span>, <span class="fl">56</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Body weight (KG)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_light</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: Removed 28 row(s) containing missing values (geom_path).</span></span></code></pre>
<pre><code><span><span class="co">## Warning: Removed 61 rows containing missing values (geom_point).</span></span></code></pre>
<div class="figure">
<span style="display:block;" id="fig:weightloss-data"></span>
<img src="manual_files/figure-html/weightloss-data-1.png" alt="Daily body weight (KG) for 12 subjects followed for 63 days under one of three conditions. The graph illustrates the irregular nature of the data. Some trajectories are almost complete and regular, fig.height=4.5, warning=FALSE, whereas others miss many daily measurements or display surprising jumps around their average weight level." width="100%"><p class="caption">
Figure 11: Daily body weight (KG) for 12 subjects followed for 63 days under one of three conditions. The graph illustrates the irregular nature of the data. Some trajectories are almost complete and regular, fig.height=4.5, warning=FALSE, whereas others miss many daily measurements or display surprising jumps around their average weight level.
</p>
</div>
<p>Figure <a href="#fig:weightloss-data">11</a> charts daily body weight measurements of twelve individuals who were followed for nine weeks. The investigators subdivided the total duration into three periods of three weeks. Period one (week 1-3) acted as a control period. During period 2 (week 4-6), the investigators stimulated participants to restrict food intake, and during period 3 (week 7-9) the experimenters promoted physical activity. Subjects 4 and 12 received the interventions in the opposite order. See <span class="citation">Krone et al. (2020)</span> for more detail.</p>
<p>Most of these subjects adhere quite well to the data collection design. Some trajectories show gaps due to missed measurements. The most extreme example is the trajectory that hovers around the value of 95 kilograms (KG). Other curves display stretches of lines, suggesting that missed measurements were linearly interpolated. One of the series shows some surprising spikes, likely to be measurement errors. All in all, these data perfectly illustrate the inescapable imperfections of real data.</p>
<p>The remainder of the section discusses two ways to estimate the effect of diet and physical activity on body weight.</p>
<div class="section level4" number="6.3.1">
<h4 id="constant-model">
<span class="header-section-number">6.3.1</span> Constant model<a class="anchor" aria-label="anchor" href="#constant-model"></a>
</h4>
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">brokenstick</span><span class="fu">::</span><span class="va"><a href="../../reference/weightloss.html">weightloss</a></span></span>
<span><span class="va">fit0</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/brokenstick.html">brokenstick</a></span><span class="op">(</span><span class="va">body_weight</span> <span class="op">~</span> <span class="va">day</span> <span class="op">|</span> <span class="va">subject</span>, <span class="va">data</span>,</span>
<span>                    knots <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">21</span>, <span class="fl">42</span>, <span class="fl">63</span><span class="op">)</span>, degree <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                    method <span class="op">=</span> <span class="st">"lmer"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fit0</span>, size_y <span class="op">=</span> <span class="fl">0</span>, color_y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"grey"</span>, <span class="fl">2</span><span class="op">)</span>, what <span class="op">=</span> <span class="st">"all"</span>,</span>
<span>     scales <span class="op">=</span> <span class="st">"free_y"</span>, xlab <span class="op">=</span> <span class="st">"Day"</span>, ylab <span class="op">=</span> <span class="st">"Body weight (KG)"</span>,</span>
<span>     n_plot <span class="op">=</span> <span class="fl">12</span>, ncol <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:weightloss-constant"></span>
<img src="manual_files/figure-html/weightloss-constant-1.png" alt="Constant model. Observed and fitted trajectories for a model that summarises each experimental period by a constant. The estimated level is approximately the mean of the measurements made during the period. The model produces sudden jumps at ages when the condition changes and thus fails to describe the data well." width="100%"><p class="caption">
Figure 12: Constant model. Observed and fitted trajectories for a model that summarises each experimental period by a constant. The estimated level is approximately the mean of the measurements made during the period. The model produces sudden jumps at ages when the condition changes and thus fails to describe the data well.
</p>
</div>
<p>The model underlying Figure <a href="#fig:weightloss-constant">12</a> summarises the trajectory within a period by a constant, the mean. We obtain an estimate of these means by setting the <code>degree = 0</code> argument. This model gives a fair representation of the trajectory of subjects 9 (a persistent downward trend), 1 and 5 (no trend). On the other hand, the model fails to capture patterns for subjects 2, 4 and 8 (rebound in period 3) or 11 (inverse rebound).</p>
<p>It is straightforward quantify the effects of <code>Diet</code> and <code>Activity</code> relative to <code>Control</code>. The next code snippet calculates these effects per person, accounting for the intervention order reversal for subjects 4 and 12.</p>
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit0</span>, <span class="va">data</span>, x <span class="op">=</span> <span class="st">"knots"</span>, shape <span class="op">=</span> <span class="st">"wide"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">control</span> <span class="op">&lt;-</span> <span class="va">prd</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span></span>
<span><span class="va">diet</span> <span class="op">&lt;-</span> <span class="va">prd</span><span class="op">[</span>, <span class="fl">3</span><span class="op">]</span></span>
<span><span class="va">diet</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">12</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">prd</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">12</span><span class="op">)</span>, <span class="fl">4</span><span class="op">]</span></span>
<span><span class="va">activity</span> <span class="op">&lt;-</span> <span class="va">prd</span><span class="op">[</span>, <span class="fl">4</span><span class="op">]</span></span>
<span><span class="va">activity</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">12</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">prd</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">12</span><span class="op">)</span>, <span class="fl">3</span><span class="op">]</span></span>
<span><span class="va">effects</span> <span class="op">&lt;-</span> <span class="fl">1000</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  diet_control <span class="op">=</span> <span class="va">diet</span> <span class="op">-</span> <span class="va">control</span>,</span>
<span>  activity_control <span class="op">=</span> <span class="va">activity</span> <span class="op">-</span> <span class="va">control</span>,</span>
<span>  activity_diet <span class="op">=</span> <span class="va">activity</span> <span class="op">-</span> <span class="va">diet</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">effects</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    diet_control activity_control activity_diet</span></span>
<span><span class="co">## 1           174              179             5</span></span>
<span><span class="co">## 2         -1055            -1759          -704</span></span>
<span><span class="co">## 3           961             1045            84</span></span>
<span><span class="co">## 4         -1846             -723          1123</span></span>
<span><span class="co">## 5           371              149          -223</span></span>
<span><span class="co">## 6         -1582            -3269         -1687</span></span>
<span><span class="co">## 7          -158             -514          -356</span></span>
<span><span class="co">## 8          -614            -1057          -443</span></span>
<span><span class="co">## 9         -1166            -2039          -872</span></span>
<span><span class="co">## 10         -594            -1210          -616</span></span>
<span><span class="co">## 11           63             -559          -621</span></span>
<span><span class="co">## 12        -1322             -425           897</span></span></code></pre>
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">effects</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##     diet_control activity_control    activity_diet </span></span>
<span><span class="co">##             -564             -848             -284</span></span></code></pre>
<p>The average weight under caloric restriction is 564 grams lower than control. We find a 848 grams lower body weight when we stimulate physical activity. We could be tempted to believe that exercise reduces weight more than a diet. However, except for subjects 4 and 12, the investigators administered the activity treatment after the diet treatment, so the difference relative to control represents the <em>combined effect</em> of diet and activity on body weight. It might be more relevant to study the difference between training and diet (third column). The average difference of -284 grams suggests that diet is more effective than physical activity. Realise that also this estimate is not entirely satisfactory. First, subjects 4 and 12 had a reversed administration, so the difference does not make sense for them. Second, as anyone who has tried to lose weight can attest, “quick wins” are more likely in period 2 than in period 3. Although it is possible to account for these sequence effects, there is a more intuitive analysis of the data.</p>
</div>
<div class="section level4" number="6.3.2">
<h4 id="broken-stick-model-1">
<span class="header-section-number">6.3.2</span> Broken stick model<a class="anchor" aria-label="anchor" href="#broken-stick-model-1"></a>
</h4>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ctl_lmer</span> <span class="op">&lt;-</span> <span class="fu">lme4</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmerControl.html" class="external-link">lmerControl</a></span><span class="op">(</span></span>
<span>  check.conv.grad <span class="op">=</span> <span class="fu">lme4</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmerControl.html" class="external-link">.makeCC</a></span><span class="op">(</span><span class="st">"warning"</span>, tol <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">fit1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/brokenstick.html">brokenstick</a></span><span class="op">(</span><span class="va">body_weight</span> <span class="op">~</span> <span class="va">day</span> <span class="op">|</span> <span class="va">subject</span>, <span class="va">data</span>,</span>
<span>                    knots <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">21</span>, <span class="fl">42</span>, <span class="fl">63</span><span class="op">)</span>, method <span class="op">=</span> <span class="st">"lmer"</span>,</span>
<span>                    control <span class="op">=</span> <span class="va">ctl_lmer</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fit1</span>, size_y <span class="op">=</span> <span class="fl">0</span>, color_y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"grey"</span>, <span class="fl">2</span><span class="op">)</span>, what <span class="op">=</span> <span class="st">"all"</span>,</span>
<span>     size_yhat <span class="op">=</span> <span class="fl">1.5</span>, scales <span class="op">=</span> <span class="st">"free_y"</span>, ,</span>
<span>     xlab <span class="op">=</span> <span class="st">"Day"</span>, ylab <span class="op">=</span> <span class="st">"Body weight (KG)"</span>,</span>
<span>     n_plot <span class="op">=</span> <span class="fl">12</span>, ncol <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:weightloss-slope"></span>
<img src="manual_files/figure-html/weightloss-slope-1.png" alt="Broken stick model. Observed and fitted trajectories for a model that summarises each experimental period by a line. The slope indicates the change during the period. The model connects lines from adjacent periods and provides an informative description of the data." width="100%"><p class="caption">
Figure 13: Broken stick model. Observed and fitted trajectories for a model that summarises each experimental period by a line. The slope indicates the change during the period. The model connects lines from adjacent periods and provides an informative description of the data.
</p>
</div>
<p>Figure <a href="#fig:weightloss-slope">13</a> shows the same data as in Figure <a href="#fig:weightloss-constant">12</a> but now fitted by the linear broken stick model. This model also suggests a persistent downward trend for subject 9 and an absence of trend for participants 1 and 5. Also, the model now correctly identifies the prominent zig-zag patterns for persons 2, 4, 8 and 11 across the three experimental periods.</p>
<p>A natural way to quantify the effect of the intervention is to calculate the before-after estimate per period. For example, for person 2 the effect of diet is <span class="math inline">\(60,933 - 63,671 = -2,738\)</span> grams, of activity is <span class="math inline">\(62,635 - 60,933 = +1,701\)</span> grams. The following code accounts for the alternate treatment ordering of subjects 4 and 12.</p>
<div class="sourceCode" id="cb70"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit1</span>, <span class="va">data</span>, x <span class="op">=</span> <span class="st">"knots"</span>, shape <span class="op">=</span> <span class="st">"wide"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">control</span> <span class="op">&lt;-</span> <span class="va">prd</span><span class="op">[</span>, <span class="fl">3</span><span class="op">]</span> <span class="op">-</span> <span class="va">prd</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span></span>
<span><span class="va">diet</span> <span class="op">&lt;-</span> <span class="va">prd</span><span class="op">[</span>, <span class="fl">4</span><span class="op">]</span> <span class="op">-</span> <span class="va">prd</span><span class="op">[</span>, <span class="fl">3</span><span class="op">]</span></span>
<span><span class="va">diet</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">12</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">prd</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">12</span><span class="op">)</span>, <span class="fl">5</span><span class="op">]</span> <span class="op">-</span> <span class="va">prd</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">12</span><span class="op">)</span>, <span class="fl">4</span><span class="op">]</span></span>
<span><span class="va">activity</span> <span class="op">&lt;-</span> <span class="va">prd</span><span class="op">[</span>, <span class="fl">5</span><span class="op">]</span> <span class="op">-</span> <span class="va">prd</span><span class="op">[</span>, <span class="fl">4</span><span class="op">]</span></span>
<span><span class="va">activity</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">12</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">prd</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">12</span><span class="op">)</span>, <span class="fl">4</span><span class="op">]</span> <span class="op">-</span> <span class="va">prd</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">12</span><span class="op">)</span>, <span class="fl">3</span><span class="op">]</span></span>
<span><span class="va">effects</span> <span class="op">&lt;-</span> <span class="fl">1000</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  control <span class="op">=</span> <span class="va">control</span>,</span>
<span>  diet <span class="op">=</span> <span class="va">diet</span>,</span>
<span>  activity <span class="op">=</span> <span class="va">activity</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">effects</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    control  diet activity</span></span>
<span><span class="co">## 1     -303   459     -411</span></span>
<span><span class="co">## 2       95 -2738     1701</span></span>
<span><span class="co">## 3      847   479      570</span></span>
<span><span class="co">## 4      117   682    -2168</span></span>
<span><span class="co">## 5      637  -606      659</span></span>
<span><span class="co">## 6     -756 -2594     -833</span></span>
<span><span class="co">## 7      251  -783      277</span></span>
<span><span class="co">## 8     -297 -1112      349</span></span>
<span><span class="co">## 9    -1006 -1389     -424</span></span>
<span><span class="co">## 10    -190 -1096     -290</span></span>
<span><span class="co">## 11    -908   929    -2573</span></span>
<span><span class="co">## 12    -902  -423     -468</span></span></code></pre>
<div class="sourceCode" id="cb72"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">effects</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  control     diet activity </span></span>
<span><span class="co">##     -201     -683     -301</span></span></code></pre>
<p>The average effects are -201 grams (control), -683 grams (diet) and -301 grams (activity). Although not statistically significant, the slight decrease of 201 grams during the control period suggests that weight monitoring by itself may motivate the participant to lose weight. The effect estimates for diet and activity are of similar magnitude as before. Still, they can be sizeable discrepancies at the individual level, e.g., for subjects 2 or 11.</p>
<p>We may obtain a simple estimate of the sequence effect by linear regression as</p>
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fl">1000</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">diet</span>, <span class="va">activity</span><span class="op">)</span>,</span>
<span>                 activity <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>,</span>
<span>                 activity2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">3</span><span class="op">)</span>, <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">7</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span>  <span class="fl">1</span>, data <span class="op">=</span> <span class="va">df</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## (Intercept) </span></span>
<span><span class="co">##        -492</span></span></code></pre>
<div class="sourceCode" id="cb76"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">activity</span>, data <span class="op">=</span> <span class="va">df</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## (Intercept)    activity </span></span>
<span><span class="co">##        -683         382</span></span></code></pre>
<div class="sourceCode" id="cb78"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">activity</span> <span class="op">+</span> <span class="va">activity2</span>, data <span class="op">=</span> <span class="va">df</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## (Intercept)    activity   activity2 </span></span>
<span><span class="co">##        -662         382        -123</span></span></code></pre>
<p>Variable <code>y</code> is the change in grams observed during periods 2 and 3, <code>activity</code> is a dummy variable for treatment (0 = diet, 1 = activity) and <code>activity2</code> is a dummy variable indicating that activity occurred in period 2 (0 = no, 1 = yes). The average loss in weight per period is equal to 492 grams. The second model shows that diet reduces body weight more than activity (by 382 grams). The third model indicates that activity applied in period 2 is more effective than in period 3, as it reduces weight with an additional 123 grams. Of course, bear in mind that we calculated these results on very few individuals. Hence, they are sensitive to substantial estimation error.</p>
<p>This application demonstrates that the broken stick model can effectively capture rapid linear changes in experiments. Even though the actual timing of the observations may be erratic, it is easy to define, interpret and calculate intuitive effect estimates at the individual level. Note that the analysis here assumed an instantaneous effect of the interventions. If we expect a delay, then we may right-shift the knots by a few days and re-estimate the broken stick model. By varying the number of days, we may be able to detect the optimal delay factor.</p>
</div>
</div>
<div class="section level3" number="6.4">
<h3 id="curve-interpolation">
<span class="header-section-number">6.4</span> Curve interpolation<a class="anchor" aria-label="anchor" href="#curve-interpolation"></a>
</h3>
<div class="section level4" number="6.4.1">
<h4 id="problem">
<span class="header-section-number">6.4.1</span> Problem<a class="anchor" aria-label="anchor" href="#problem"></a>
</h4>
<p>A growth chart visualises the individual trajectory relative to a set of centile lines. We may store a centile line as a set of coordinates with a relatively dense age grid. If we connect the adjacent vertices by a straight line, the centile will appear as smooth in time. However, this plotting method runs into trouble when ages are wide apart. This section shows how we can create a realistic interpolation with sparse time data.</p>
</div>
<div class="section level4" number="6.4.2">
<h4 id="interpolation-in-measurement-scale">
<span class="header-section-number">6.4.2</span> Interpolation in measurement scale<a class="anchor" aria-label="anchor" href="#interpolation-in-measurement-scale"></a>
</h4>
<p>Suppose we measured the length of a boy at the ages of 1 month (52.6 cm) and 14 months (81.7 cm). The following code block uses the <code><a href="https://rdrr.io/pkg/AGD/man/y2z.html" class="external-link">AGD::y2z()</a></code> function to convert the measurements to SDS relative to the reference of the Fourth Dutch Growth Study.</p>
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">boy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">14</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">52.6</span>, <span class="fl">81.7</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ref</span> <span class="op">&lt;-</span> <span class="fu">AGD</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/AGD/man/References-NL4.html" class="external-link">nl4.hgt</a></span></span>
<span><span class="va">boy</span><span class="op">$</span><span class="va">z</span> <span class="op">&lt;-</span> <span class="fu">AGD</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/AGD/man/y2z.html" class="external-link">y2z</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">boy</span><span class="op">$</span><span class="va">y</span>, x <span class="op">=</span> <span class="va">boy</span><span class="op">$</span><span class="va">x</span><span class="op">/</span><span class="fl">12</span>, sex <span class="op">=</span> <span class="st">"M"</span>, ref <span class="op">=</span> <span class="va">ref</span><span class="op">)</span></span>
<span><span class="va">boy</span><span class="op">$</span><span class="va">z</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] -0.980  0.994</span></span></code></pre>
<div class="figure">
<span style="display:block;" id="fig:interpolationplots"></span>
<img src="manual_files/figure-html/interpolationplots-1.png" alt="The effect of three interpolation methods (linear in cm (blue), linear in SDS (red), and by the broken stick model (green)). For each method, the vertical line indicates the age at which the interpolated curve crosses the mean of the age-conditional length distribution. Both linear methods results in unrealistic trajectories at intermediate ages. For example, all points on the blue lines are too low. Interpolation by the broken stick method is the only alternative that correctly describes faster growth during the first months." width="100%"><p class="caption">
Figure 14: The effect of three interpolation methods (linear in cm (blue), linear in SDS (red), and by the broken stick model (green)). For each method, the vertical line indicates the age at which the interpolated curve crosses the mean of the age-conditional length distribution. Both linear methods results in unrealistic trajectories at intermediate ages. For example, all points on the blue lines are too low. Interpolation by the broken stick method is the only alternative that correctly describes faster growth during the first months.
</p>
</div>
<p>During the period the boy grows from moderately short (about -1.0 SD at month 1) to relatively tall (about +1.0 SD at month 14). Figure <a href="#fig:interpolationplots">14</a> shows the usual representation of the growth chart with a straight line drawn between the two values. Due to the concave shape of the centile lines, the straight line that connects the two measurements starts at -1.0 SD, then touches the -2.0 SD centile around 4.5 months, is back at -1.0 SD at the age of 7.5 months, crosses the 0.0 SD line at 11.5 months, and ends at +1.0 SD at 14 months. The right hand side graph portrays the interpolated growth curve in the SDS scale. Since length growth during infancy is not linear in time, finding a real growth curve like this is extremely unlikely. Since we have just two data points smoothing the data does not help either.</p>
</div>
<div class="section level4" number="6.4.3">
<h4 id="interpolation-in-the-sds-scale">
<span class="header-section-number">6.4.3</span> Interpolation in the SDS scale<a class="anchor" aria-label="anchor" href="#interpolation-in-the-sds-scale"></a>
</h4>
<p>A first alternative is to apply the linear interpolation in the SDS scale. This option is attractive because centile lines are straight in the SDS scale. The red curves in Figure <a href="#fig:interpolationplots">14</a> illustrate interpolation in the SDS scale. By definition, the line that connects the measurements is straight in the SDS score scale. In the cm scale, the representation is more realistic and more pleasing to the eye. The curve crosses the 0 SD line halfway, at 7.5 months.</p>
<p>While this approach is a considerable improvement over interpolation in the <span class="math inline">\(Y\)</span>-scale, it is still not ideal. The assumption underlying this interpolation is that the SDS increment is constant across time. This assumption is false here, however. Since length growth is faster during the first half-year, we expect that the larger share of the increment to occur during the earlier months. In other words, the cross-over point at 7.5 months is too late.</p>
</div>
<div class="section level4" number="6.4.4">
<h4 id="interpolation-by-the-broken-stick-model">
<span class="header-section-number">6.4.4</span> Interpolation by the broken stick model<a class="anchor" aria-label="anchor" href="#interpolation-by-the-broken-stick-model"></a>
</h4>
<p>The second alternative is a model-based interpolation. Assuming the availability of a fitted broken stick model, we specify a time grid, say twice a month, and predict the length at these ages given the data from the observed trajectory. The expected curve represents the most likely values under the model at the intermediate ages. The following code calculates the relevant estimates from the <code>fit_200</code> fitted model:</p>
<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">age</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">14</span>, <span class="fl">0.5</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">age</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">z</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">boy</span><span class="op">$</span><span class="va">z</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>; <span class="va">z</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">z</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">boy</span><span class="op">$</span><span class="va">z</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span><span class="va">zout</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit_200</span>, x <span class="op">=</span> <span class="va">age</span><span class="op">/</span><span class="fl">12</span>, y <span class="op">=</span> <span class="va">z</span>, shape <span class="op">=</span> <span class="st">"vector"</span><span class="op">)</span></span>
<span><span class="va">yout</span> <span class="op">&lt;-</span> <span class="fu">AGD</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/AGD/man/z2y.html" class="external-link">z2y</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">age</span><span class="op">/</span><span class="fl">12</span>, z <span class="op">=</span> <span class="va">zout</span>, ref <span class="op">=</span> <span class="va">ref</span><span class="op">)</span></span></code></pre></div>
<p>The green curve in Figure <a href="#fig:interpolationplots">14</a> shows the results of the broken stick model. The curve in the measurement scale represents the most likely course according to the broken stick model. Note that now the child realises the larger share of the change during the first few months. As a result, the cross-over point where the predicted value intersects the 0 SD line is now around 4.5 months, considerably earlier than obtained by the two other interpolation methods. The right hand side plot confirms the steeper slope in the first part. Note that this method treats rising and declining curves alike. For example, if the boy’s length would be 57 cm at month 1 (+1.0 SD) and 76 cm at month 14 (-1.0 SD), the cross-over point would also be around 4.5 months (not shown).</p>
<p>Observe that this method leaves the world of pure interpolation and moves towards an approximation of the data by a model. The observed and predicted lengths are not exactly equal. The difference is so small that we may hardly notice the discrepancy when plotted in the measurement scale, but it is more conspicuous when plotted as SDS. Thanks to the added knowledge of the child growth process, the broken stick model provides the most realistic expected trajectory at the intermediate ages.</p>
</div>
</div>
<div class="section level3" number="6.5">
<h3 id="multiple-imputation">
<span class="header-section-number">6.5</span> Multiple imputation<a class="anchor" aria-label="anchor" href="#multiple-imputation"></a>
</h3>
<p>Remember from Section <a href="#prediction">5.5</a> that the broken stick estimates are conditional means. We may be tempted to analyse these estimates as if they were “just data”, but they do not have the same variability as the real data. For example, suppose we calculate the correlation matrix of the broken stick estimates. We know that the values in this matrix will exceed those from the underlying observed data. Not accounting for this fact leads to overconfident predictions and results that are too good to be true.</p>
<p>Multiple imputation <span class="citation">(Rubin 1987; van Buuren 2018b)</span> restores variability by adding noise. We may fit standard complete-data software to the imputed data, and obtain valid regression weights, confidence intervals and <span class="math inline">\(p\)</span> values under a wide range of conditions.</p>
<p>By default, method <code>kr</code> executes 200 iterations of the Kasim-Raudenbush sampler. The <code>nimp</code> argument to the <code><a href="../../reference/control_kr.html">control_kr()</a></code> function specifies the number of multiple imputations. The following call to the <code><a href="../../reference/brokenstick.html">brokenstick()</a></code> function creates and plots 20 imputations for each missing outcome (<code>hgt_z</code> here).</p>
<div class="sourceCode" id="cb83"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">knots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">6</span>, <span class="fl">9</span>, <span class="fl">12</span>, <span class="fl">15</span>, <span class="fl">18</span>, <span class="fl">24</span><span class="op">)</span><span class="op">/</span><span class="fl">12</span>, <span class="fl">4</span><span class="op">)</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">smocc_200</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">smocc_200</span><span class="op">$</span><span class="va">hgt_z</span><span class="op">)</span>, <span class="op">]</span>,</span>
<span>                  <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">smocc_200</span><span class="op">$</span><span class="va">id</span><span class="op">)</span>, age <span class="op">=</span> <span class="va">knots</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">fit_kr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/brokenstick.html">brokenstick</a></span><span class="op">(</span><span class="va">hgt_z</span> <span class="op">~</span> <span class="va">age</span> <span class="op">|</span> <span class="va">id</span>, data <span class="op">=</span> <span class="va">data</span>,</span>
<span>                      knots <span class="op">=</span> <span class="va">knots</span>,</span>
<span>                      nimp <span class="op">=</span> <span class="fl">20</span>, seed <span class="op">=</span> <span class="fl">15244</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fit_kr</span>, show <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">TRUE</span>, <span class="cn">FALSE</span>, <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>     group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10001</span>, <span class="fl">10005</span>, <span class="fl">10022</span><span class="op">)</span>,</span>
<span>     xlab <span class="op">=</span> <span class="st">"Age (years)"</span>, ylab <span class="op">=</span> <span class="st">"Length (SDS)"</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:mi-code"></span>
<img src="manual_files/figure-html/mi-code-1.png" alt="Observed data (blue) and 20 imputed trajectories (grey) for three subjects from the SMOCC data. Imputed trajectories are possible realizations of the observed data in the hypothetical case that the observations are made at the specified break ages. Note that the pattern of child 10001 is more certain than of child 10022." width="100%"><p class="caption">
Figure 15: Observed data (blue) and 20 imputed trajectories (grey) for three subjects from the SMOCC data. Imputed trajectories are possible realizations of the observed data in the hypothetical case that the observations are made at the specified break ages. Note that the pattern of child 10001 is more certain than of child 10022.
</p>
</div>
<p>Figure <a href="#fig:mi-code">15</a> displays the observed data from three persons plotted on top of 20 imputed trajectories. The within-person within-time average over the grey trajectories approximates to the broken stick estimate (not shown here). The observed curve in each panel occasionally strays towards the boundaries of the grey bundle. This behaviour is as expected and indicates that the blue curve performs like a grey curve.</p>
<p>Section <a href="#time-to-time-correlations">6.2</a> showed how we can estimate the time-to-time correlation matrix. An alternative way is to calculate it from the imputed data, as follows:</p>
<div class="sourceCode" id="cb84"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cormat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">fit_kr</span><span class="op">$</span><span class="va">imp</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">knots</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dimnames.html" class="external-link">dimnames</a></span><span class="op">(</span><span class="va">cormat</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">knots</span>, <span class="va">knots</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">cormat</span>, <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##           0 0.0833 0.1667 0.25  0.5 0.75    1 1.25  1.5    2</span></span>
<span><span class="co">## 0      1.00   0.68   0.70 0.63 0.47 0.43 0.38 0.33 0.32 0.24</span></span>
<span><span class="co">## 0.0833 0.68   1.00   0.81 0.79 0.70 0.58 0.53 0.51 0.50 0.39</span></span>
<span><span class="co">## 0.1667 0.70   0.81   1.00 0.81 0.73 0.60 0.52 0.49 0.52 0.42</span></span>
<span><span class="co">## 0.25   0.63   0.79   0.81 1.00 0.75 0.64 0.58 0.56 0.53 0.46</span></span>
<span><span class="co">## 0.5    0.47   0.70   0.73 0.75 1.00 0.83 0.81 0.73 0.75 0.65</span></span>
<span><span class="co">## 0.75   0.43   0.58   0.60 0.64 0.83 1.00 0.84 0.77 0.77 0.71</span></span>
<span><span class="co">## 1      0.38   0.53   0.52 0.58 0.81 0.84 1.00 0.84 0.81 0.76</span></span>
<span><span class="co">## 1.25   0.33   0.51   0.49 0.56 0.73 0.77 0.84 1.00 0.84 0.82</span></span>
<span><span class="co">## 1.5    0.32   0.50   0.52 0.53 0.75 0.77 0.81 0.84 1.00 0.83</span></span>
<span><span class="co">## 2      0.24   0.39   0.42 0.46 0.65 0.71 0.76 0.82 0.83 1.00</span></span></code></pre>
<p>Another important application of the multiply-imputed curves is to obtain correct confidence intervals and <span class="math inline">\(p\)</span> values for estimates of scientific interest. The most convenient way to do this is to convert the <code>brokenstick</code> object into an object of class <code>mids</code>, as defined by the <strong>mice</strong> package. The <strong>brokenstick</strong> package currently has no features that perform the conversion.</p>
</div>
<div class="section level3" number="6.6">
<h3 id="curve-matching">
<span class="header-section-number">6.6</span> Curve matching<a class="anchor" aria-label="anchor" href="#curve-matching"></a>
</h3>
<p>Curve matching <span class="citation">(van Buuren 2014)</span> is a tool to assist in the interpretation and prediction of individual growth curves. The idea is as follows. Suppose we measure the growth of the target child up to half a year and plot the measurements onto his or her growth chart. Curve matching is a nearest-neighbour technique that relies on historical growth data. It finds, say, ten other children who are similar to the target child, and adds the curves of those matches to the child’s chart. If the matching is done right, then the bundle of historic growth curves suggests how the target child will develop in the future.</p>
<div class="figure">
<span style="display:block;" id="fig:james"></span>
<img src="figures/JAMES_tryout.png" alt="Curve matching. Predict infant length at 14 months given the length data up to 6 months using 10 matches. The red curve is the observed data for the target child. The bundle of grey curves are observed length curves from other children that match the trajectory of the target child up to month 6. The blue line represents the most likely future trajectory for the target child towards month 14. The variation between the grey curves represents the amount of uncertainty of the trajectory prediction." width="100%"><p class="caption">
Figure 16: Curve matching. Predict infant length at 14 months given the length data up to 6 months using 10 matches. The red curve is the observed data for the target child. The bundle of grey curves are observed length curves from other children that match the trajectory of the target child up to month 6. The blue line represents the most likely future trajectory for the target child towards month 14. The variation between the grey curves represents the amount of uncertainty of the trajectory prediction.
</p>
</div>
<p>Figure <a href="#fig:james">16</a> is a screen shot of a demo Shiny app of the <a href="https://tnochildhealthstatistics.shinyapps.io/james_tryout/" class="external-link">Joint Automatic Measurement and Evaluation System (JAMES)</a>. The red curve corresponds to five measurements of the target child made during the first six months. The ten grey curves are historic growth curves from the ten matched children. We may define similarity in many ways. Here we use a linear model to predict length at the age of 14m from previous length data. The distance between the target child and another child is equal to the difference between their predicted values. The procedure lifts the data of the matches from the database, and plots the observed growth curves onto the chart as grey curves. This method for finding nearest neighbours is known as <em>predictive mean matching</em> and has grown into a powerful technique for missing data <span class="citation">(van Buuren 2018b)</span>. The bundle of grey curves indicates possible future trajectories of the target child. The wider the bundle, the more uncertain future growth will be <span class="citation">(Toet et al. 2019)</span>. The mean of the bundle is the most likely path. Graphically it is the dotted blue curve between the last measurement and the age of the outcome.</p>
<p>Let’s look at a numerical example. We split the data into one target child and 199 donor children, and fit a broken stick model to the donor set.</p>
<div class="sourceCode" id="cb86"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">donor_data</span> <span class="op">&lt;-</span> <span class="va">smocc_200</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">id</span> <span class="op">!=</span> <span class="st">"10001"</span><span class="op">)</span></span>
<span><span class="va">target_data</span> <span class="op">&lt;-</span> <span class="va">smocc_200</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">id</span> <span class="op">==</span> <span class="st">"10001"</span> <span class="op">&amp;</span> <span class="va">age</span> <span class="op">&lt;</span> <span class="fl">0.51</span><span class="op">)</span></span>
<span></span>
<span><span class="va">knots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">6</span>, <span class="fl">9</span>, <span class="fl">12</span>, <span class="fl">15</span>, <span class="fl">18</span>, <span class="fl">24</span><span class="op">)</span><span class="op">/</span><span class="fl">12</span>, <span class="fl">4</span><span class="op">)</span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/brokenstick.html">brokenstick</a></span><span class="op">(</span><span class="va">hgt_z</span> <span class="op">~</span> <span class="va">age</span> <span class="op">|</span> <span class="va">id</span>, data <span class="op">=</span> <span class="va">donor_data</span>,</span>
<span>                   knots <span class="op">=</span> <span class="va">knots</span>, seed <span class="op">=</span> <span class="fl">15244</span><span class="op">)</span></span></code></pre></div>
<p>All timepoints from the donor data enter the broken stick model. Note that the <code>target_data</code> contains only observations from the first five visits.</p>
<p>We now fit the prediction model on the child-level donor data. The prediction model contains the broken stick estimates for length SDS up to 6 months, as well as sex, gestational age and birth weight as covariates.</p>
<div class="sourceCode" id="cb87"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">covariates</span> <span class="op">&lt;-</span> <span class="va">donor_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">bse</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit</span>, <span class="va">donor_data</span>, x <span class="op">=</span> <span class="st">"knots"</span>, shape <span class="op">=</span> <span class="st">"wide"</span><span class="op">)</span></span>
<span><span class="va">donors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html" class="external-link">bind_cols</a></span><span class="op">(</span><span class="va">covariates</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">bse</span>, <span class="op">-</span><span class="va">id</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">`1.25`</span> <span class="op">~</span> <span class="va">`0`</span> <span class="op">+</span> <span class="va">`0.0833`</span> <span class="op">+</span> <span class="va">`0.1667`</span> <span class="op">+</span> <span class="va">`0.25`</span> <span class="op">+</span> <span class="va">`0.5`</span></span>
<span>            <span class="op">+</span> <span class="va">sex</span> <span class="op">+</span> <span class="va">ga</span> <span class="op">+</span> <span class="va">bw</span>, data <span class="op">=</span> <span class="va">donors</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Call:</span></span>
<span><span class="co">## lm(formula = `1.25` ~ `0` + `0.0833` + `0.1667` + `0.25` + `0.5` + </span></span>
<span><span class="co">##     sex + ga + bw, data = donors)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Residuals:</span></span>
<span><span class="co">##     Min      1Q  Median      3Q     Max </span></span>
<span><span class="co">## -1.3328 -0.2567 -0.0151  0.2634  1.4653 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Coefficients:</span></span>
<span><span class="co">##              Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co">## (Intercept)  4.87e-01   8.99e-01    0.54    0.589    </span></span>
<span><span class="co">## `0`          6.74e-02   5.33e-02    1.27    0.207    </span></span>
<span><span class="co">## `0.0833`     5.89e-02   8.69e-02    0.68    0.499    </span></span>
<span><span class="co">## `0.1667`    -2.55e-01   9.92e-02   -2.57    0.011 *  </span></span>
<span><span class="co">## `0.25`      -2.16e-01   1.07e-01   -2.01    0.046 *  </span></span>
<span><span class="co">## `0.5`        1.21e+00   7.54e-02   16.07   &lt;2e-16 ***</span></span>
<span><span class="co">## sexmale      9.13e-02   6.42e-02    1.42    0.157    </span></span>
<span><span class="co">## ga          -7.05e-03   2.25e-02   -0.31    0.754    </span></span>
<span><span class="co">## bw          -7.53e-05   1.09e-04   -0.69    0.491    </span></span>
<span><span class="co">## ---</span></span>
<span><span class="co">## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Residual standard error: 0.436 on 190 degrees of freedom</span></span>
<span><span class="co">## Multiple R-squared:  0.777,  Adjusted R-squared:  0.767 </span></span>
<span><span class="co">## F-statistic: 82.5 on 8 and 190 DF,  p-value: &lt;2e-16</span></span></code></pre>
<p>The next step is to extract model predictions for both donors and target and find the ten closest donors.</p>
<div class="sourceCode" id="cb89"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">donors_pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">donors_pred</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">donors</span><span class="op">$</span><span class="va">id</span></span>
<span></span>
<span><span class="va">target</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html" class="external-link">bind_cols</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice</a></span><span class="op">(</span><span class="va">target_data</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit</span>, <span class="va">target_data</span>, x <span class="op">=</span> <span class="st">"knots"</span>, shape <span class="op">=</span> <span class="st">"wide"</span><span class="op">)</span>, <span class="op">-</span><span class="va">id</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">target_pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">model</span>, newdata <span class="op">=</span> <span class="va">target</span><span class="op">)</span></span>
<span></span>
<span><span class="va">matches</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">donors_pred</span> <span class="op">-</span> <span class="va">target_pred</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span></span>
<span><span class="va">matches</span></span></code></pre></div>
<pre><code><span><span class="co">##   11013   10032   11035   10093   10051   11063   11086   11083   11102 </span></span>
<span><span class="co">## 0.00422 0.00578 0.01833 0.01889 0.02507 0.02657 0.03069 0.03744 0.05118 </span></span>
<span><span class="co">##   11049 </span></span>
<span><span class="co">## 0.05922</span></span></code></pre>
<p>The above steps contain the basic ingredients of the <code>find_matches()</code> function in the <strong>chartplotter</strong> package <span class="citation">(van Buuren 2021a)</span>. Finally, let us study the observed and fitted trajectories of the ten matches.</p>
<div class="sourceCode" id="cb91"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">matches</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fit</span>, group <span class="op">=</span> <span class="va">ids</span>,</span>
<span>     xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1.4</span><span class="op">)</span>, size_y <span class="op">=</span> <span class="fl">1</span>, size_yhat <span class="op">=</span> <span class="fl">0</span>,</span>
<span>     xlab <span class="op">=</span> <span class="st">"Age (years)"</span>, ylab <span class="op">=</span> <span class="st">"Length (SDS)"</span>,</span>
<span>     ncol <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:cm4"></span>
<img src="manual_files/figure-html/cm4-1.png" alt="Curve matching. Observed (blue) and fitted (red) trajectories of the 10 closest matches for subject 10001. Fitted values at the outcome age (1.25y) are close to the predicted value for the target child (0.101 SD)." width="100%"><p class="caption">
Figure 17: Curve matching. Observed (blue) and fitted (red) trajectories of the 10 closest matches for subject 10001. Fitted values at the outcome age (1.25y) are close to the predicted value for the target child (0.101 SD).
</p>
</div>
<p>The ten trajectories are all are close to the prediction (0.101 SD) for the target child at the age of 1.25 years. Note that this does not guarantee that the histories are identical. Most matches have relatively flat curves, but a few (10051, 11023, 11086) show striking rising patterns. Nevertheless, these candidates are the best in terms of the model prediction.</p>
<p>If we wish the curves of the matches during the first six months to be closer to the target case, we could consider alternative metrics. A simple measure is the sum of squares differences of the broken stick estimates. Such a selection may be visually more pleasing, at the expense of prediction accuracy. On the other hand, we are less tied to setting one particular future time point, so other measures may work better when “future” is more vaguely defined as a time interval. It is still an open research question where we strike a balance. Whatever the objectives of preferences from the user might be, the curve matching methodology, as illustrated here, has tremendous flexibility and is easy to adapt.</p>
</div>
</div>
<div class="section level2" number="7">
<h2 id="conclusion">
<span class="header-section-number">7</span> Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<div class="section level3" number="7.1">
<h3 id="overview-1">
<span class="header-section-number">7.1</span> Overview<a class="anchor" aria-label="anchor" href="#overview-1"></a>
</h3>
<p>This paper introduces a new approach to solve the problem of irregular longitudinal data. The method absorbs the time-dependent information into a set of broken stick estimates at the subject level. The primary advantage is that it simplifies the analysis by splitting the modelling problem into two steps. First, solve the timing problem, and then solve the substantive/scientific problem. The method is mathematically simple, conceptually appealing, yet principled.</p>
</div>
<div class="section level3" number="7.2">
<h3 id="distinctive-features">
<span class="header-section-number">7.2</span> Distinctive features<a class="anchor" aria-label="anchor" href="#distinctive-features"></a>
</h3>
<p>The assumptions of the model cover many cases of practical interest: a straight line between breakpoints, a multivariate normal distribution for the random effects, and the MAR assumption including future data. Despite the relatively low number of model parameters, it is possible to obtain a close fit to the data, sometimes almost up to perfect reconstruction (c.f., Figure <a href="#fig:obspred">7</a>). There is no need to specify equidistant breakpoints. Applications in human growth and development are often more natural using non-uniformly spaced knots, which is very easy to model. Many people find it easier to understand the raw data values than the summaries. The broken stick model invites visualisation of the actual data points against time and makes it is easy to portray uncertainty as a bundle of curves. Such direct visualisation options contribute to the explainable and responsible personalised analyses that appeal to a broad user group.</p>
</div>
<div class="section level3" number="7.3">
<h3 id="current-limitations">
<span class="header-section-number">7.3</span> Current limitations<a class="anchor" aria-label="anchor" href="#current-limitations"></a>
</h3>
<p>The broken stick model, as presented here, uses just three variables: time, measurement and group. This design choice simplifies interpretation and estimation. The lack of covariates in the model implies that the transformation from irregular data to repeated measures is identical for every subject. As long as the residual error is small, the relations with not-in-the-model variables thus remain intact. The possibility to include covariates in a second-round enhances modular modern analytic pipelines. Yet, some will prefer the direct estimation of all effects in one more extensive analysis. The current package does not support covariates.</p>
<p>The broken stick method is intended for aligning observations, where every individual has the same number and location of breakpoints. The technique assumes that subjects share the same time axis. In our applications, synchronisation at the start was most natural (e.g., birth, start of experiment), which is easy to do. In some cases, one might wish an anchor in the middle, e.g., at menarche, which occurs at different ages for different individuals <span class="citation">(Naumova, Must, and Laird 2001)</span>, and the scientific interest is on what happens before and after the anchor. It could also make sense to fasten the end, e.g., at graduation or death. The choice of the anchor may matter less for cyclic processes. For example, in weekly data it may be more important to anchor on day of the week than on the actual date or age. Irrespective of the actual timings of the observed data, the number and location of breakpoints is identical for all subjects. The method is less suited for applications where there is no sensible common time axis, or when the breakpoints should vary between individuals.</p>
</div>
<div class="section level3" number="7.4">
<h3 id="software">
<span class="header-section-number">7.4</span> Software<a class="anchor" aria-label="anchor" href="#software"></a>
</h3>
<p>The Kasim-Raudenbush sampler <span class="citation">(Kasim and Raudenbush 1998)</span> is both fast and flexible. It produces estimates of the residual error variance per subject, can accommodate for correlation models and supports multiple imputation out-of-the-box. More research needed to establish its statistical properties especially compared to <code>lmer()</code> and other established methods. It would also be interesting to study the suitability of the correlation models implemented in the <strong>lme4qtl</strong> package <span class="citation">(Ziyatdinov et al. 2018)</span>. As no training data are stored, instances of the light <code>brokenstick</code> class objects are tiny, often 15–20 Kb.</p>
<p>Features not implemented, but that could be useful in future versions include a separate <code>impute()</code> function that inputs class <code>brokenstick</code> and returns class <code>mids</code>, a Trelliscope <span class="citation">(Hafen and Schloerke 2020)</span> viewer to quickly peruse hundreds of individuals model fits, an extension to multivariate time-varying and child-level data, and a generalisation to <code>degree &gt; 1</code> to support quadratic and cubic splines.</p>
</div>
<div class="section level3" number="7.5">
<h3 id="computational-setup">
<span class="header-section-number">7.5</span> Computational setup<a class="anchor" aria-label="anchor" href="#computational-setup"></a>
</h3>
<p>I am running a Mac Studio 2022, MacOs Monterey 12.4, 32Gb RAM with <strong>R</strong> version 4.2.1 (2022-06-23) and <strong>brokenstick</strong> version 2.2.0.</p>
</div>
<div class="section level3" number="7.6">
<h3 id="methodological-advances">
<span class="header-section-number">7.6</span> Methodological advances<a class="anchor" aria-label="anchor" href="#methodological-advances"></a>
</h3>
<p>The primary modelling task for the user is to set the proper knot locations. One might envision scenarios where we want to search for the “best” places. It is not yet clear how we should do this, and how far we could automate knot placement strategies.</p>
<p>We need more insight into the statistical properties of procedures that execute the analysis as a sequence of steps. The relative pro’s and con’s of choices between multiple imputation versus random effects are not yet fully understood.</p>
<p>The current procedure assumes that the within-person error is constant across all time points. However, we might expect that observing more data close to the breakpoint will reduce the uncertainty of its estimate. In some applications, we might require that the estimate should equal the observed data value when the observation time coincides with the breakpoints. While models for such scenarios are considerably more complicated, they could also increase efficiency.</p>
</div>
<div class="section level3" number="7.7">
<h3 id="conclusion-1">
<span class="header-section-number">7.7</span> Conclusion<a class="anchor" aria-label="anchor" href="#conclusion-1"></a>
</h3>
<p>This paper highlighted various applications of the broken stick model: critical periods, time-to-time correlation, profile analysis, curve interpolation, multiple imputation and personalised prediction. These applications certainly do not exhaust the potential of the model. My hope is that the availability of the software will stimulate creative uses, ideas and experiments.</p>
</div>
</div>
<div class="section level2">
<h2 id="literature">Literature<a class="anchor" aria-label="anchor" href="#literature"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-akima2021" class="csl-entry">
Akima, H., A. Gebhardt, T. Petzold, and M. Mächler. 2021. <em>: Interpolation of Irregularly and Regularly Spaced Data</em>. <a href="https://CRAN.R-project.org/package=akima" class="external-link">https://CRAN.R-project.org/package=akima</a>.
</div>
<div id="ref-anderson2019" class="csl-entry">
Anderson, C., R. Hafen, O. Sofrygin, L. Ryan, and HBGDki Community. 2019. <span>“Comparing Predictive Abilities of Longitudinal Child Growth Models.”</span> <em>Statistics in Medicine</em> 38 (19): 3555–70.
</div>
<div id="ref-argyle2008" class="csl-entry">
Argyle, J., A. H. Seheult, and D. A. Wooff. 2008. <span>“Correlation Models for Monitoring Child Growth.”</span> <em>Statistics in Medicine</em> 27 (6): 888–904.
</div>
<div id="ref-bai2003" class="csl-entry">
Bai, J., and P. Perron. 2003. <span>“Computation and Analysis of Multiple Structural Change Models.”</span> <em>Journal of Applied Econometrics</em> 18 (1): 1–22.
</div>
<div id="ref-bates2015" class="csl-entry">
Bates, D., M. Mächler, B. Bolker, and S. Walker. 2015. <span>“Fitting Linear Mixed-Effects Models Using .”</span> <em>Journal of Statistical Software</em> 67 (1): 1–48. <a href="https://doi.org/10.18637/jss.v067.i01" class="external-link">https://doi.org/10.18637/jss.v067.i01</a>.
</div>
<div id="ref-bellman1969" class="csl-entry">
Bellman, R., and R. Roth. 1969. <span>“Curve Fitting by Segmented Straight Lines.”</span> <em>Journal of the American Statistical Association</em> 64 (327): 1079–84.
</div>
<div id="ref-cole2021" class="csl-entry">
Cole, T. 2021. <em>: Super Imposition by Translation and Rotation Growth Curve Analysis</em>. <a href="https://CRAN.R-project.org/package=sitar" class="external-link">https://CRAN.R-project.org/package=sitar</a>.
</div>
<div id="ref-cole1995" class="csl-entry">
Cole, T. J. 1995. <span>“Conditional Reference Charts to Assess Weight Gain in British Infants.”</span> <em>Archives of Disease in Childhood</em> 73 (1): 8–16.
</div>
<div id="ref-r2020" class="csl-entry">
Core Team. 2020. <em>: A Language and Environment for Statistical Computing</em>. Vienna, Austria: Foundation for Statistical Computing. <a href="https://www.R-project.org/" class="external-link">https://www.R-project.org/</a>.
</div>
<div id="ref-deboor1978" class="csl-entry">
de Boor, C. 1978. <em>A Practical Guide to Splines</em>. New York: Springer-Verlag.
</div>
<div id="ref-dekroon2008" class="csl-entry">
de Kroon, M. L. A., C. M. Renders, E. C. Kuipers, J. P. van Wouwe, S. van Buuren, G. A. de Jonge, and R. A. Hirasing. 2008. <span>“Identifying Metabolic Syndrome Without Blood Tests in Young Adults - the Terneuzen Birth Cohort.”</span> <em>European Journal of Public Health</em> 18 (6): 656–60.
</div>
<div id="ref-dekroon2010" class="csl-entry">
de Kroon, M. L. A., C. M. Renders, J. P. van Wouwe, S. van Buuren, and R. A. Hirasing. 2010. <span>“The Terneuzen Birth Cohort: BMI Changes Between 2 and 6 Years Correlate Strongest with Adult Overweight.”</span> <em>PloS ONE</em> 5 (2): e9155.
</div>
<div id="ref-dietz1994" class="csl-entry">
Dietz, W. H. 1994. <span>“Critical Periods in Childhood for the Development of Obesity.”</span> <em>American Journal of Clinical Nutrition</em> 59 (5): 955–59.
</div>
<div id="ref-diggle1988" class="csl-entry">
Diggle, P. J. 1988. <span>“An Approach to the Analysis of Repeated Measurements.”</span> <em>Biometrics</em>, 959–71.
</div>
<div id="ref-diggle2002" class="csl-entry">
Diggle, P. J., P. Heagerty, K. Y. Liang, and S. Zeger. 2002. <em>Analysis of Longitudinal Data. 2nd Edition.</em> Oxford: Oxford University Press.
</div>
<div id="ref-fitzmaurice2011" class="csl-entry">
Fitzmaurice, G. M, N. M. Laird, and J. H. Ware. 2011. <em>Applied Longitudinal Analysis. 2nd Edition.</em> New York: John Wiley &amp; Sons.
</div>
<div id="ref-fredriks2000" class="csl-entry">
Fredriks, A. M., S. van Buuren, R. J. F. Burgmeijer, J. F. Meulmeester, R. J. Beuker, E. Brugman, M. J. Roede, S. P. Verloove-Vanhorick, and J. M. Wit. 2000. <span>“Continuing Positive Secular Growth Change in the Netherlands 1955-1997.”</span> <em>Pediatric Research</em> 47 (3): 316–23.
</div>
<div id="ref-gelman2007" class="csl-entry">
Gelman, A., and J. Hill. 2007. <em>Data Analysis Using Regression and Multilevel/Hierarchical Models</em>. Cambridge: Cambridge University Press.
</div>
<div id="ref-hafen2021" class="csl-entry">
Hafen, R. 2021. <em>: Anthropometric Growth Standard Calculations</em>. <a href="https://github.com/ki-tools/growthstandards" class="external-link">https://github.com/ki-tools/growthstandards</a>.
</div>
<div id="ref-hafen2020" class="csl-entry">
Hafen, R., and B. Schloerke. 2020. <em>: Create Interactive Trelliscope Displays</em>. <a href="https://CRAN.R-project.org/package=trelliscopejs" class="external-link">https://CRAN.R-project.org/package=trelliscopejs</a>.
</div>
<div id="ref-hand1987" class="csl-entry">
Hand, D. J., and C. C. Taylor. 1987. <em>Multivariate Analysis of Variance and Repeated Measures: A Practical Approach for Behavioural Scientists</em>. Boca Raton, FL: CRC press.
</div>
<div id="ref-herngreen1994" class="csl-entry">
Herngreen, W. P., S. van Buuren, J. C. van Wieringen, J. D. Reerink, S. P. Verloove-Vanhorick, and J. H. Ruys. 1994. <span>“Growth in Length and Weight from Birth to 2 Years of a Representative Sample of Netherlands Children (Born in 1988-89) Related to Socio-Economic Status and Other Background Characteristics.”</span> <em>Annals of Human Biology</em> 21 (5): 449–63.
</div>
<div id="ref-ismail2016" class="csl-entry">
Ismail, L. C., F. A. Puglia, E. O. Ohuma, S. T. Ash, D. C. Bishop, R. M. Carew, A. S. Al Dhaheri, and W. C. Chumlea. 2016. <span>“Precision of Recumbent Crown-Heel Length When Using an Infantometer.”</span> <em>BMC Pediatrics</em> 16 (1): 186.
</div>
<div id="ref-johnson1988" class="csl-entry">
Johnson, R. A., and D. W. Wichern. 1988. <em>Applied Multivariate Statistical Analysis. 2nd Edition.</em> Englewood Cliffs, NJ: Prentice Hall.
</div>
<div id="ref-kasim1998" class="csl-entry">
Kasim, R. M., and S. W. Raudenbush. 1998. <span>“Application of Gibbs Sampling to Nested Variance Components Models with Heterogeneous Within-Group Variance.”</span> <em>Journal of Educational and Behavioral Statistics</em> 23 (2): 93–116.
</div>
<div id="ref-kenward1987" class="csl-entry">
Kenward, M. G. 1987. <span>“A Method for Comparing Profiles of Repeated Measurements.”</span> <em>Journal of the Royal Statistical Society C</em> 36 (3): 296–308.
</div>
<div id="ref-koenker2018" class="csl-entry">
Koenker, R., S. Portnoy, P. T. Ng, A. Zeileis, P. Grosjean, and B. D. Ripley. 2018. <em>: Quantile Regression</em>. <a href="https://CRAN.R-project.org/package=quantreg" class="external-link">https://CRAN.R-project.org/package=quantreg</a>.
</div>
<div id="ref-koutsoyiannis2000" class="csl-entry">
Koutsoyiannis, D. 2000. <span>“Broken Line Smoothing: A Simple Method for Interpolating and Smoothing Data Series.”</span> <em>Environmental Modelling &amp; Software</em> 15 (2): 139–49.
</div>
<div id="ref-krone2020" class="csl-entry">
Krone, T., R. Boessen, S. Bijlsma, R. van Stokkum, N. D. S. Clabbers, and W. J. Pasman. 2020. <span>“The Possibilities of the Use of n-of-1 and Do-It-Yourself Trials in Nutritional Research.”</span> <em>PloS ONE</em> 15 (5): e0232680.
</div>
<div id="ref-laird1982" class="csl-entry">
Laird, N. M., and J. H. Ware. 1982. <span>“Random-Effects Models for Longitudinal Data.”</span> <em>Biometrics</em> 38 (4): 963–74.
</div>
<div id="ref-lepot2017" class="csl-entry">
Lepot, Mathieu, Jean-Baptiste Aubin, and François HLR Clemens. 2017. <span>“Interpolation in Time Series: An Introductive Overview of Existing Methods, Their Performance Criteria and Uncertainty Assessment.”</span> <em>Water</em> 9 (10): 796.
</div>
<div id="ref-lerman1980" class="csl-entry">
Lerman, P. M. 1980. <span>“Fitting Segmented Regression Models by Grid Search.”</span> <em>Journal of the Royal Statistical Society C</em> 29 (1): 77–84.
</div>
<div id="ref-li2014" class="csl-entry">
Li, Jin, and Andrew D Heap. 2014. <span>“Spatial Interpolation Methods Applied in the Environmental Sciences: A Review.”</span> <em>Environmental Modelling &amp; Software</em> 53: 173–89.
</div>
<div id="ref-lokku2020" class="csl-entry">
Lokku, A., L. S. Lim, C. S. Birken, E. M. Pullenayegum, and TARGet Kids! Collaboration,. 2020. <span>“Summarizing the Extent of Visit Irregularity in Longitudinal Data.”</span> <em>BMC Medical Research Methodology</em> 20: 1–9.
</div>
<div id="ref-macarthur1957" class="csl-entry">
MacArthur, R. H. 1957. <span>“On the Relative Abundance of Bird Species.”</span> <em>Proceedings of the National Academy of Sciences of the United States of America</em> 43 (3): 293.
</div>
<div id="ref-morrison1976" class="csl-entry">
Morrison, D. F. 1976. <em>Multivariate Statistical Methods. 2nd Edition.</em> Singapore: McGraw-Hill.
</div>
<div id="ref-myatt2019" class="csl-entry">
Myatt, M., and E. Guevarra. 2019. <em>: Child Anthropometry z-Score Calculator</em>. <a href="https://CRAN.R-project.org/package=zscorer" class="external-link">https://CRAN.R-project.org/package=zscorer</a>.
</div>
<div id="ref-naumova2001" class="csl-entry">
Naumova, E. N., A. Must, and N. M. Laird. 2001. <span>“Tutorial in Biostatistics: Evaluating the Impact of ’Critical Periods’ in Longitudinal Studies of Growth Using Piecewise Mixed Effects Models.”</span> <em>International Journal of Epidemiology</em> 30: 1332–41.
</div>
<div id="ref-otto-sobotka2021" class="csl-entry">
Otto-Sobotka, F., E. Spiegel, S. Schnabel, L. Schulze Waltrup, P. Eilers, T. Kneib, and G. Kauermann. 2021. <em>: Expectile and Quantile Regression</em>. <a href="https://CRAN.R-project.org/package=expectreg" class="external-link">https://CRAN.R-project.org/package=expectreg</a>.
</div>
<div id="ref-plummer2006" class="csl-entry">
Plummer, M., N. Best, K. Cowles, and K. Vines. 2006. <span>“: Convergence Diagnosis and Output Analysis for MCMC.”</span><em> News</em> 6 (1): 7–11. <a href="https://journal.r-project.org/archive/" class="external-link">https://journal.r-project.org/archive/</a>.
</div>
<div id="ref-pullenayegum2016" class="csl-entry">
Pullenayegum, E. M., and L. S. H. Lim. 2016. <span>“Longitudinal Data Subject to Irregular Observation: A Review of Methods with a Focus on Visit Processes, Assumptions, and Study Design.”</span> <em>Statistical Methods in Medical Research</em> 25 (6): 2992–3014.
</div>
<div id="ref-ramsay2021" class="csl-entry">
Ramsay, J. O., S. Graves, and G. Hooker. 2021. <em>: Functional Data Analysis</em>. <a href="https://CRAN.R-project.org/package=fda" class="external-link">https://CRAN.R-project.org/package=fda</a>.
</div>
<div id="ref-rehfeld2011" class="csl-entry">
Rehfeld, K., N. Marwan, J. Heitzig, and J. Kurths. 2011. <span>“Comparison of Correlation Analysis Techniques for Irregularly Sampled Time Series.”</span> <em>Nonlinear Processes in Geophysics</em> 18 (3): 389–404.
</div>
<div id="ref-rubin1987" class="csl-entry">
Rubin, D. B. 1987. <em>Multiple Imputation for Nonresponse in Surveys</em>. New York: John Wiley &amp; Sons.
</div>
<div id="ref-schumacher2020" class="csl-entry">
Schumacher, D., E. Borghi, and J. Polonsky. 2020. <em>: Computation of the WHO Child Growth Standards</em>. <a href="https://CRAN.R-project.org/package=anthro" class="external-link">https://CRAN.R-project.org/package=anthro</a>.
</div>
<div id="ref-skrondal2009" class="csl-entry">
Skrondal, A., and S. Rabe‐Hesketh. 2009. <span>“Prediction in Multilevel Generalized Linear Models.”</span> <em>Journal of the Royal Statistical Society A</em> 172 (3): 659–87.
</div>
<div id="ref-stasinopoulos2007" class="csl-entry">
Stasinopoulos, D. M., and R. A. Rigby. 2007. <span>“Generalized Additive Models for Location Scale and Shape (GAMLSS) in .”</span> <em>Journal of Statistical Software</em> 23 (7): 1–46.
</div>
<div id="ref-toet2019" class="csl-entry">
Toet, A., J. B. F. van Erp, E. M. Boertjes, and S. van Buuren. 2019. <span>“Graphical Uncertainty Representations for Ensemble Predictions.”</span> <em>Information Visualization</em> 18 (4): 373–83.
</div>
<div id="ref-toms2003" class="csl-entry">
Toms, J. D., and M. L. Lesperance. 2003. <span>“Piecewise Regression: A Tool for Identifying Ecological Thresholds.”</span> <em>Ecology</em> 84 (8): 2034–41.
</div>
<div id="ref-towers2014" class="csl-entry">
Towers, S. 2014. <span>“Potential Fitting Biases Resulting from Grouping Data into Variable Width Bins.”</span> <em>Physics Letters B</em> 735: 146–48.
</div>
<div id="ref-umlauf2021" class="csl-entry">
Umlauf, N., N. Klein, T. Simon, and A. Zeileis. 2021. <span>“: A Lego Toolbox for Flexible Bayesian Regression (and Beyond).”</span> <em>Journal of Statistical Software</em> 100 (4): 1–53. <a href="https://doi.org/10.18637/jss.v100.i04" class="external-link">https://doi.org/10.18637/jss.v100.i04</a>.
</div>
<div id="ref-vanbuuren2007c" class="csl-entry">
van Buuren, S. 2007. <span>“Growth References.”</span> In <em>Growth Disorders. 2nd Edition</em>, edited by C. Kelnar, M. Savage, P. Saenger, and C. Cowell, 165–81. London: Hodder Arnold.
</div>
<div id="ref-vanbuuren2014d" class="csl-entry">
———. 2014. <span>“Curve Matching: A Data-Driven Technique to Improve Individual Prediction of Childhood Growth.”</span> <em>Annals of Nutrition &amp; Metabolism</em> 65 (3): 227–33.
</div>
<div id="ref-vanbuuren2018b" class="csl-entry">
———. 2018a. <em>: Analysis of Growth Data</em>. <a href="https://CRAN.R-project.org/package=AGD" class="external-link">https://CRAN.R-project.org/package=AGD</a>.
</div>
<div id="ref-vanbuuren2018" class="csl-entry">
———. 2018b. <em>Flexible Imputation of Missing Data. 2nd Edition</em>. Boca Raton, FL: CRC Press.
</div>
<div id="ref-vanbuuren2021b" class="csl-entry">
———. 2021a. <em>: Analysing and Plotting Growth Curves</em>. <a href="https://github.com/growthcharts/chartplotter" class="external-link">https://github.com/growthcharts/chartplotter</a>.
</div>
<div id="ref-vanbuuren2021" class="csl-entry">
———. 2021b. <em>: Growth References for Children Living in the Netherlands</em>. <a href="https://github.com/growthcharts/nlreferences" class="external-link">https://github.com/growthcharts/nlreferences</a>.
</div>
<div id="ref-vogel2020" class="csl-entry">
Vogel, M. 2020. <em>: Data and Methods Around Reference Values in Pediatrics</em>. <a href="https://CRAN.R-project.org/package=childsds" class="external-link">https://CRAN.R-project.org/package=childsds</a>.
</div>
<div id="ref-wood2011" class="csl-entry">
Wood, S. N. 2011. <span>“Fast Stable Restricted Maximum Likelihood and Marginal Likelihood Estimation of Semiparametric Generalized Linear Models.”</span> <em>Journal of the Royal Statistical Society B</em> 73 (1): 3–36.
</div>
<div id="ref-xiao2021" class="csl-entry">
Xiao, L., C. Li, W. Checkley, and C. Crainiceanu. 2021. <em>: Fast Covariance Estimation for Sparse Functional Data</em>. <a href="https://CRAN.R-project.org/package=face" class="external-link">https://CRAN.R-project.org/package=face</a>.
</div>
<div id="ref-ziyatdinov2018" class="csl-entry">
Ziyatdinov, A., M. Vázquez-Santiago, H. Brunel, A. Martinez-Perez, H. Aschard, and J. M. Soria. 2018. <span>“: Linear Mixed Models with Flexible Covariance Structure for Genetic Studies of Related Individuals.”</span> <em>BMC Bioinformatics</em> 19 (1): 1–5.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by <a href="https://stefvanbuuren.name" class="external-link">Stef van Buuren</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
