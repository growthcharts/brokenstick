<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Overview of main functions • brokenstick</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Overview of main functions">
<meta property="og:description" content="brokenstick">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">brokenstick</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.0.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/brokenstick.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/mainfunctions.html">Overview of main functions</a>
    </li>
    <li>
      <a href="../articles/brokenstick-article.html">Broken Stick Model for Irregular Longitudinal Data</a>
    </li>
    <li>
      <a href="../articles/perfectmodel.html">Check perfect model</a>
    </li>
    <li>
      <a href="../articles/oldfriends.html">Help for old friends</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/growthcharts/brokenstick/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="mainfunctions_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Overview of main functions</h1>
                        <h4 class="author">Stef van Buuren</h4>
            
            <h4 class="date">2020-10-15</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/growthcharts/brokenstick/blob/master/vignettes/mainfunctions.Rmd"><code>vignettes/mainfunctions.Rmd</code></a></small>
      <div class="hidden name"><code>mainfunctions.Rmd</code></div>

    </div>

    
    
<style type="text/css">
img {
  border: 0px;
  padding: 10px;
}
</style>
<div id="objective" class="section level2">
<h2 class="hasAnchor">
<a href="#objective" class="anchor"></a>Objective</h2>
<p>This vignette demonstrates three major functions in the <code>brokenstick</code> package: <code><a href="../reference/brokenstick.html">brokenstick()</a></code>, <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code> and <code><a href="https://rdrr.io/r/graphics/plot.default.html">plot()</a></code>. We also need <code>dplyr</code> and <code>ggplot2</code>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="va"><a href="https://github.com/growthcharts/brokenstick">brokenstick</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></pre></div>
</div>
<div id="plot-trajectories" class="section level2">
<h2 class="hasAnchor">
<a href="#plot-trajectories" class="anchor"></a>Plot trajectories</h2>
<p>The <code>smocc_200</code> data in the <code>brokenstick</code> package contain the heights of 200 Dutch children measured on 10 visits at ages 0-2 years.</p>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">brokenstick</span><span class="fu">::</span><span class="va"><a href="../reference/smocc_200.html">smocc_200</a></span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">data</span>, <span class="fl">3</span><span class="op">)</span></pre></div>
<pre><code>## # A tibble: 3 x 7
##      id    age sex       ga    bw   hgt hgt.z
##   &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1 10001 0      female    40  3960  52   0.575
## 2 10001 0.0821 female    40  3960  55.6 0.888
## 3 10001 0.159  female    40  3960  58.2 0.797</code></pre>
<p><img src="mainfunctions_files/figure-html/plotcm-1.png" width="672"></p>
<p>Figure 1 dispays the data from the first 500 rows as a set of growth curves of Dutch children. Curves are steeper during the first few months, so child growth is faster for young infants. Note also there are more cross-overs during the first half year, whereas fewer occur later. This means that the relative positions have been settled by the age of 2 years, or - put differently - that the correlation between time points at those ages is high.</p>
<div class="sourceCode" id="cb4"><pre class="downlit">
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">500</span>, <span class="op">]</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">age</span>, y <span class="op">=</span> <span class="va">hgt.z</span>, group <span class="op">=</span> <span class="va">id</span>, color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html">scale_colour_viridis_d</a></span><span class="op">(</span>option <span class="op">=</span> <span class="st">"cividis"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"Age (years)"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"Length SDS"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_light</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></pre></div>
<p><img src="mainfunctions_files/figure-html/plotsds-1.png" width="672"></p>
<p>Figure 2 dispays the same data, but with the vertical axis changed to Standard Deviation Scores (SDS), or <span class="math inline">\(Z\)</span>-score. The <span class="math inline">\(Z\)</span>-score is the height corrected for age relative to the Dutch height reference from the Fourth Dutch Growth Study. The <span class="math inline">\(Z\)</span>-score transformation takes away the major time trend, so all curves are more or less flat. This allows us to see a more detailed assessment of individual growth.</p>
<p>The plots also show how the measurements are clustered around ten ages: birth, 1, 2, 3, 6, 9, 12, 15, 18 and 24 months. While the design was followed rigorously in the study, some variation in timing is inevitable because of weekends, holidays, sickness, and other events. The timing variation poses a problem because we cannot directly compare the measurement between different children (especially for figure 1). Also, we cannot easily construct the “broad” matrix with 10 time point per child.</p>
<p>Of course, we can divide the time axis into ten age groups, and treat all point within the same age group as being measured at the same point. This is probably a good strategy for nicely looking data - as we have here -, but this approach is problematic in data with irregular time intervals, of there are multiple measurement per age group, if the measurement schedules vary by child, or in data combined from studies that employed different designs.</p>
<p>The <code>brokenstick</code> package contains tools to approximate the observed data by a series of connecting straight lines. When these lines closely follow the data, we may replace each trajectory by its values at the breakpoints. The statistical analysis can then be done on the regularised trajectories, which is easier than working with the observed data.</p>
</div>
<div id="fit-broken-stick-model-with-one-line" class="section level2">
<h2 class="hasAnchor">
<a href="#fit-broken-stick-model-with-one-line" class="anchor"></a>Fit broken stick model with one line</h2>
<p>We fit a trivial broken stick model with just one line anchored at the minimum and maximum age, and plot the trajectories of three selected children as follows:</p>
<div class="sourceCode" id="cb5"><pre class="downlit">
<span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/brokenstick.html">brokenstick</a></span><span class="op">(</span><span class="va">hgt</span> <span class="op">~</span> <span class="va">age</span> <span class="op">|</span> <span class="va">id</span>, <span class="va">data</span><span class="op">)</span>
<span class="va">ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">10001</span>, <span class="fl">10005</span>, <span class="fl">10022</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">fit</span>, new_data <span class="op">=</span> <span class="va">data</span>, group <span class="op">=</span> <span class="va">ids</span>, what <span class="op">=</span> <span class="st">"all"</span>,
     xlab <span class="op">=</span> <span class="st">"Age (years)"</span>, ylab <span class="op">=</span> <span class="st">"Length (cm)"</span><span class="op">)</span></pre></div>
<p><img src="mainfunctions_files/figure-html/figure1-1.png" width="672"></p>
<p>The following plot displays the same data, but in standardised units so as to increase the analytic resolution:</p>
<div class="sourceCode" id="cb6"><pre class="downlit">
<span class="va">fit0</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/brokenstick.html">brokenstick</a></span><span class="op">(</span><span class="va">hgt.z</span> <span class="op">~</span> <span class="va">age</span> <span class="op">|</span> <span class="va">id</span>, <span class="va">data</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">fit0</span>, new_data <span class="op">=</span> <span class="va">data</span>, group <span class="op">=</span> <span class="va">ids</span>, what <span class="op">=</span> <span class="st">"all"</span>, 
     xlab <span class="op">=</span> <span class="st">"Age (years)"</span>, ylab <span class="op">=</span> <span class="st">"Length (SDS)"</span><span class="op">)</span></pre></div>
<p><img src="mainfunctions_files/figure-html/zscore-1.png" width="672"></p>
<p>Note that both approximations are quite bad.</p>
</div>
<div id="fit-broken-stick-model-with-two-lines" class="section level2">
<h2 class="hasAnchor">
<a href="#fit-broken-stick-model-with-two-lines" class="anchor"></a>Fit broken stick model with two lines</h2>
<p>The <em>broken stick model</em> describes a trajectory by a series of connected straight lines. We first calculate a model with two connected lines. The first line starts at birth and end at the age of exactly 1 years. The second line spans the period between 1 to 2 years. In addition, the lines must connect at the age of 1 year. We estimate and plot the model as follows:</p>
<div class="sourceCode" id="cb7"><pre class="downlit">
<span class="va">fit2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/brokenstick.html">brokenstick</a></span><span class="op">(</span><span class="va">hgt.z</span> <span class="op">~</span> <span class="va">age</span> <span class="op">|</span> <span class="va">id</span>, data <span class="op">=</span> <span class="va">data</span>, knots <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">fit2</span>, <span class="va">data</span>, group <span class="op">=</span> <span class="va">ids</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2.1</span><span class="op">)</span>, 
     xlab <span class="op">=</span> <span class="st">"Age (years)"</span>, ylab <span class="op">=</span> <span class="st">"Length (SDS)"</span><span class="op">)</span></pre></div>
<p><img src="mainfunctions_files/figure-html/plotfit2-1.png" width="672"></p>
<p>The <code>fit2</code> object holds the parameter estimates of the model:</p>
<div class="sourceCode" id="cb8"><pre class="downlit">
<span class="va">fit2</span></pre></div>
<pre><code>## Class: brokenstick (lmer)
## Knots: 0 1 2 3 
## Means: 0.09 0.04 0.09 0.13 
## Variance-covariance matrix:
##       age_0 age_1 age_2 age_3
## age_0  0.83                  
## age_1  0.42   0.8            
## age_2  0.44  0.76  0.83      
## age_3 -0.49 -0.18 -0.06  0.51
## Residual variance:  0.1776797</code></pre>
<p>The console output lists the knots of the model, including the left and right boundary knots at 0 and 3. The row of <code>means</code> correspond to the fixed effect estimates of the linear mixed model. We may interpret these as the global means. Next, the output lists the variance-covariance matrix of the random effects. The model contains 4 random effects (3 visits + 1 end knot). Finally, the residual variance is the model error at the subject level. These three set of parameters are enough to reconstruct the broken stick model.</p>
</div>
<div id="extend-to-nine-lines" class="section level2">
<h2 class="hasAnchor">
<a href="#extend-to-nine-lines" class="anchor"></a>Extend to nine lines</h2>
<p>The plot shows that the two-line model is still fairly crude. We refine the model in the first two years by adding a knot for each age at which a visit was scheduled. This model can be run as</p>
<div class="sourceCode" id="cb10"><pre class="downlit">
<span class="va">knots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">6</span>, <span class="fl">9</span>, <span class="fl">12</span>, <span class="fl">15</span>, <span class="fl">18</span>, <span class="fl">24</span><span class="op">)</span><span class="op">/</span><span class="fl">12</span>, <span class="fl">4</span><span class="op">)</span>
<span class="va">fit9</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/brokenstick.html">brokenstick</a></span><span class="op">(</span><span class="va">hgt.z</span> <span class="op">~</span> <span class="va">age</span> <span class="op">|</span> <span class="va">id</span>, data <span class="op">=</span> <span class="va">data</span>, 
                    knots <span class="op">=</span> <span class="va">knots</span>, boundary <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></pre></div>
<p>This optimization problem is more difficult, so it takes longer to run. In addition, it is common that the optimization routines issue a number of warnings related to the number of random effects relative to the number of observations. While these may appear a little discomforting, we have found that the warnings are generally somewhat at the conservative side, so the parameter estimates are probably still OK.</p>
<p><img src="mainfunctions_files/figure-html/plotfit9-1.png" width="672"></p>
<p>The nine-line broken stick model fits the observed data very well.</p>
</div>
<div id="obtain-predicted-values" class="section level2">
<h2 class="hasAnchor">
<a href="#obtain-predicted-values" class="anchor"></a>Obtain predicted values</h2>
<p>The <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code> function allows us to obtain various types of predictions from the broken stick model. The simplest call</p>
<div class="sourceCode" id="cb11"><pre class="downlit">
<span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fit2</span>, <span class="va">data</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">p1</span><span class="op">)</span></pre></div>
<pre><code>##       .pred
## 1 0.7083945
## 2 0.6492978
## 3 0.5940882
## 4 0.5251301
## 5 0.3457527
## 6 0.1664473</code></pre>
<div class="sourceCode" id="cb13"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/identical.html">identical</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">p1</span><span class="op">)</span><span class="op">)</span></pre></div>
<pre><code>## [1] TRUE</code></pre>
<p>produces a <code>tibble</code> with the one column called <code>.pred</code> for each row in <code>data</code>. We can bind column <code>.pred</code> to <code>data</code> for further processing.</p>
<p>Sometimes, we also want the prediction at the knot values, for example, to create graphs that contain observed and modelled trajectories. We obtain predictions at the knots by the special <code>x = "knots"</code> argument, e.g.</p>
<div class="sourceCode" id="cb15"><pre class="downlit">
<span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fit2</span>, <span class="va">data</span>, x <span class="op">=</span> <span class="st">"knots"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">p2</span><span class="op">)</span></pre></div>
<pre><code>## # A tibble: 6 x 9
##   .source    id   age sex      ga    bw   hgt hgt.z   .pred
##   &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;
## 1 added   10001     0 &lt;NA&gt;     NA    NA    NA    NA  0.708 
## 2 added   10001     1 &lt;NA&gt;     NA    NA    NA    NA -0.0114
## 3 added   10001     2 &lt;NA&gt;     NA    NA    NA    NA  0.0792
## 4 added   10001     3 &lt;NA&gt;     NA    NA    NA    NA -0.285 
## 5 added   10002     0 &lt;NA&gt;     NA    NA    NA    NA -0.220 
## 6 added   10002     1 &lt;NA&gt;     NA    NA    NA    NA -0.398</code></pre>
<div class="sourceCode" id="cb17"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">p2</span><span class="op">)</span></pre></div>
<pre><code>## [1] 800</code></pre>
<p>The output is more verbose and includes the grid of knots for each child (<code>id</code>, <code>age</code>). The column <code>.source</code> is equal to <code>added</code> as rows are added to the data.</p>
<p>Note there are also knots at ages 0.00 and 3.00 years. These are boundary knots, and added by the <code><a href="../reference/brokenstick.html">brokenstick()</a></code> function. By default, the boundary knots span the age range in the data. The estimate for the knot at the maximum age has no useful interpretation, and should be ignored.</p>
<p>If we wish to obtain estimates at both the knots and the observed data use:</p>
<div class="sourceCode" id="cb19"><pre class="downlit">
<span class="va">p3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fit2</span>, <span class="va">data</span>, x <span class="op">=</span> <span class="st">"knots"</span>, strip_data <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">p3</span><span class="op">$</span><span class="va">.source</span><span class="op">)</span></pre></div>
<pre><code>## 
## added  data 
##   800  1942</code></pre>
<p>This return 1940 rows for the data and 800 rows for the knots.</p>
</div>
<div id="explained-variance" class="section level2">
<h2 class="hasAnchor">
<a href="#explained-variance" class="anchor"></a>Explained variance</h2>
<p>The proportion of the variance of the outcome explained by the two-line model is</p>
<div class="sourceCode" id="cb21"><pre class="downlit">
<span class="fu"><a href="../reference/get_r2.html">get_r2</a></span><span class="op">(</span><span class="va">fit2</span>, <span class="va">data</span><span class="op">)</span></pre></div>
<pre><code>## [1] 0.8498623</code></pre>
<p>For the second model we get</p>
<div class="sourceCode" id="cb23"><pre class="downlit">
<span class="fu"><a href="../reference/get_r2.html">get_r2</a></span><span class="op">(</span><span class="va">fit9</span>, <span class="va">data</span><span class="op">)</span></pre></div>
<pre><code>## [1] 0.9747304</code></pre>
<p>so the nine-line broken stick model explains about 97 percent of the variance of the height SDS.</p>
</div>
<div id="subject-level-analysis" class="section level2">
<h2 class="hasAnchor">
<a href="#subject-level-analysis" class="anchor"></a>Subject level analysis</h2>
<p>Suppose we are interest in knowing the effect of sex, gestational age and birth weight on the height SDS at the age of 2 years. This is an analysis at the subject level. Let us first extract the subject-level data with variables that vary over subjects only.</p>
<div class="sourceCode" id="cb25"><pre class="downlit">
<span class="va">subj</span> <span class="op">&lt;-</span> <span class="va">data</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">sex</span>, <span class="va">ga</span>, <span class="va">bw</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">subj</span>, <span class="fl">3</span><span class="op">)</span></pre></div>
<pre><code>## # A tibble: 3 x 4
## # Groups:   id [3]
##      id sex       ga    bw
##   &lt;dbl&gt; &lt;chr&gt;  &lt;dbl&gt; &lt;dbl&gt;
## 1 10001 female    40  3960
## 2 10002 male      38  3210
## 3 10003 female    40  4170</code></pre>
<p>We also need the outcome variable. We take it from the broken stick estimates from the nine line solution and append it to the subject level data.</p>
<div class="sourceCode" id="cb27"><pre class="downlit">
<span class="va">bs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fit9</span>, <span class="va">data</span>, x <span class="op">=</span> <span class="st">"knots"</span>, shape <span class="op">=</span> <span class="st">"wide"</span><span class="op">)</span>
<span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_cols</a></span><span class="op">(</span><span class="va">subj</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">bs</span>, <span class="op">-</span><span class="va">id</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">data</span>, <span class="fl">3</span><span class="op">)</span></pre></div>
<pre><code>## # A tibble: 3 x 15
## # Groups:   id [3]
##      id sex      ga    bw    `0` `0.0833` `0.1667` `0.25`  `0.5` `0.75`     `1`
##   &lt;dbl&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;
## 1 10001 fema…    40  3960  0.574    0.883    0.705  0.612  0.320 -0.206  0.0755
## 2 10002 male     38  3210 -0.181   -0.314   -0.250 -0.320 -0.233 -0.282 -0.329 
## 3 10003 fema…    40  4170  1.17     2.07     1.95   2.08   2.05   1.77   1.31  
## # … with 4 more variables: `1.25` &lt;dbl&gt;, `1.5` &lt;dbl&gt;, `2` &lt;dbl&gt;, `3` &lt;dbl&gt;</code></pre>
<p>The names of the columns in <code>bs</code> correspond to the knot values.</p>
<p>The effect of the subject’s sex, gestational age and birth weight on the height SDS at the age of 2 years (here denoted by the variable named <code>2</code>) can be estimated as</p>
<div class="sourceCode" id="cb29"><pre class="downlit">
<span class="va">fit1_lm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">`2`</span> <span class="op">~</span> <span class="va">sex</span> <span class="op">+</span> <span class="va">ga</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="va">bw</span> <span class="op">/</span> <span class="fl">1000</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">fit1_lm</span><span class="op">)</span></pre></div>
<pre><code>## 
## Call:
## lm(formula = `2` ~ sex + ga + I(bw/1000), data = data)
## 
## Residuals:
##      Min       1Q   Median       3Q      Max 
## -2.79282 -0.49262  0.06051  0.64618  2.04097 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)  1.88331    1.49550   1.259 0.209413    
## sexmale     -0.02350    0.13064  -0.180 0.857412    
## ga          -0.09259    0.04404  -2.102 0.036793 *  
## I(bw/1000)   0.56081    0.14442   3.883 0.000141 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 0.894 on 196 degrees of freedom
## Multiple R-squared:  0.07484,    Adjusted R-squared:  0.06068 
## F-statistic: 5.285 on 3 and 196 DF,  p-value: 0.001589</code></pre>
<p>Note that the analysis shows there is a substantial effect of birth weight. Of course, it might be that birth weight is directly related to height at the age of 2 years. Alternatively, the relation could be mediated by birth length. The following model adds birth length (the variable named <code>0</code>) to the model:</p>
<div class="sourceCode" id="cb31"><pre class="downlit">
<span class="va">fit2_lm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">`2`</span> <span class="op">~</span> <span class="va">sex</span> <span class="op">+</span> <span class="va">ga</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="va">bw</span> <span class="op">/</span> <span class="fl">1000</span><span class="op">)</span> <span class="op">+</span> <span class="va">`0`</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">fit2_lm</span><span class="op">)</span></pre></div>
<pre><code>## 
## Call:
## lm(formula = `2` ~ sex + ga + I(bw/1000) + `0`, data = data)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -3.0752 -0.5182  0.0488  0.5976  1.9241 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)   
## (Intercept)  1.88163    1.47058   1.280  0.20224   
## sexmale     -0.02696    0.12847  -0.210  0.83397   
## ga          -0.06366    0.04455  -1.429  0.15460   
## I(bw/1000)   0.23525    0.18422   1.277  0.20312   
## `0`          0.22153    0.07985   2.774  0.00607 **
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 0.8791 on 195 degrees of freedom
## Multiple R-squared:   0.11,  Adjusted R-squared:  0.09171 
## F-statistic: 6.023 on 4 and 195 DF,  p-value: 0.0001367</code></pre>
<p>The effect of birth length on length at age 2 is very strong. There is no separate effect of birth weight anymore, so this analysis suggests that the relation between birth weight and length at age 2 can be explained by their mutual associations to birth length.</p>
</div>
<div id="conclusion" class="section level2">
<h2 class="hasAnchor">
<a href="#conclusion" class="anchor"></a>Conclusion</h2>
<p>This vignette illustrated the use of the <code><a href="../reference/brokenstick.html">brokenstick()</a></code>, <code><a href="https://rdrr.io/r/graphics/plot.default.html">plot()</a></code> and <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code> functions. Other vignettes highlight various other capabilities of the package.</p>
<ul>
<li>
<a href="brokenstick-article.html">Broken Stick Model for Irregular Longitudinal Data</a>
<ul>
<li>Irregular observation times</li>
<li>Literature overview</li>
<li>Definition of the model</li>
<li>Interpretation of the model</li>
<li>Estimation by <code>lmer</code> and <code>kr</code> methods</li>
<li>Software overview</li>
<li>
<code><a href="../reference/brokenstick.html">brokenstick()</a></code> for model fitting</li>
<li>
<code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code> for trajectory plotting</li>
<li>Conversion back and forth to the <span class="math inline">\(Z\)</span>-score scale</li>
<li>Predict growth curve of new subjects</li>
<li>Assess the quality of the model</li>
<li>Knot placement strategies</li>
<li>Critical periods</li>
<li>Time-to-time correlations</li>
<li>Profile analysis</li>
<li>Curve interpolation</li>
<li>Multiple imputation</li>
<li>Curve matching</li>
<li>Discussion</li>
</ul>
</li>
<li>
<a href="perfectmodel.html">Perfect model</a>
<ul>
<li>Properties of the perfect model</li>
<li>Estimating time-to-time correlations</li>
</ul>
</li>
<li>
<a href="oldfriends.html">Help for old friends</a>
<ul>
<li>Properties of the perfect model</li>
<li>Estimating time-to-time correlations</li>
</ul>
</li>
</ul>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="https://stefvanbuuren.name">Stef van Buuren</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
