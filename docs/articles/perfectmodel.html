<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Check perfect model • brokenstick</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Check perfect model">
<meta property="og:description" content="brokenstick">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">brokenstick</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/brokenstick.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/mainfunctions.html">Overview of main functions</a>
    </li>
    <li>
      <a href="../articles/brokenstick-article.html">Broken Stick Model for Irregular Longitudinal Data</a>
    </li>
    <li>
      <a href="../articles/perfectmodel.html">Check perfect model</a>
    </li>
    <li>
      <a href="../articles/oldfriends.html">Help for old friends</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/growthcharts/brokenstick/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="perfectmodel_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Check perfect model</h1>
                        <h4 class="author">Stef van Buuren</h4>
            
            <h4 class="date">2020-10-14</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/growthcharts/brokenstick/blob/master/vignettes/perfectmodel.Rmd"><code>vignettes/perfectmodel.Rmd</code></a></small>
      <div class="hidden name"><code>perfectmodel.Rmd</code></div>

    </div>

    
    
<div id="objective" class="section level2">
<h2 class="hasAnchor">
<a href="#objective" class="anchor"></a>Objective</h2>
<p>In general, the broken stick model smoothes the observed growth trajectory. What happens of all observations are already aligned to the break ages? Does the model perfectly represent the data? Is the covariance matrix of the random effects (<span class="math inline">\(\Omega)\)</span> equal to the covariance between the measurements? Is <span class="math inline">\(\sigma^2\)</span> equal to zero?</p>
</div>
<div id="data-generation" class="section level2">
<h2 class="hasAnchor">
<a href="#data-generation" class="anchor"></a>Data generation</h2>
<p>We adapt code from <a href="http://www.davekleinschmidt.com/sst-mixed-effects-simulation/simulations_slides.pdf" class="uri">http://www.davekleinschmidt.com/sst-mixed-effects-simulation/simulations_slides.pdf</a> to generate test data:</p>
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="http://had.co.nz/plyr">"plyr"</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="http://mvtnorm.R-forge.R-project.org">"mvtnorm"</a></span><span class="op">)</span>
<span class="va">make_data_generator</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">resid_var</span> <span class="op">=</span> <span class="fl">1</span>,
                                <span class="va">ranef_covar</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>, <span class="va">n</span> <span class="op">=</span> <span class="fl">100</span>
                                <span class="op">)</span> <span class="op">{</span>
  <span class="va">ni</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">ranef_covar</span><span class="op">)</span>
  <span class="va">generate_data</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span>
    <span class="co"># sample data set under mixed effects model with random slope/intercepts </span>
    <span class="va">simulated_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/plyr/man/rdply.html">rdply</a></span><span class="op">(</span><span class="va">n</span>, <span class="op">{</span>
      <span class="va">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/mvtnorm/man/Mvnorm.html">rmvnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span>, sigma <span class="op">=</span> <span class="va">ranef_covar</span><span class="op">)</span><span class="op">)</span>
      <span class="va">epsilon</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">b</span><span class="op">)</span>, mean <span class="op">=</span> <span class="fl">0</span>, sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">resid_var</span><span class="op">)</span><span class="op">)</span>
      <span class="va">b</span> <span class="op">+</span> <span class="va">epsilon</span>
    <span class="op">}</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
    subject <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span>, each <span class="op">=</span> <span class="va">ni</span><span class="op">)</span>,
    age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">ni</span>, <span class="va">n</span><span class="op">)</span>,
    <span class="va">simulated_data</span><span class="op">)</span>
  <span class="op">}</span>
<span class="op">}</span></pre></div>
<p>Let us first model the perfect situation where <span class="math inline">\(\sigma^2 = 0\)</span> (so we set <code>resid_var</code> to zero) and where the ages align perfectly.</p>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">77711</span><span class="op">)</span>
<span class="va">covar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0.7</span>, <span class="fl">0.5</span>, <span class="fl">0.3</span>,
                  <span class="fl">0.7</span>, <span class="fl">1</span>, <span class="fl">0.8</span>, <span class="fl">0.5</span>,
                  <span class="fl">0.5</span>, <span class="fl">0.8</span>, <span class="fl">1</span>, <span class="fl">0.6</span>,
                  <span class="fl">0.3</span>, <span class="fl">0.5</span>, <span class="fl">0.6</span>, <span class="fl">1</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>
<span class="va">gen_dat</span> <span class="op">&lt;-</span> <span class="fu">make_data_generator</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">10000</span>, 
                               ranef_covar <span class="op">=</span> <span class="va">covar</span>,
                               resid_var <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
<span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">gen_dat</span><span class="op">(</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></pre></div>
<pre><code>##   subject age .n          X1
## 1       1   1  1 -0.94777697
## 2       1   2  1 -2.08372706
## 3       1   3  1 -2.65116213
## 4       1   4  1 -2.55255194
## 5       2   1  2 -0.08250395
## 6       2   2  2 -1.27072650</code></pre>
<p>Check the correlation matrix of the <span class="math inline">\(y\)</span>’s.</p>
<div class="sourceCode" id="cb4"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://tidyr.tidyverse.org">"tidyr"</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://dplyr.tidyverse.org">"dplyr"</a></span><span class="op">)</span></pre></div>
<pre><code>## 
## Attaching package: 'dplyr'</code></pre>
<pre><code>## The following objects are masked from 'package:plyr':
## 
##     arrange, count, desc, failwith, id, mutate, rename, summarise,
##     summarize</code></pre>
<pre><code>## The following objects are masked from 'package:stats':
## 
##     filter, lag</code></pre>
<pre><code>## The following objects are masked from 'package:base':
## 
##     intersect, setdiff, setequal, union</code></pre>
<div class="sourceCode" id="cb9"><pre class="downlit">
<span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>,<span class="op">-</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span>
<span class="va">broad</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/spread.html">spread</a></span><span class="op">(</span><span class="va">d</span>, <span class="va">subject</span>, <span class="va">X1</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span>,<span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cor</a></span><span class="op">(</span><span class="va">broad</span><span class="op">)</span></pre></div>
<pre><code>##           [,1]      [,2]      [,3]      [,4]
## [1,] 1.0000000 0.3497654 0.2550082 0.1611466
## [2,] 0.3497654 1.0000000 0.4061576 0.2460109
## [3,] 0.2550082 0.4061576 1.0000000 0.3127620
## [4,] 0.1611466 0.2460109 0.3127620 1.0000000</code></pre>
</div>
<div id="fit-model" class="section level2">
<h2 class="hasAnchor">
<a href="#fit-model" class="anchor"></a>Fit model</h2>
<p>Fit broken stick model, with knots specified at ages <code>1:4</code>.</p>
<div class="sourceCode" id="cb11"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/growthcharts/brokenstick">"brokenstick"</a></span><span class="op">)</span>
<span class="va">knots</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span>
<span class="va">boundary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">4</span><span class="op">)</span>
<span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/brokenstick.html">brokenstick</a></span><span class="op">(</span><span class="va">X1</span> <span class="op">~</span> <span class="va">age</span> <span class="op">|</span> <span class="va">subject</span>, <span class="va">data</span>, 
                   knots <span class="op">=</span> <span class="va">knots</span>, boundary <span class="op">=</span> <span class="va">boundary</span><span class="op">)</span>
<span class="va">omega</span> <span class="op">&lt;-</span> <span class="va">fit</span><span class="op">$</span><span class="va">omega</span>
<span class="va">beta</span> <span class="op">&lt;-</span> <span class="va">fit</span><span class="op">$</span><span class="va">beta</span>
<span class="va">sigma2</span> <span class="op">&lt;-</span> <span class="va">fit</span><span class="op">$</span><span class="va">sigma2</span>
<span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">beta</span>, <span class="fl">2</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">sigma2</span>, <span class="fl">4</span><span class="op">)</span>

<span class="co"># correlation random effects</span>
<span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">covar</span>, <span class="fl">3</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">omega</span>, <span class="fl">2</span><span class="op">)</span>

<span class="co"># covariances measured data</span>
<span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">omega</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="va">sigma2</span>, <span class="fl">4</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cov</a></span><span class="op">(</span><span class="va">broad</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span>

<span class="co"># convert to time-to-time correlation matrix</span>
<span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cov2cor</a></span><span class="op">(</span><span class="va">omega</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="va">sigma2</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cor</a></span><span class="op">(</span><span class="va">broad</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span></pre></div>
</div>
<div id="conclusions" class="section level2">
<h2 class="hasAnchor">
<a href="#conclusions" class="anchor"></a>Conclusions</h2>
<ol style="list-style-type: decimal">
<li>If <span class="math inline">\(\sigma^2=0\)</span>, then <span class="math inline">\(\Omega\)</span> reproduces correlations between <span class="math inline">\(y\)</span>’s correctly. However, the estimate of <span class="math inline">\(\sigma^2\)</span> is too high.</li>
<li>If <span class="math inline">\(\sigma^2 &gt; 0\)</span>, then <span class="math inline">\(\Omega\)</span> overestimates the correlations between <span class="math inline">\(y\)</span>’s, but correctly estimates the covariance among the random effects.</li>
<li>If <span class="math inline">\(\sigma^2 &gt; 0\)</span>, then <span class="math inline">\(\Omega + \hat\sigma^2 I(n_i)\)</span> correctly estimates the covariances between <span class="math inline">\(y\)</span>’s. This can be converted by <code><a href="https://rdrr.io/r/stats/cor.html">cov2cor()</a></code> to the time-to-time correlation matrix.</li>
</ol>
</div>
<div id="further-reading" class="section level2">
<h2 class="hasAnchor">
<a href="#further-reading" class="anchor"></a>Further reading</h2>
<ul>
<li>
<a href="mainfunctions.html">Main functions</a>
<ul>
<li>Plot trajectories</li>
<li>Orginal scale and <span class="math inline">\(Z\)</span>-score scale</li>
<li>1-line model</li>
<li>2-line broken stick model</li>
<li>9-line broken stick model</li>
<li>Prediction</li>
<li>Subject-level analysis</li>
</ul>
</li>
<li>
<a href="brokenstick-article.html">Broken Stick Model for Irregular Longitudinal Data</a>
<ul>
<li>Irregular observation times</li>
<li>Literature overview</li>
<li>Definition of the model</li>
<li>Interpretation of the model</li>
<li>Estimation by <code>lmer</code> and <code>kr</code> methods</li>
<li>Software overview</li>
<li>
<code><a href="../reference/brokenstick.html">brokenstick()</a></code> for model fitting</li>
<li>
<code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code> for trajectory plotting</li>
<li>Conversion back and forth to the <span class="math inline">\(Z\)</span>-score scale</li>
<li>Predict growth curve of new subjects</li>
<li>Assess the quality of the model</li>
<li>Knot placement strategies</li>
<li>Critical periods</li>
<li>Time-to-time correlations</li>
<li>Profile analysis</li>
<li>Curve interpolation</li>
<li>Multiple imputation</li>
<li>Curve matching</li>
<li>Discussion</li>
</ul>
</li>
<li>
<a href="oldfriends.html">Help for old friends</a>
<ul>
<li>Properties of the perfect model</li>
<li>Estimating time-to-time correlations</li>
</ul>
</li>
</ul>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="https://stefvanbuuren.name">Stef van Buuren</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
