<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="brokenstick">
<title>Check perfect model â€¢ brokenstick</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.3/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.3/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Check perfect model">
<meta property="og:description" content="brokenstick">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">brokenstick</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.3.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/brokenstick.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/mainfunctions.html">Overview of main functions</a>
    <a class="dropdown-item" href="../articles/manual/manual.html">Broken Stick Model for Irregular Longitudinal Data</a>
    <a class="dropdown-item" href="../articles/perfectmodel.html">Check perfect model</a>
    <a class="dropdown-item" href="../articles/oldfriends.html">Help for old friends</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/growthcharts/brokenstick/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Check perfect model</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/growthcharts/brokenstick/blob/HEAD/vignettes/perfectmodel.Rmd" class="external-link"><code>vignettes/perfectmodel.Rmd</code></a></small>
      <div class="d-none name"><code>perfectmodel.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="objective">Objective<a class="anchor" aria-label="anchor" href="#objective"></a>
</h2>
<p>In general, the broken stick model smoothes the observed growth
trajectory. What happens of all observations are already aligned to the
break ages? Does the model perfectly represent the data? Is the
covariance matrix of the random effects (<span class="math inline">\(\Omega)\)</span> equal to the covariance between
the measurements? Is <span class="math inline">\(\sigma^2\)</span> equal
to zero?</p>
</div>
<div class="section level2">
<h2 id="data-generation">Data generation<a class="anchor" aria-label="anchor" href="#data-generation"></a>
</h2>
<p>We adapt code from <a href="http://www.davekleinschmidt.com/sst-mixed-effects-simulation/simulations_slides.pdf" class="external-link uri">http://www.davekleinschmidt.com/sst-mixed-effects-simulation/simulations_slides.pdf</a>
to generate test data:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="http://had.co.nz/plyr" class="external-link">"plyr"</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="http://mvtnorm.R-forge.R-project.org" class="external-link">"mvtnorm"</a></span><span class="op">)</span></span>
<span><span class="va">make_data_generator</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">resid_var</span> <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                                <span class="va">ranef_covar</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>, <span class="va">n</span> <span class="op">=</span> <span class="fl">100</span></span>
<span>                                <span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">ni</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">ranef_covar</span><span class="op">)</span></span>
<span>  <span class="va">generate_data</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># sample data set under mixed effects model with random slope/intercepts </span></span>
<span>    <span class="va">simulated_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/plyr/man/rdply.html" class="external-link">rdply</a></span><span class="op">(</span><span class="va">n</span>, <span class="op">{</span></span>
<span>      <span class="va">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/mvtnorm/man/Mvnorm.html" class="external-link">rmvnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span>, sigma <span class="op">=</span> <span class="va">ranef_covar</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="va">epsilon</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">b</span><span class="op">)</span>, mean <span class="op">=</span> <span class="fl">0</span>, sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">resid_var</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="va">b</span> <span class="op">+</span> <span class="va">epsilon</span></span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    subject <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span>, each <span class="op">=</span> <span class="va">ni</span><span class="op">)</span>,</span>
<span>    age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">ni</span>, <span class="va">n</span><span class="op">)</span>,</span>
<span>    <span class="va">simulated_data</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We choose between the perfect situation where <span class="math inline">\(\sigma^2 = 0\)</span> and the noisy case <span class="math inline">\(\sigma^2 = 1\)</span> and where the ages align
perfectly.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">resid_var</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">resid_var</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">77711</span><span class="op">)</span></span>
<span><span class="va">covar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0.7</span>, <span class="fl">0.5</span>, <span class="fl">0.3</span>,</span>
<span>                  <span class="fl">0.7</span>, <span class="fl">1</span>, <span class="fl">0.8</span>, <span class="fl">0.5</span>,</span>
<span>                  <span class="fl">0.5</span>, <span class="fl">0.8</span>, <span class="fl">1</span>, <span class="fl">0.6</span>,</span>
<span>                  <span class="fl">0.3</span>, <span class="fl">0.5</span>, <span class="fl">0.6</span>, <span class="fl">1</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span><span class="va">gen_dat</span> <span class="op">&lt;-</span> <span class="fu">make_data_generator</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">10000</span>, </span>
<span>                               ranef_covar <span class="op">=</span> <span class="va">covar</span>,</span>
<span>                               resid_var <span class="op">=</span> <span class="va">resid_var</span><span class="op">)</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">gen_dat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   subject age .n          X1</span></span>
<span><span class="co">## 1       1   1  1 -0.94777697</span></span>
<span><span class="co">## 2       1   2  1 -2.08372706</span></span>
<span><span class="co">## 3       1   3  1 -2.65116213</span></span>
<span><span class="co">## 4       1   4  1 -2.55255194</span></span>
<span><span class="co">## 5       2   1  2 -0.08250395</span></span>
<span><span class="co">## 6       2   2  2 -1.27072650</span></span></code></pre>
<p>We wish to reproduce the correlation matrix among the <span class="math inline">\(y\)</span>â€™s from the mixed model estimates. The
<strong>target correlation matrix</strong> is:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://tidyr.tidyverse.org" class="external-link">"tidyr"</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://dplyr.tidyverse.org" class="external-link">"dplyr"</a></span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Attaching package: 'dplyr'</span></span></code></pre>
<pre><code><span><span class="co">## The following objects are masked from 'package:plyr':</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     arrange, count, desc, failwith, id, mutate, rename, summarise,</span></span>
<span><span class="co">##     summarize</span></span></code></pre>
<pre><code><span><span class="co">## The following objects are masked from 'package:stats':</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     filter, lag</span></span></code></pre>
<pre><code><span><span class="co">## The following objects are masked from 'package:base':</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     intersect, setdiff, setequal, union</span></span></code></pre>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>,<span class="op">-</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">broad</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/spread.html" class="external-link">spread</a></span><span class="op">(</span><span class="va">d</span>, <span class="va">subject</span>, <span class="va">X1</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span>,<span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="va">broad</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##           [,1]      [,2]      [,3]      [,4]</span></span>
<span><span class="co">## [1,] 1.0000000 0.3497654 0.2550082 0.1611466</span></span>
<span><span class="co">## [2,] 0.3497654 1.0000000 0.4061576 0.2460109</span></span>
<span><span class="co">## [3,] 0.2550082 0.4061576 1.0000000 0.3127620</span></span>
<span><span class="co">## [4,] 0.1611466 0.2460109 0.3127620 1.0000000</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="fit-model">Fit model<a class="anchor" aria-label="anchor" href="#fit-model"></a>
</h2>
<p>Fit broken stick model, with knots specified at ages
<code>1:4</code>.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/growthcharts/brokenstick" class="external-link">"brokenstick"</a></span><span class="op">)</span></span>
<span><span class="va">knots</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span></span>
<span><span class="va">boundary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">4</span><span class="op">)</span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/brokenstick.html">brokenstick</a></span><span class="op">(</span><span class="va">X1</span> <span class="op">~</span> <span class="va">age</span> <span class="op">|</span> <span class="va">subject</span>, <span class="va">data</span>, </span>
<span>                   knots <span class="op">=</span> <span class="va">knots</span>, boundary <span class="op">=</span> <span class="va">boundary</span>,</span>
<span>                   method <span class="op">=</span> <span class="st">"lmer"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: number of observations (=40000) &lt;= number of random effects (=40000)</span></span>
<span><span class="co">## for term (0 + age_1 + age_2 + age_3 + age_4 | subject); the random-effects</span></span>
<span><span class="co">## parameters and the residual variance (or scale parameter) are probably</span></span>
<span><span class="co">## unidentifiable</span></span></code></pre>
<pre><code><span><span class="co">## Warning in checkConv(attr(opt, "derivs"), opt$par, ctrl = control$checkConv, :</span></span>
<span><span class="co">## Model failed to converge with max|grad| = 0.00852341 (tol = 0.002, component 1)</span></span></code></pre>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">omega</span> <span class="op">&lt;-</span> <span class="va">fit</span><span class="op">$</span><span class="va">omega</span></span>
<span><span class="va">beta</span> <span class="op">&lt;-</span> <span class="va">fit</span><span class="op">$</span><span class="va">beta</span></span>
<span><span class="va">sigma2</span> <span class="op">&lt;-</span> <span class="va">fit</span><span class="op">$</span><span class="va">sigma2</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">beta</span>, <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## age_1 age_2 age_3 age_4 </span></span>
<span><span class="co">## -0.02 -0.02  0.01  0.01</span></span></code></pre>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">sigma2</span>, <span class="fl">4</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0.8184</span></span></code></pre>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># correlation random effects</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">covar</span>, <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##      [,1] [,2] [,3] [,4]</span></span>
<span><span class="co">## [1,]  1.0  0.7  0.5  0.3</span></span>
<span><span class="co">## [2,]  0.7  1.0  0.8  0.5</span></span>
<span><span class="co">## [3,]  0.5  0.8  1.0  0.6</span></span>
<span><span class="co">## [4,]  0.3  0.5  0.6  1.0</span></span></code></pre>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">omega</span>, <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##       age_1 age_2 age_3 age_4</span></span>
<span><span class="co">## age_1  1.23  0.71  0.52  0.33</span></span>
<span><span class="co">## age_2  0.71  1.16  0.82  0.49</span></span>
<span><span class="co">## age_3  0.52  0.82  1.22  0.63</span></span>
<span><span class="co">## age_4  0.33  0.49  0.63  1.17</span></span></code></pre>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># covariances measured data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">omega</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">sigma2</span>, <span class="fl">4</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##       age_1 age_2 age_3 age_4</span></span>
<span><span class="co">## age_1 2.052 0.706 0.521 0.326</span></span>
<span><span class="co">## age_2 0.706 1.982 0.816 0.489</span></span>
<span><span class="co">## age_3 0.521 0.816 2.034 0.630</span></span>
<span><span class="co">## age_4 0.326 0.489 0.630 1.992</span></span></code></pre>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cov</a></span><span class="op">(</span><span class="va">broad</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##       [,1]  [,2]  [,3]  [,4]</span></span>
<span><span class="co">## [1,] 2.052 0.706 0.521 0.326</span></span>
<span><span class="co">## [2,] 0.706 1.982 0.816 0.489</span></span>
<span><span class="co">## [3,] 0.521 0.816 2.034 0.630</span></span>
<span><span class="co">## [4,] 0.326 0.489 0.630 1.992</span></span></code></pre>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># convert to time-to-time correlation matrix</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cov2cor</a></span><span class="op">(</span><span class="va">omega</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">sigma2</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##       age_1 age_2 age_3 age_4</span></span>
<span><span class="co">## age_1 1.000 0.350 0.255 0.161</span></span>
<span><span class="co">## age_2 0.350 1.000 0.406 0.246</span></span>
<span><span class="co">## age_3 0.255 0.406 1.000 0.313</span></span>
<span><span class="co">## age_4 0.161 0.246 0.313 1.000</span></span></code></pre>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="va">broad</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##       [,1]  [,2]  [,3]  [,4]</span></span>
<span><span class="co">## [1,] 1.000 0.350 0.255 0.161</span></span>
<span><span class="co">## [2,] 0.350 1.000 0.406 0.246</span></span>
<span><span class="co">## [3,] 0.255 0.406 1.000 0.313</span></span>
<span><span class="co">## [4,] 0.161 0.246 0.313 1.000</span></span></code></pre>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit</span>, x <span class="op">=</span> <span class="st">"knots"</span>, include_data <span class="op">=</span> <span class="cn">FALSE</span>, shape <span class="op">=</span> <span class="st">"wide"</span><span class="op">)</span><span class="op">[</span>, <span class="op">-</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="co"># off-diagonal elements of covariance of broken stick estimates approach correlation</span></span>
<span><span class="co"># not enough variance in the diagonal because of smoothing</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cov</a></span><span class="op">(</span><span class="va">z</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##           1         2         3         4</span></span>
<span><span class="co">## 1 0.7951267 0.5945802 0.4745271 0.3057211</span></span>
<span><span class="co">## 2 0.5945802 0.7905218 0.6806088 0.4405806</span></span>
<span><span class="co">## 3 0.4745271 0.6806088 0.8212859 0.5362509</span></span>
<span><span class="co">## 4 0.3057211 0.4405806 0.5362509 0.7364388</span></span></code></pre>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># correlations of broken stick estimates are inflated because of smoothing</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="va">z</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##           1         2         3         4</span></span>
<span><span class="co">## 1 1.0000000 0.7499553 0.5872130 0.3995204</span></span>
<span><span class="co">## 2 0.7499553 1.0000000 0.8446824 0.5774310</span></span>
<span><span class="co">## 3 0.5872130 0.8446824 1.0000000 0.6895290</span></span>
<span><span class="co">## 4 0.3995204 0.5774310 0.6895290 1.0000000</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="conclusions">Conclusions<a class="anchor" aria-label="anchor" href="#conclusions"></a>
</h2>
<ol style="list-style-type: decimal">
<li>If <span class="math inline">\(\sigma^2=0\)</span>, then the
off-diagonal elements of <span class="math inline">\(\Omega\)</span>
reproduce the correlations among the <span class="math inline">\(y\)</span>â€™s. The estimate of <span class="math inline">\(\sigma^2\)</span> is too high (about 0.13 instead
of 0).</li>
<li>If <span class="math inline">\(\sigma^2 &gt; 0\)</span>, then <span class="math inline">\(\hat C = \Omega + \hat\sigma^2 I(n_i)\)</span>
reproduces the sample covariance matrix between <span class="math inline">\(y\)</span>â€™s exactly.</li>
<li>
<code>cov2cor(hatC)</code> reproduces the sample time-to-time
correlation matrix.</li>
<li>Conclusion: The unbiased estimate of the time-to-time correlation
matrix among the (unobserved) measurements at the knots:</li>
</ol>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cov</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_omega.html">get_omega</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span>
<span><span class="va">chat</span> <span class="op">&lt;-</span> <span class="va">cov</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">sigma2</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">cov</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cov2cor</a></span><span class="op">(</span><span class="va">chat</span><span class="op">)</span></span>
<span><span class="va">r</span></span></code></pre></div>
<pre><code><span><span class="co">##          age_1     age_2     age_3     age_4</span></span>
<span><span class="co">## age_1 1.000000 0.3497650 0.2550100 0.1611520</span></span>
<span><span class="co">## age_2 0.349765 1.0000000 0.4061597 0.2460114</span></span>
<span><span class="co">## age_3 0.255010 0.4061597 1.0000000 0.3127600</span></span>
<span><span class="co">## age_4 0.161152 0.2460114 0.3127600 1.0000000</span></span></code></pre>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by <a href="https://stefvanbuuren.name" class="external-link">Stef van Buuren</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
