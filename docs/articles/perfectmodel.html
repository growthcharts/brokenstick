<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Check perfect model • brokenstick</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Check perfect model">
<meta property="og:description" content="brokenstick">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">brokenstick</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.70.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/gettingstarted.html">Getting started</a>
    </li>
    <li>
      <a href="../articles/knotplacement.html">Knot placement</a>
    </li>
    <li>
      <a href="../articles/mainfunctions.html">Overview of main functions</a>
    </li>
    <li>
      <a href="../articles/model.html">Model formulation</a>
    </li>
    <li>
      <a href="../articles/oldfriends.html">Help for old friends</a>
    </li>
    <li>
      <a href="../articles/perfectmodel.html">Check perfect model</a>
    </li>
    <li>
      <a href="../articles/prediction.html">Fit and predict</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/stefvanbuuren/brokenstick/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Check perfect model</h1>
                        <h4 class="author">Stef van Buuren</h4>
            
            <h4 class="date">2020-06-16</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/stefvanbuuren/brokenstick/blob/master/vignettes/perfectmodel.Rmd"><code>vignettes/perfectmodel.Rmd</code></a></small>
      <div class="hidden name"><code>perfectmodel.Rmd</code></div>

    </div>

    
    
<div id="objective" class="section level2">
<h2 class="hasAnchor">
<a href="#objective" class="anchor"></a>Objective</h2>
<p>In general, the broken stick model smoothes the observed growth trajectory. What happens of all observations are already aligned to the break ages? Does the model perfectly represent the data? Is the covariance matrix of the random effects (<span class="math inline">\(\Omega)\)</span> equal to the covariance between the measurements? Is <span class="math inline">\(\sigma^2\)</span> equal to zero?</p>
</div>
<div id="data-generation" class="section level2">
<h2 class="hasAnchor">
<a href="#data-generation" class="anchor"></a>Data generation</h2>
<p>We adapt code from <a href="http://www.davekleinschmidt.com/sst-mixed-effects-simulation/simulations_slides.pdf" class="uri">http://www.davekleinschmidt.com/sst-mixed-effects-simulation/simulations_slides.pdf</a> to generate test data:</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"plyr"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"mvtnorm"</span>)
<span class="no">make_data_generator</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">resid_var</span> <span class="kw">=</span> <span class="fl">1</span>,
                                <span class="no">ranef_covar</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>, <span class="fl">1</span>)), <span class="no">n</span> <span class="kw">=</span> <span class="fl">100</span>
                                ) {
  <span class="no">ni</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">ranef_covar</span>)
  <span class="no">generate_data</span> <span class="kw">&lt;-</span> <span class="kw">function</span>() {
    <span class="co"># sample data set under mixed effects model with random slope/intercepts </span>
    <span class="no">simulated_data</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/plyr/man/rdply.html">rdply</a></span>(<span class="no">n</span>, {
      <span class="no">b</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/mvtnorm/man/Mvnorm.html">rmvnorm</a></span>(<span class="kw">n</span> <span class="kw">=</span> <span class="fl">1</span>, <span class="kw">sigma</span> <span class="kw">=</span> <span class="no">ranef_covar</span>))
      <span class="no">epsilon</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="kw">n</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">b</span>), <span class="kw">mean</span> <span class="kw">=</span> <span class="fl">0</span>, <span class="kw">sd</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="no">resid_var</span>))
      <span class="no">b</span> + <span class="no">epsilon</span>
    })
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(
    <span class="kw">subject</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">1</span>:<span class="no">n</span>, <span class="kw">each</span> <span class="kw">=</span> <span class="no">ni</span>),
    <span class="kw">age</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">1</span>:<span class="no">ni</span>, <span class="no">n</span>),
    <span class="no">simulated_data</span>)
  }
}</pre></body></html></div>
<p>Let us first model the perfect situation where <span class="math inline">\(\sigma^2 = 0\)</span> (so we set <code>resid_var</code> to zero) and where the ages align perfectly.</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">77711</span>)
<span class="no">covar</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>, <span class="fl">0.7</span>, <span class="fl">0.5</span>, <span class="fl">0.3</span>,
                  <span class="fl">0.7</span>, <span class="fl">1</span>, <span class="fl">0.8</span>, <span class="fl">0.5</span>,
                  <span class="fl">0.5</span>, <span class="fl">0.8</span>, <span class="fl">1</span>, <span class="fl">0.6</span>,
                  <span class="fl">0.3</span>, <span class="fl">0.5</span>, <span class="fl">0.6</span>, <span class="fl">1</span>), <span class="kw">nrow</span> <span class="kw">=</span> <span class="fl">4</span>)
<span class="no">gen_dat</span> <span class="kw">&lt;-</span> <span class="fu">make_data_generator</span>(<span class="kw">n</span> <span class="kw">=</span> <span class="fl">10000</span>,
                               <span class="kw">ranef_covar</span> <span class="kw">=</span> <span class="no">covar</span>,
                               <span class="kw">resid_var</span> <span class="kw">=</span> <span class="fl">1</span>)
<span class="no">data</span> <span class="kw">&lt;-</span> <span class="fu">gen_dat</span>()
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">data</span>)</pre></body></html></div>
<pre><code>##   subject age .n          X1
## 1       1   1  1 -0.94777697
## 2       1   2  1 -2.08372706
## 3       1   3  1 -2.65116213
## 4       1   4  1 -2.55255194
## 5       2   1  2 -0.08250395
## 6       2   2  2 -1.27072650</code></pre>
<p>Check the correlation matrix of the <span class="math inline">\(y\)</span>’s.</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"tidyr"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"dplyr"</span>)</pre></body></html></div>
<pre><code>## 
## Attaching package: 'dplyr'</code></pre>
<pre><code>## The following objects are masked from 'package:plyr':
## 
##     arrange, count, desc, failwith, id, mutate, rename, summarise,
##     summarize</code></pre>
<pre><code>## The following objects are masked from 'package:stats':
## 
##     filter, lag</code></pre>
<pre><code>## The following objects are masked from 'package:base':
## 
##     intersect, setdiff, setequal, union</code></pre>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="no">d</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/reexports.html">as_tibble</a></span>(<span class="no">data</span>[,-<span class="fl">3</span>])
<span class="no">broad</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="fu"><a href="https://tidyr.tidyverse.org/reference/spread.html">spread</a></span>(<span class="no">d</span>, <span class="no">subject</span>, <span class="no">X1</span>))[-<span class="fl">1</span>,]
<span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cor</a></span>(<span class="no">broad</span>)</pre></body></html></div>
<pre><code>##           [,1]      [,2]      [,3]      [,4]
## [1,] 1.0000000 0.3497654 0.2550082 0.1611466
## [2,] 0.3497654 1.0000000 0.4061576 0.2460109
## [3,] 0.2550082 0.4061576 1.0000000 0.3127620
## [4,] 0.1611466 0.2460109 0.3127620 1.0000000</code></pre>
</div>
<div id="fit-model" class="section level2">
<h2 class="hasAnchor">
<a href="#fit-model" class="anchor"></a>Fit model</h2>
<p>Fit broken stick model, with knots specified at ages <code>1:4</code>.</p>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"brokenstick"</span>)</pre></body></html></div>
<pre><code>## Registered S3 method overwritten by 'pryr':
##   method      from
##   print.bytes Rcpp</code></pre>
<div class="sourceCode" id="cb13"><html><body><pre class="r"><span class="no">knots</span> <span class="kw">&lt;-</span> <span class="fl">1</span>:<span class="fl">3</span>
<span class="no">boundary</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>, <span class="fl">4</span>)
<span class="no">fit</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/brokenstick.html">brokenstick</a></span>(<span class="no">X1</span> ~ <span class="no">age</span> <span class="kw">|</span> <span class="no">subject</span>, <span class="no">data</span>,
                   <span class="kw">knots</span> <span class="kw">=</span> <span class="no">knots</span>, <span class="kw">boundary</span> <span class="kw">=</span> <span class="no">boundary</span>)</pre></body></html></div>
<pre><code>## Warning: number of observations (=40000) &lt;= number of random effects (=40000)
## for term (0 + age_1 + age_2 + age_3 + age_4 | subject); the random-effects
## parameters and the residual variance (or scale parameter) are probably
## unidentifiable</code></pre>
<pre><code>## Warning in checkConv(attr(opt, "derivs"), opt$par, ctrl = control$checkConv, :
## Model failed to converge with max|grad| = 0.00852341 (tol = 0.002, component 1)</code></pre>
<div class="sourceCode" id="cb16"><html><body><pre class="r"><span class="no">omega</span> <span class="kw">&lt;-</span> <span class="no">fit</span>$<span class="no">omega</span>
<span class="no">beta</span> <span class="kw">&lt;-</span> <span class="no">fit</span>$<span class="no">beta</span>
<span class="no">sigma2</span> <span class="kw">&lt;-</span> <span class="no">fit</span>$<span class="no">sigma2</span>
<span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="no">beta</span>, <span class="fl">2</span>)</pre></body></html></div>
<pre><code>## age_1 age_2 age_3 age_4 
## -0.02 -0.02  0.01  0.01</code></pre>
<div class="sourceCode" id="cb18"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="no">sigma2</span>, <span class="fl">4</span>)</pre></body></html></div>
<pre><code>## [1] 0.8184</code></pre>
<div class="sourceCode" id="cb20"><html><body><pre class="r"><span class="co"># correlation random effects</span>
<span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="no">covar</span>, <span class="fl">3</span>)</pre></body></html></div>
<pre><code>##      [,1] [,2] [,3] [,4]
## [1,]  1.0  0.7  0.5  0.3
## [2,]  0.7  1.0  0.8  0.5
## [3,]  0.5  0.8  1.0  0.6
## [4,]  0.3  0.5  0.6  1.0</code></pre>
<div class="sourceCode" id="cb22"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="no">omega</span>, <span class="fl">2</span>)</pre></body></html></div>
<pre><code>##       age_1 age_2 age_3 age_4
## age_1  1.23  0.71  0.52  0.33
## age_2  0.71  1.16  0.82  0.49
## age_3  0.52  0.82  1.22  0.63
## age_4  0.33  0.49  0.63  1.17</code></pre>
<div class="sourceCode" id="cb24"><html><body><pre class="r"><span class="co"># covariances measured data</span>
<span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="no">omega</span> + <span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span>(<span class="no">sigma2</span>, <span class="fl">4</span>), <span class="fl">3</span>)</pre></body></html></div>
<pre><code>##       age_1 age_2 age_3 age_4
## age_1 2.052 0.706 0.521 0.326
## age_2 0.706 1.982 0.816 0.489
## age_3 0.521 0.816 2.034 0.630
## age_4 0.326 0.489 0.630 1.992</code></pre>
<div class="sourceCode" id="cb26"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cov</a></span>(<span class="no">broad</span>), <span class="fl">3</span>)</pre></body></html></div>
<pre><code>##       [,1]  [,2]  [,3]  [,4]
## [1,] 2.052 0.706 0.521 0.326
## [2,] 0.706 1.982 0.816 0.489
## [3,] 0.521 0.816 2.034 0.630
## [4,] 0.326 0.489 0.630 1.992</code></pre>
<div class="sourceCode" id="cb28"><html><body><pre class="r"><span class="co"># convert to time-to-time correlation matrix</span>
<span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cov2cor</a></span>(<span class="no">omega</span> + <span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span>(<span class="no">sigma2</span>, <span class="fl">4</span>)), <span class="fl">3</span>)</pre></body></html></div>
<pre><code>##       age_1 age_2 age_3 age_4
## age_1 1.000 0.350 0.255 0.161
## age_2 0.350 1.000 0.406 0.246
## age_3 0.255 0.406 1.000 0.313
## age_4 0.161 0.246 0.313 1.000</code></pre>
<div class="sourceCode" id="cb30"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cor</a></span>(<span class="no">broad</span>), <span class="fl">3</span>)</pre></body></html></div>
<pre><code>##       [,1]  [,2]  [,3]  [,4]
## [1,] 1.000 0.350 0.255 0.161
## [2,] 0.350 1.000 0.406 0.246
## [3,] 0.255 0.406 1.000 0.313
## [4,] 0.161 0.246 0.313 1.000</code></pre>
</div>
<div id="conclusions" class="section level2">
<h2 class="hasAnchor">
<a href="#conclusions" class="anchor"></a>Conclusions</h2>
<ol style="list-style-type: decimal">
<li>If <span class="math inline">\(\sigma^2=0\)</span>, then <span class="math inline">\(\Omega\)</span> reproduces correlations between <span class="math inline">\(y\)</span>’s correctly. However, the estimate of <span class="math inline">\(\sigma^2\)</span> is too high.</li>
<li>If <span class="math inline">\(\sigma^2 &gt; 0\)</span>, then <span class="math inline">\(\Omega\)</span> overestimates the correlations between <span class="math inline">\(y\)</span>’s, but correctly estimates the covariance among the random effects.</li>
<li>If <span class="math inline">\(\sigma^2 &gt; 0\)</span>, then <span class="math inline">\(\Omega + \hat\sigma^2 I(n_i)\)</span> correctly estimates the covariances between <span class="math inline">\(y\)</span>’s. This can be converted by <code><a href="https://rdrr.io/r/stats/cor.html">cov2cor()</a></code> to the time-to-time correlation matrix.</li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Stef van Buuren.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
