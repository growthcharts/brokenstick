<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Broken Stick Model for Irregular Longitudinal Data • brokenstick</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Broken Stick Model for Irregular Longitudinal Data">
<meta property="og:description" content="brokenstick">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">brokenstick</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.77.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/brokenstick-article.html">Broken Stick Model for Irregular Longitudinal Data</a>
    </li>
    <li>
      <a href="../articles/gettingstarted.html">Getting started</a>
    </li>
    <li>
      <a href="../articles/mainfunctions.html">Overview of main functions</a>
    </li>
    <li>
      <a href="../articles/oldfriends.html">Help for old friends</a>
    </li>
    <li>
      <a href="../articles/perfectmodel.html">Check perfect model</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/stefvanbuuren/brokenstick/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="brokenstick-article_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Broken Stick Model for Irregular Longitudinal Data</h1>
                        <h4 class="author">Stef van Buuren</h4>
            
            <h4 class="date">2020-10-13</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/stefvanbuuren/brokenstick/blob/master/vignettes/brokenstick-article.Rmd"><code>vignettes/brokenstick-article.Rmd</code></a></small>
      <div class="hidden name"><code>brokenstick-article.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>Most longitudinal studies plan data collection to occur at a fixed set of time points. In practice, the realised times can differ - sometimes substantially - from the scheduled times. There may be many reasons for such differences. For example, we planned a visit in the weekend or during a holiday, the subject didn’t show up, the measurement device was out of order, or the investigator got ill. Varying observation times may also result from combining data from multiple studies, each collected according to its own design. Timing variation can be substantial in observational studies, especially if the survey lacks a pre-specified schedule. Longitudinal data with timing differences between subjects are said to be <em>irregular</em>.</p>
<p>Irregular observation times present significant challenges for quantitative analysis. For example, it isn’t easy to calculate the time-to-time correlation matrix if the data spread thinly over time. It might also be complex to predict the future from past data if subject times differ. Observation times may also relate to the process of interest. For example, more severe patients get more frequent measurements; unmotivated cohort members respond more rarely, and so on. Conventional methods like MANOVA, regression or cluster analysis break down if observation times differ or if drop-out is selective.</p>
<p>While irregular observation times occur all over science, there is no universal or principled approach to resolve the problem. One straightforward fix is to take only those dates for which data are available (e.g., dates when stocks are traded), thus ignoring the times when markets are closed. One may also create bins of time intervals around the planned times, thereby ignoring within-period differences. Another ad-hoc method is to predict the value at the scheduled time from neighbouring data, e.g. by linear interpolation or smoothing, typically reducing the variability in the data. Some quick fixes create data sets where the timing problem seems to have “gone away”, which may tempt the analyst to ignore the potential effects of data patch-up on the substantive conclusions. While convenient and straightforward, the thoughtless application of these fixes introduces significant spurious relations over time, especially if the spacing of observations is highly irregular.<span class="citation">(Rehfeld et al. 2011)</span> Binning can lead to “surprisingly large” biases.<span class="citation">(Towers 2014)</span> If timing variation is related to the outcome of interest, these methods may result in biased estimates and exaggerated claims.<span class="citation">(Pullenayegum and Lim 2016)</span></p>
<p>The linear mixed model for longitudinal data <span class="citation">(Laird and Ware 1982; Fitzmaurice, Laird, and Ware 2011)</span> is the standard for the analysis of irregular data. The longitudinal mixed model represents each subject’s observed curve by a parametric function of time. The parameter estimates of the function are specific to each subject and modelled as random effects. The linear mixed model is highly useful for irregular data since it borrows strength across different realisations of the same process, summarising each trajectory by a small number of parameters that vary over subjects. The analyst can break down the distribution of these random effects as a function of individual characteristics. The linear mixed model is attractive when the number of measurements differs between individuals, or when the measurements are taken at different times.</p>
<p>This paper explores the use of the <em>broken stick model</em> as a method to transform irregularly observed data into <em>repeated measures</em>. The broken stick model describes a curve by a series of connected straight lines. The model has a long history and is known under many other names, amongst others, <em>segmented straight lines</em> <span class="citation">(Bellman and Roth 1969)</span>, <em>piecewise regression</em> <span class="citation">(Toms and Lesperance 2003)</span>, <em>structural change models</em> <span class="citation">(Bai and Perron 2003)</span>, <em>broken line smoothing</em> <span class="citation">(Koutsoyiannis 2000)</span> and <em>segmented regression</em> <span class="citation">(Lerman 1980)</span>. The term <em>broken stick</em> goes back to at least <span class="citation">MacArthur (1957)</span>, who used to it in an analogy to indicate the abundances of species. Most of the literature on the broken stick model concentrates on the problem of finding optimal times at which the lines should connect. Instead, the present paper will focus on the problem of summarising irregular individual trajectories by estimates made at a <em>pre-specified time grid</em>. This time grid is identical for all individuals, but it needs not to be equidistant. Our model formulation is a special case of the linear mixed model, with time modelled as a set of random effects coded as a linear B-spline and with subjects as the grouping factor. The output of the transformation is a set of repeated measures, where every subject obtains a score on every time point.</p>
<p>Substantive researchers often favour repeated measures over the use of linear mixed models because of simplicity. For example, with repeated measures data, we can easily fit a subject-level model to predict future outcomes conditional on earlier data. While such simple regression models may be less efficient than modelling the full data <span class="citation">(Diggle et al. 2002, Sec. 6.1)</span>, increased insight may be more valuable than increased precision.</p>
<p>The broken stick model requires a specification of a sensible set of time points at which the measurements ideally should have been taken. For each subject, the model predicts or imputes hypothetical observations at those times. We apply the substantive analysis to the repeated measures instead of to the irregular data. This strategy is akin to Diggle’s multi-stage approach model-fitting approach <span class="citation">(Diggle 1988)</span>. The envisioned two-step analytic process aims to provide the best of both worlds.</p>
<p>Some applications of the broken stick model are:</p>
<ul>
<li>to approximate individual trajectories by a series of connected straight lines;</li>
<li>to align irregularly observed curves to a common age grid;</li>
<li>to impute realisations of individual trajectories;</li>
<li>to estimate the time-to-time correlation matrix;</li>
<li>to predict future observations.</li>
</ul>
<p>My original motivation for developing the broken stick model was to facilitate the statistical analysis and testing of critical ages in the onset of childhood obesity <span class="citation">(de Kroon et al. 2010)</span>, with extensions to multiple imputation <span class="citation">(van Buuren 2018)</span>. <span class="citation">Anderson et al. (2019)</span> recommend the broken stick model because of good accuracy and ease of interpretation.</p>
<p>The present paper highlights various computational tools from the  package. The package contains tools to fit the broken stick model to data, to export the parameters of the fitted model for use outside the package, to create imputed values of the model, and to predict broken stick estimates for new data. Also, the text illustrates how the tool helps to solve various analytic problems.</p>
</div>
<div id="illustration-of-broken-stick-model" class="section level1">
<h1 class="hasAnchor">
<a href="#illustration-of-broken-stick-model" class="anchor"></a>Illustration of broken stick model</h1>
<p>As a first step, let us study the variation in the age of measurement of 200 children from the SMOCC study <span class="citation">(Herngreen et al. 1994)</span>. <span class="citation">Lokku et al. (2020)</span> suggest the <em>abacus plot</em> to visualise this variation.</p>
<div class="figure">
<img src="brokenstick-article_files/figure-html/visits-1.png" alt="Abacus plot of observation times for the first 20 children of the SMOCC data." width="100%"><p class="caption">
Abacus plot of observation times for the first 20 children of the SMOCC data.
</p>
</div>
<p>The blue points in Figure 1 indicate the observation times. In general, the blue points are close to the scheduled ages (indicated by vertical lines), especially in the first half year. Observation times vary more for older children. Several children have one or more missing visits (e.g. 10002, 10008, 10024). Some children (10012, 10015) had fairly close visits. Child 10028 dropped out after month 9.</p>
<p>Let us fit two models, with two and nine lines respectively, to the standard deviation score (SDS) of body length.</p>
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="va">ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">10001</span>, <span class="fl">10005</span>, <span class="fl">10022</span><span class="op">)</span>
<span class="va">fit2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/brokenstick.html">brokenstick</a></span><span class="op">(</span><span class="va">hgt.z</span> <span class="op">~</span> <span class="va">age</span> <span class="op">|</span> <span class="va">id</span>, <span class="va">smocc_200</span>, knots <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span>
<span class="va">knots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.0833</span>, <span class="fl">0.1667</span>, <span class="fl">0.25</span>, <span class="fl">0.5</span>, <span class="fl">0.75</span>, <span class="fl">1</span>, <span class="fl">1.25</span>, <span class="fl">1.5</span>, <span class="fl">2</span><span class="op">)</span>
<span class="va">fit9</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/brokenstick.html">brokenstick</a></span><span class="op">(</span><span class="va">hgt.z</span> <span class="op">~</span> <span class="va">age</span> <span class="op">|</span> <span class="va">id</span>, <span class="va">smocc_200</span>, 
                    knots <span class="op">=</span> <span class="va">knots</span>, boundary <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span>
<span class="va">m2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">fit2</span>, <span class="va">smocc_200</span>, group <span class="op">=</span> <span class="va">ids</span>,
           xlab <span class="op">=</span> <span class="st">"Age (years)"</span>, ylab <span class="op">=</span> <span class="st">"Length (SDS)"</span><span class="op">)</span>
<span class="va">m9</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">fit9</span>, <span class="va">smocc_200</span>, group <span class="op">=</span> <span class="va">ids</span>,
           xlab <span class="op">=</span> <span class="st">"Age (years)"</span>, ylab <span class="op">=</span> <span class="st">"Length (SDS)"</span><span class="op">)</span>
<span class="fu">gridExtra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html">grid.arrange</a></span><span class="op">(</span><span class="va">m2</span>, <span class="va">m9</span>, nrow <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></pre></div>
<pre><code>## Warning in checkConv(attr(opt, "derivs"), opt$par, ctrl = control$checkConv, :
## Model failed to converge with max|grad| = 0.00772396 (tol = 0.002, component 1)</code></pre>
<div class="figure">
<img src="brokenstick-article_files/figure-html/plotfit2x-1.png" alt="Broken stick model with two (top) and nine (bottom) line segments for three children. Blue = observed data, Red = Fitted broken stick curves." width="100%"><p class="caption">
Broken stick model with two (top) and nine (bottom) line segments for three children. Blue = observed data, Red = Fitted broken stick curves.
</p>
</div>
<p>Figure 2 shows the individual trajectories of three children. The blue points coincide with the observed data, whereas the red curves are calculated according to the broken stick model.</p>
<p>There are fitted two models. The simpler model (top) uses just two line segments. The first line starts at birth and ends at the age of exactly 1 years. The second line spans the period between 1 to 2 years. Note that the two lines connect at the breakpoint, the age of 1 year. The red curves for the two-line model are a crude approximation to the data.</p>
<p>We can create a better model by setting breakpoints equal to the scheduled ages. Since there are 10 scheduled ages, we construct nine straight lines. In contrast to the two-line model, the nine-line broken stick model is sensitive to small bumps in the observed trajectory and closely fits the empirical data. The residual variance of the nine-line model is low (0.059), and the proportion of explained variance in SDS is high, 0.98.</p>
<p>While the observation times in the data differ between children, the broken stick curves use identical time points across subjects. The idea is now that we can add the broken stick estimates to the child-level data by a long-to-wide conversion, and analyse supplemented columns as repeated measures. A repeated measures analysis is usually simpler than the equivalent for the temporally misaligned data. For example, it is easy to calculate mean profiles for arbitrary groups, estimate the time-to-time covariance matrix or to build predictive models at the child level. See <span class="citation">Hand and Taylor (1987)</span> for a lucid overview of linear techniques for repeated measures.</p>
</div>
<div id="methodology" class="section level1">
<h1 class="hasAnchor">
<a href="#methodology" class="anchor"></a>Methodology</h1>
<div id="notation" class="section level2">
<h2 class="hasAnchor">
<a href="#notation" class="anchor"></a>Notation</h2>
<p>We adopt the notation of <span class="citation">Fitzmaurice, Laird, and Ware (2011)</span>. Let <span class="math inline">\(Y_{ij}\)</span> denote the response variable for the <span class="math inline">\(i^{\rm th}\)</span> subject on the <span class="math inline">\(j^{\rm th}\)</span> measurement occasion at time <span class="math inline">\(t_{ij}\)</span>. Data are collected in a sample of <span class="math inline">\(N\)</span> persons <span class="math inline">\(i=1,\dots,N\)</span>. Let repeated measurements for the <span class="math inline">\(i^{\rm th}\)</span> subject be grouped as <span class="math display">\[ Y_i = \left( \begin{array} {l} Y_{i1} \\ Y_{i2} \\ \vdots \\ Y_{in_i} \end{array} \right), \quad i = 1, \dots, N.\]</span> If the measures have been observed at a common same set of occasions, then we could drop the index <span class="math inline">\(i\)</span> in <span class="math inline">\(t_{ij}\)</span> since <span class="math inline">\(t_{ij} = t_j\)</span> for all <span class="math inline">\(i = 1, \dots, N\)</span>. Here we will focus on the case that <span class="math inline">\(t_{ij}\)</span> varies over <span class="math inline">\(i\)</span>.</p>
<p>In addition, let use define the <span class="math inline">\(n_i \times p\)</span> matrices <span class="math display">\[ X_i = \left( \begin{array} {llll} 
X_{i11} &amp; X_{i12} &amp; \cdots &amp; X_{i1p} \\
X_{i21} &amp; X_{i22} &amp; \cdots &amp; X_{i2p} \\
\vdots  &amp; \vdots  &amp; \ddots &amp; \vdots  \\
X_{in_i1} &amp; X_{in_i2} &amp; \cdots &amp; X_{in_ip}
\end{array} \right), \quad i = 1, \dots, N,\]</span> so that the rows of <span class="math inline">\(X_i\)</span> contain <span class="math inline">\(p\)</span> covariates associated with the responses at <span class="math inline">\(n_i\)</span> measurement occasions. The columns may be time-varying covariates. If a certain covariate is fixed in time (e.g. sex, treatment, education), then all values within the corresponding column in <span class="math inline">\(X_i\)</span> are identical.</p>
</div>
<div id="broken-stick-model" class="section level2">
<h2 class="hasAnchor">
<a href="#broken-stick-model" class="anchor"></a>Broken stick model</h2>
<p>The broken stick model avoids modeling observation times <span class="math inline">\(t_{ij}\)</span> directly by representing each <span class="math inline">\(t_{ij}\)</span> as its relative position within a time interval. For example, suppose <span class="math inline">\(t_{ij} = 0.6\)</span> years and that the time interval is given by 0.5-1.0 years. The position relative to the left break age is <span class="math inline">\(x_{\rm left} = (1.0-0.6)/(1.0-0.5) = 0.8\)</span>, whereas relative to the right break age is <span class="math inline">\(x_{\rm right} = (0.6-0.5)/(1.0-0.5) = 0.2\)</span>. In order to fit the broken stick model, we need to replace time point <span class="math inline">\(t_{ij} = 0.6\)</span> by two values: 0.8 (for break age 0.5), and 0.2 (for break age 1.0). Note that both values add up to 1. Coding time in this way simplifies modeling continuous time by a set of discrete break ages.</p>
<p>More specifically, let <span class="math inline">\(t_{ij}\)</span> be coded by a second-order (linear) B-spline using <span class="math inline">\(k\)</span> internal knots <span class="math inline">\(\kappa\)</span> placed at <span class="math inline">\(k+1\)</span> ordered ages <span class="math display">\[
\kappa_0 = \kappa_1 &lt; \dots &lt; \kappa_k &lt; \kappa_{k+1}
\]</span> The internal knots <span class="math inline">\(\kappa_1, \dots, \kappa_k\)</span> correspond to the set of ages for which we obtain broken stick estimates, and it could be specified by the user. The left boundary knot <span class="math inline">\(\kappa_0 = \kappa_1\)</span> is left-anchored to the minimum time <span class="math inline">\(\min(t_{ij})\)</span> in the data. This point defines the starting event of the participant, such as birth or study enrolment. The right hand boundary knot is <span class="math inline">\(\kappa_{k+1} \geq \max(t_{ij})\)</span>.</p>
<p>The second-order B-spline <span class="citation">(de Boor 1978, 32)</span>, <span class="math display">\[
H_s(t) = \left\{ \begin{array} {l@{\quad,\quad}l}
(t-\kappa_{s-1})/(\kappa_s - \kappa_{s-1}) &amp; \kappa_{s-1} &lt; t \leq \kappa_s,\\
(\kappa_{s+1}-t)/(\kappa_{s+1} - \kappa_s) &amp; \kappa_s \leq t &lt; \kappa_{s+1},\\
0 &amp; {\rm otherwise.}
\end{array} \right. 
\]</span> is applied to <span class="math inline">\(t_{ij}\)</span> to obtain <span class="math inline">\((k+1)\)</span> transformed variables <span class="math inline">\(x_{is} = t_{ij}\)</span> with <span class="math inline">\(s = 1,\dots,k+1\)</span>. These variables can conveniently be grouped into the <span class="math inline">\(n_i \times (k+1)\)</span> matrix of covariates <span class="math inline">\(X_i = (x_{i1}, \dots, x_{ik}, x_{i(k+1)})\)</span>. Each row in <span class="math inline">\(X_i\)</span> has only one or two non-zero elements, which sum to 1.</p>
<p>Using this <span class="math inline">\(X_i\)</span>, the broken stick model is a special case (with <span class="math inline">\(Z_i = X_i\)</span>) of the two-stage random-effects model <span class="citation">(Laird and Ware 1982)</span></p>
<p><span class="math display">\[
Y_i = X_i\beta + X_ib_i + \epsilon_i
\]</span></p>
<p>where the <span class="math inline">\(k+1\)</span> column vector <span class="math inline">\(\beta\)</span> contains <span class="math inline">\(k+1\)</span> fixed effect coefficients common to all persons, where the <span class="math inline">\(k+1\)</span> column vector <span class="math inline">\(b_i\)</span> accomodates for <span class="math inline">\(k+1\)</span> subject-specific random parameters, and where the <span class="math inline">\(n_i\)</span> column vector <span class="math inline">\(\epsilon_i\)</span> holds subject-specific residuals.</p>
<p>In order to complete the model specification, we assume that the residuals are identically and independently distributed as <span class="math inline">\(\epsilon_i \sim N(0,\sigma^2 I(n_i))\)</span>, where <span class="math inline">\(\sigma^2\)</span> is a common variance parameter, and where <span class="math inline">\(I(n_i)\)</span> is the identity matrix of order <span class="math inline">\(n_i\)</span>. Thus, the equation represents population parameters (fixed effects), individual effects (random effects), and an amount of within-person dispersion that is the same for all persons. The section on estimation also considers a heterogeneous model that allows <span class="math inline">\(\sigma_i^2\)</span> to vary over subjects.</p>
<!-- The broken stick model is closely related to the two-stage random effects model. In the more general linear mixed model where $Z_i$ is a subset of $X_i$, we may partition the columns of $X_i$ into two mutually exclusive subsets: $X_i^{F}$ for fixed effects and $X_i^{R}$ with random effects. @fitzmaurice2011 (pp. 207) partition the linear mixed model as -->
<!-- $$ -->
<!-- Y_i = X_i^{F}\beta^{F} + X_i^{R}\beta_i^{R} + \epsilon_i. -->
<!-- $$ -->
<!-- Suppose we are interested to estimate the between-subject parameter $\beta^{F}$, e.g., the effect of a treatment. To do so, we first estimate the random effect broken stick model as the sum of a model for the between-subject  -->
<p>In summary, given the knot specification and the choice of the response scale, the parameters of the broken stick model are:</p>
<ul>
<li>
<span class="math inline">\(\beta\)</span>, a vector of <span class="math inline">\(k + 1\)</span> fixed parameters;</li>
<li>
<span class="math inline">\(\Omega\)</span>, a <span class="math inline">\((k+1) \times (k+1)\)</span> covariance matrix of the random effects;</li>
<li>
<span class="math inline">\(\sigma^2\)</span>, the within-person error variance.</li>
</ul>
<p>The total number of parameters for a solution with <span class="math inline">\(k\)</span> internal knots is thus equal to <span class="math inline">\((k^2 + 5k + 6)/2\)</span>. For example, a model of <span class="math inline">\(k = 3\)</span> knots (i.e. with two connected lines) has 15 parameters, a model with <span class="math inline">\(k = 4\)</span> has 21 parameters, and a model with <span class="math inline">\(k = 10\)</span> break ages has 78 parameters.</p>
</div>
<div id="model-assumptions" class="section level2">
<h2 class="hasAnchor">
<a href="#model-assumptions" class="anchor"></a>Model assumptions</h2>
<p>At the person level, we assume <span class="math inline">\(b_i \sim N(0, \Omega)\)</span>, i.e., the random coefficients of the subjects have a multivariate normal distribution with zero mean and a <span class="math inline">\((k+1) \times (k+1)\)</span> covariance matrix <span class="math inline">\(\Omega\)</span>. The base model allows the elements of <span class="math inline">\(\Omega\)</span> to vary freely. For time-dependent data, constrained versions for <span class="math inline">\(\Omega\)</span> are also of interest.<span class="citation">(Fitzmaurice, Laird, and Ware 2011, ch. 7)</span>. The estimation section highlights two such extensions. We also assume that the covariance between <span class="math inline">\(b_i\)</span> and <span class="math inline">\(\epsilon_i\)</span> is zero. For simplicity, this paper is restricted to the case where <span class="math inline">\(X_i\)</span> includes only time, and no other covariates. Also, we assume that <span class="math inline">\(X_i\)</span> has no missing data.</p>
<p>The broken stick model builds upon three main modeling assumptions:</p>
<ul>
<li>The trajectory between break ages follows a straight line. This assumption may fail for processes that are convex or concave in time. For example, human height growth in centimeters growth is concave, so setting breakpoints far apart results introduces systematic model bias. Modeling height SDS instead of raw height will prevent this bias.</li>
<li>The broken stick estimates follow a joint multivariate normal distribution. As this assumption may fail for skewed measurements, it could be beneficial to transform the outcomes so that their distribution will be closer to normal.</li>
<li>The data are <em>Missing at Random</em> (MAR) given the outcomes from all subjects at all observation times. This assumption is restrictive in the sense that missingness may only depend on the observed outcomes, and not on covariates other than time. At the same time, the assumption is liberal in the sense that the missingness may depend on future outcomes. While this MAR-future assumption is unusual in the literature on drop-out and observation time models, it is a sensible strategy for creating imputations that preserve relations over time, especially for intermittent missing data. Of course, the subsequent substantive analysis on the imputed data needs to be aware of the causal direction of time.</li>
</ul>
</div>
<div id="interpretation" class="section level2">
<h2 class="hasAnchor">
<a href="#interpretation" class="anchor"></a>Interpretation</h2>
<p>Given the model estimates and the person data, we can calculate the random effect <span class="math inline">\(b_i\)</span>. The <em>broken stick parameter</em> <span class="math inline">\(\gamma_{is} = \beta_s + b_{is}\)</span> is the subject-specific mean of <span class="math inline">\(Y_i\)</span> at time <span class="math inline">\(\kappa_s\)</span>, <span class="math inline">\(s = 1,\dots, k + 1\)</span>. The set of <span class="math inline">\(\gamma_{is}\)</span> parameters describes the mean response profile for subject <span class="math inline">\(i\)</span> by <span class="math inline">\(k\)</span> lines that connect at the <span class="math inline">\(k + 1\)</span> coordinates <span class="math inline">\((\kappa_s, \gamma_{is})\)</span>.</p>
<p>The broken stick parameter is the most likely value of outcome <span class="math inline">\(Y_i\)</span> for subject <span class="math inline">\(i\)</span> at time <span class="math inline">\(\kappa_s\)</span>. The parameter is the centre of the posterior predictive distribution for normal <span class="math inline">\(Y_i\)</span>. The two-sided <span class="math inline">\(100(1-\alpha)\%\)</span> prediction interval for the true, though often unobserved, value <span class="math inline">\(Y_{i,\kappa_s}\)</span> is equal to</p>
<p><span class="math display">\[
[Y_{i,\kappa_s}^{\rm lo}, Y_{i,\kappa_s}^{\rm hi}] = \gamma_{is} \pm t_{(1-\alpha/2;N-1)}\sigma,
\]</span> where <span class="math inline">\(t_{(1-\alpha/2;N-1)}\)</span> is the <span class="math inline">\(100(1-\alpha/2)\)</span> percentile of Student’s <span class="math inline">\(t\)</span>-distribution with <span class="math inline">\(N - 1\)</span> degrees of freedom. For example, the 50% prediction interval <span class="math inline">\(\gamma_{is} \pm 0.68\sigma\)</span> will contain 50% of true values. For normal <span class="math inline">\(Y_i\)</span>, the length of the 50% prediction interval is equivalent to the interquartile range (IQR). If the residual variation <span class="math inline">\(\sigma^2\)</span> is small (say <span class="math inline">\(\sigma^2 &lt; 0.1\)</span>), the IOR is about 0.22, so half of the true values will be within 0.22 SD of <span class="math inline">\(\gamma_{is}\)</span>, a small difference. For large <span class="math inline">\(\sigma^2\)</span> (e.g. <span class="math inline">\(\sigma^2 &gt; 0.2\)</span>), the <span class="math inline">\(\gamma_{i}\)</span> vector is a smoothed representation of <span class="math inline">\(Y_{i}\)</span>. While smoothness amplifies low-frequency features of the trajectories, it could also introduce biases in the subsequent analysis by suppressing high-frequency variation. In that case, the analyst needs to check whether this reduction in variation does not affect the parameters of substantive interest. We may restore high-frequency variation by adding random draws from the residual distribution <span class="math inline">\(N(0, \sigma^2)\)</span>. From there, it is a small step to multiple imputation, a well-developed methodology for drawing valid inferences from incomplete data.<span class="citation">(Rubin 1987; van Buuren 2018)</span></p>
<p>If <span class="math inline">\(n_i &gt;&gt; k\)</span> then the broken stick model provides a parsimonious representation of the measurements. Reversely, if <span class="math inline">\(n_i &lt;&lt; k\)</span> then the model infers plausible values for subject <span class="math inline">\(i\)</span> by building strength across persons. The broken stick model converts <span class="math inline">\(n_i\)</span> irregularly observed measurements into a new set of <span class="math inline">\(k\)</span> values <span class="math inline">\(\gamma_{is}\)</span> at common ages <span class="math inline">\(\kappa_1, ..., \kappa_k\)</span>, <span class="math inline">\(s = 1,\dots, k\)</span>.</p>
<p>Since each row in <span class="math inline">\(X_i\)</span> sums to unity, the broken stick model does not have a global intercept. The linear B-spline coding effectively replaces the global random intercept term by <span class="math inline">\(k + 1\)</span> <em>local intercepts</em>, one at each break age. The local intercept summarizes the information available in the adjacent left and right age intervals and ignores any information beyond the two adjacent knots. The broken stick estimates are thus primarily local. Outcome data observed outside the two adjacent age intervals influence the broken stick estimates only through the subject-level part of the model, in particular through <span class="math inline">\(\Omega\)</span>.</p>
</div>
<div id="estimation" class="section level2">
<h2 class="hasAnchor">
<a href="#estimation" class="anchor"></a>Estimation</h2>
<div id="parameter-estimation-method-lmer" class="section level3">
<h3 class="hasAnchor">
<a href="#parameter-estimation-method-lmer" class="anchor"></a>Parameter estimation, method lmer</h3>
<p>Estimation of the broken stick model relies on two well-developed  functions: <code><a href="https://rdrr.io/r/splines/bs.html">splines::bs()</a></code> <span class="citation">(R Core Team 2020)</span> and <code><a href="https://rdrr.io/pkg/lme4/man/lmer.html">lme4::lmer()</a></code>.<span class="citation">(Bates et al. 2015)</span> The following snippet illustrates how the <code>brokenstick::make.basis()</code> function calculates the matrix of <span class="math inline">\(B\)</span>-splines for the time variable <code>age</code>:</p>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">splines</span><span class="op">)</span>
<span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">brokenstick</span><span class="fu">::</span><span class="va"><a href="../reference/smocc_200.html">smocc_200</a></span>
<span class="va">brk</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>
<span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/splines/bs.html">bs</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">age</span>, knots <span class="op">=</span> <span class="va">brk</span>, Boundary.knots <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">3</span><span class="op">)</span>, degree <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"age"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">brk</span>, <span class="fl">3</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span>
<span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"id"</span>, <span class="st">"age"</span>, <span class="st">"hgt.z"</span><span class="op">)</span><span class="op">]</span>, <span class="va">X</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></pre></div>
<pre><code>##      id   age hgt.z age_0 age_0.5  age_1 age_2 age_3
## 1 10001 0.000  0.57  1.00    0.00 0.0000     0     0
## 2 10001 0.082  0.89  0.84    0.16 0.0000     0     0
## 3 10001 0.159  0.80  0.68    0.32 0.0000     0     0
## 4 10001 0.255  0.66  0.49    0.51 0.0000     0     0
## 5 10001 0.504  0.29  0.00    0.99 0.0076     0     0
## 6 10001 0.753 -0.40  0.00    0.49 0.5058     0     0</code></pre>
<p>The numerical example shows that the <code><a href="https://rdrr.io/r/splines/bs.html">bs()</a></code> function transforms the <code>age</code> variable into five columns, the <span class="math inline">\(B\)</span>-spline basis, with names like <code>age_0</code> and <code>age_0.5</code>. If <code>age</code> coincides with one of these (e.g., as in the top row), then the corresponding column receives a <code>1</code>. In all other cases, age distributes over two adjacent columns. To make things fit, we need an additional column (here <code>age_3</code>) at the last position, the right boundary knot. There is also a left boundary knot, and I have conveniently set that equal to the first breakpoint, marking the start of time. Setting <code>degree = 1</code> specifies a <span class="math inline">\(B\)</span>-spline gives the broken stick model its name and its characteristic shape.</p>
<p>To illustrate the second step of the calculations, we call <code><a href="https://rdrr.io/pkg/lme4/man/lmer.html">lme4::lmer()</a></code> as follows:</p>
<div class="sourceCode" id="cb5"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/lme4/lme4/">lme4</a></span><span class="op">)</span>
<span class="va">ctl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmerControl.html">.makeCC</a></span><span class="op">(</span><span class="st">"warning"</span>, tol <span class="op">=</span> <span class="fl">4e-3</span><span class="op">)</span>
<span class="va">f</span> <span class="op">&lt;-</span> <span class="va">hgt.z</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">age_0</span> <span class="op">+</span> <span class="va">age_0.5</span> <span class="op">+</span> <span class="va">age_1</span> <span class="op">+</span> <span class="va">age_2</span> <span class="op">+</span> <span class="va">age_3</span> <span class="op">+</span>
  <span class="op">(</span><span class="fl">0</span> <span class="op">+</span> <span class="va">age_0</span> <span class="op">+</span> <span class="va">age_0.5</span> <span class="op">+</span> <span class="va">age_1</span> <span class="op">+</span> <span class="va">age_2</span> <span class="op">+</span> <span class="va">age_3</span> <span class="op">|</span> <span class="va">id</span><span class="op">)</span>
<span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmer.html">lmer</a></span><span class="op">(</span><span class="va">f</span>, <span class="va">data</span>, 
            control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmerControl.html">lmerControl</a></span><span class="op">(</span>check.conv.grad <span class="op">=</span> <span class="va">ctl</span><span class="op">)</span><span class="op">)</span></pre></div>
<pre><code>## Warning in checkConv(attr(opt, "derivs"), opt$par, ctrl = control$checkConv, :
## Model failed to converge with max|grad| = 0.0066811 (tol = 0.004, component 1)</code></pre>
<div class="sourceCode" id="cb7"><pre class="downlit">
<span class="co">### fitted trajectories for all persons</span>
<span class="va">bse</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/lme4/man/ranef.html">ranef</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span><span class="op">$</span><span class="va">id</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/fixef.html">fixef</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">bse</span>, <span class="fl">3</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span></pre></div>
<pre><code>##       age_0 age_0.5  age_1  age_2  age_3
## 10001  0.77    0.26 -0.005  0.088 -0.148
## 10002 -0.27   -0.21 -0.465 -0.479 -0.052
## 10003  1.65    1.96  1.294  1.129 -1.323</code></pre>
<p>The broken stick estimates are the sum of the fixed and random effects. We need to remove the intercept as predictor rows all sum to 1. Warnings often occur when fitting broken stick models with <code><a href="https://rdrr.io/pkg/lme4/man/lmer.html">lme4::lmer()</a></code>. Here we have surpressed the warning <code>## Warning in checkConv(attr(opt, "derivs"), opt$par, ctrl = control$checkConv, : Model failed to converge with max|grad| = 0.0031397 (tol = 0.002, component 1)</code> by setting <code>tol</code> to a more relaxed value. I have found that the broken estimates still look sound and reasonable. Most of my experience derives for child growth data, so there is no guarantee that this apparent robustness will hold for other types of data. Warnings become less frequent for a lower number of breakpoints and larger samples sizes.</p>
<p>The  package can fit the same model in an easier way:</p>
<div class="sourceCode" id="cb9"><pre class="downlit">
<span class="va">ctl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/control_brokenstick.html">control_brokenstick</a></span><span class="op">(</span>
  lmer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmerControl.html">lmerControl</a></span><span class="op">(</span>check.conv.grad <span class="op">=</span> 
                       <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmerControl.html">.makeCC</a></span><span class="op">(</span><span class="st">"warning"</span>, tol <span class="op">=</span> <span class="fl">4e-3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/brokenstick.html">brokenstick</a></span><span class="op">(</span><span class="va">hgt.z</span> <span class="op">~</span> <span class="va">age</span> <span class="op">|</span> <span class="va">id</span>, data <span class="op">=</span> <span class="va">smocc_200</span>, 
                   knots <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>, boundary <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">3</span><span class="op">)</span>,
                   control <span class="op">=</span> <span class="va">ctl</span><span class="op">)</span></pre></div>
<pre><code>## Warning in checkConv(attr(opt, "derivs"), opt$par, ctrl = control$checkConv, :
## Model failed to converge with max|grad| = 0.0066811 (tol = 0.004, component 1)</code></pre>
<div class="sourceCode" id="cb11"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">mod</span>, <span class="va">smocc_200</span>, x <span class="op">=</span> <span class="st">"knots"</span>, shape <span class="op">=</span> <span class="st">"wide"</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span></pre></div>
<pre><code>## # A tibble: 3 x 6
##      id    `0`  `0.5`      `1`     `2`     `3`
##   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;
## 1 10001  0.772  0.259 -0.00513  0.0883 -0.148 
## 2 10002 -0.269 -0.206 -0.465   -0.479  -0.0524
## 3 10003  1.65   1.96   1.29     1.13   -1.32</code></pre>
</div>
<div id="parameter-estimation-method-kr" class="section level3">
<h3 class="hasAnchor">
<a href="#parameter-estimation-method-kr" class="anchor"></a>Parameter estimation, method kr</h3>
<p>The calculation time of <code><a href="https://rdrr.io/pkg/lme4/man/lmer.html">lme4::lmer()</a></code> rapidly increases with the number of random effects. More than ten random effects (knots) takes significant time, and beyond 15 knots is generally impossible to fit. The  package provides another alternative, the <em>Kasim-Raudenbush (KR) sampler</em> <span class="citation">(Kasim and Raudenbush 1998)</span>, which simulates draws from the posterior distributions of parameters from a two-level normal model with heterogeneous within-subject variances. The speed of the KR-Raudenbush sampler is almost insensitive to the number of random effects and depends primarily on the <em>total number of iterations</em>. The <code><a href="../reference/kr.html">brokenstick::kr()</a></code> function provides some reasonable defaults. The behaviour of the method has not been studied as well as <code><a href="https://rdrr.io/pkg/lme4/man/lmer.html">lmer()</a></code> and should still be considered experimental.</p>
<p>Apart from being faster, the KR-sampler opens up interesting analytic options:</p>
<ol style="list-style-type: decimal">
<li><p>It is relatively easy to constrain the fitted covariance of random effects, <span class="math inline">\(\Omega\)</span>, to a matrix of simple structure. Informing the sampler of the time-dependent structure of the random effect leads to stabler estimates of <span class="math inline">\(\Omega\)</span>. The package currently implements two <em>correlations models</em>. These models express the correlation <span class="math inline">\(\rho(t_1, t_2)\)</span> between two Z -scores <span class="math inline">\(Z_1\)</span> and <span class="math inline">\(Z_2\)</span> at successive ages <span class="math inline">\(t_1\)</span> and <span class="math inline">\(t_2\)</span> as a function of those ages. The <em>Argyle model</em> <span class="citation">(Argyle, Seheult, and Wooff 2008)</span> is <span class="math inline">\(\rho(t_1, t_2) = \exp(-\lambda|T_1-T_2|)\)</span>, where <span class="math inline">\(T_i = \log(\tau+t_i)\)</span> is a logarithmic rescaling of the time axis and <span class="math inline">\(\rho=exp(-\lambda)\)</span>. The Cole correlation model <span class="citation">(Cole 1995)</span> describes the Fisher-transformed correlation as a function of the average <span class="math inline">\((t_1+t_2)/2\)</span> and the difference <span class="math inline">\((t_2-t_1)\)</span>, including two multiplicative terms. Note that both models were proposed in the context of child growth, and have not been tested for other types of time-dependent data.</p></li>
<li><p>The KR-sampler fits the slightly more general linear-mixed model with heterogeneous within-subject variances, i.e. with a residual variance <span class="math inline">\(\sigma_i^2\)</span> per subject <span class="math inline">\(i\)</span> instead of the global residual <span class="math inline">\(\sigma^2\)</span>. This makes it easier to identify, study and weight subjects based on how well they fit the model.</p></li>
<li><p>A third option is to simulate imputations as an extra step to the KR-sampler. For subject with large <span class="math inline">\(\sigma_i^2\)</span>, the random effect estimates are a too smooth representation of the data, leading to inappropriate variance estimates when those estimates are analysed as “just data”. Section 11.3 of <span class="citation">van Buuren (2018)</span> pioneered a solution that constructs multiple trajectories by adding a proper amount of residual noise to random effect estimates. The variance estimation then proceeds according to the principles of multiple imputation.<span class="citation">(Rubin 1987)</span></p></li>
</ol>
</div>
<div id="random-effects-estimation" class="section level3">
<h3 class="hasAnchor">
<a href="#random-effects-estimation" class="anchor"></a>Random effects estimation</h3>
<p>Apart from parameter estimates of the broken stick model, we also need a way to estimate random effects for a given set of model estimates and (new) user data. There are several of such methods. The <code><a href="../reference/EB.html">brokenstick::EB()</a></code> function implements the empirical Bayes (EB) estimate, also known as BLUP (<span class="citation">Skrondal and Rabe‐Hesketh (2009)</span>, p. 683). The procedure can provide the broken stick estimates for new persons. It the workhorse of the more user-friendly <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code> method that takes fitted models objects.</p>
</div>
</div>
</div>
<div id="functionality" class="section level1">
<h1 class="hasAnchor">
<a href="#functionality" class="anchor"></a>Functionality</h1>
<div id="overview-of-brokenstick-package" class="section level2">
<h2 class="hasAnchor">
<a href="#overview-of-brokenstick-package" class="anchor"></a>Overview of brokenstick package</h2>
<p>The  package contains functions to fit, predict and plot data. The main functions in the <code>brokenstick</code> package are:</p>
<table class="table">
<thead><tr class="header">
<th>Function name</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code><a href="../reference/brokenstick.html">brokenstick()</a></code></td>
<td>Fit a broken stick model to irregular data</td>
</tr>
<tr class="even">
<td><code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code></td>
<td>Predict broken stick estimates for new data</td>
</tr>
<tr class="odd">
<td><code><a href="https://rdrr.io/r/graphics/plot.default.html">plot()</a></code></td>
<td>Plot individual trajectories</td>
</tr>
</tbody>
</table>
<p>The following functions are user-oriented helpers:</p>
<table class="table">
<thead><tr class="header">
<th>Function name</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code><a href="https://rdrr.io/r/stats/fitted.values.html">fitted()</a></code></td>
<td>Calculate fitted values</td>
</tr>
<tr class="even">
<td><code><a href="../reference/get_knots.html">get_knots()</a></code></td>
<td>Obtain the knots used by model</td>
</tr>
<tr class="odd">
<td><code><a href="../reference/get_r2.html">get_r2()</a></code></td>
<td>Obtain proportion of explained variance</td>
</tr>
<tr class="even">
<td><code><a href="https://rdrr.io/r/stats/residuals.html">residuals()</a></code></td>
<td>Extract residuals from model</td>
</tr>
</tbody>
</table>
<p>The following functions are responsible for calculations:</p>
<table class="table">
<thead><tr class="header">
<th>Function name</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code><a href="../reference/control_brokenstick.html">control_brokenstick()</a></code></td>
<td>Set controls to steer calculations</td>
</tr>
<tr class="even">
<td><code><a href="../reference/EB.html">EB()</a></code></td>
<td>Empirical Bayes predictor for random effects</td>
</tr>
<tr class="odd">
<td><code><a href="../reference/kr.html">kr()</a></code></td>
<td>Kasim-Raudenbush sampler for two-level model</td>
</tr>
<tr class="even">
<td><code><a href="../reference/make_basis.html">make_basis()</a></code></td>
<td>Create linear splines basis</td>
</tr>
</tbody>
</table>
<p>The package follows the <a href="https://tidymodels.github.io/model-implementation-principles/"></a> conventions. For example, the modelling object does not store the training data, whereas the convention dictates the variable names. The package architecture borrows important ideas from the  package.<span class="citation">(Vaughan and Kuhn 2020)</span></p>
</div>
<div id="data-preparation" class="section level2">
<h2 class="hasAnchor">
<a href="#data-preparation" class="anchor"></a>Data preparation</h2>
<p>Before we can fit the model, the data need to be in shape. Data preparation is often the most time-consuming part of the analysis. The <code><a href="../reference/brokenstick.html">brokenstick()</a></code> function takes tidy data in the long-form, with every observed subject-time combination in a row. This section uses the built-in <code>smocc_200</code> data, containing the heights of 200 children measured at ten visits up to two years.<span class="citation">(Herngreen et al. 1994)</span></p>
<div class="sourceCode" id="cb13"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/stefvanbuuren/brokenstick">brokenstick</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">smocc_200</span>, <span class="fl">3</span><span class="op">)</span></pre></div>
<pre><code>## # A tibble: 3 x 7
##      id    age sex       ga    bw   hgt hgt.z
##   &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1 10001 0      female    40  3960  52   0.575
## 2 10001 0.0821 female    40  3960  55.6 0.888
## 3 10001 0.159  female    40  3960  58.2 0.797</code></pre>
</div>
<div id="calculate-z-scores" class="section level2">
<h2 class="hasAnchor">
<a href="#calculate-z-scores" class="anchor"></a>Calculate Z-scores</h2>
<p>The broken stick model can fit observations in either the raw scale (cm, kg, and so on) or as a standard deviation score (SDS), or <span class="math inline">\(Z\)</span>-score. The results from the analysis of the <span class="math inline">\(Z\)</span>-score is preferable for several reasons:</p>
<ol style="list-style-type: decimal">
<li>for growth curves, a straight line assumption is more plausible in the <span class="math inline">\(Z\)</span>-score scale;</li>
<li>observations in the <span class="math inline">\(Z\)</span>-score scale are closer to multivariate normality;</li>
<li>analysis of <span class="math inline">\(Z\)</span>-scores highlights the interesting variation within and between children;</li>
<li>fitting <span class="math inline">\(Z\)</span>-score data leads to fewer convergence issues.</li>
</ol>
<p>It is easy to convert the measurements into the <span class="math inline">\(Z\)</span>-score scale, fit the model, and convert back to the raw scale afterwards, if desired. There are several  packages that assist in the calculations: <a href="https://CRAN.R-project.org/package=AGD"></a>, <a href="https://CRAN.R-project.org/package=anthro"></a>, <a href="https://CRAN.R-project.org/package=childsds"></a>, <a href="https://github.com/ki-tools/growthstandards"></a> and <a href="https://CRAN.R-project.org/package=zscorer"></a>.</p>
<p>The <code>smocc_200</code> data contains the height measurement both in the original scale in cm (<code>hgt</code>) and the <span class="math inline">\(Z\)</span>-score scale (<code>hgt.z</code>) relative to the height references from the Fourth Dutch Growth study <span class="citation">(Fredriks et al. 2000)</span>. Let us recalculate height SDS using the  package. Fortunately, we find that the same values.</p>
<div class="sourceCode" id="cb15"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/stefvanbuuren/AGD">AGD</a></span><span class="op">)</span>
<span class="va">z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">smocc_200</span>, <span class="fu"><a href="https://rdrr.io/pkg/AGD/man/y2z.html">y2z</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">hgt</span>, 
                         x <span class="op">=</span> <span class="va">age</span>, 
                         sex <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">sex</span> <span class="op">==</span> <span class="st">"male"</span>, <span class="st">"M"</span>, <span class="st">"F"</span><span class="op">)</span>, 
                         ref <span class="op">=</span> <span class="va">nl4.hgt</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/identical.html">identical</a></span><span class="op">(</span><span class="va">z</span>, <span class="va">smocc_200</span><span class="op">$</span><span class="va">hgt.z</span><span class="op">)</span></pre></div>
<pre><code>## [1] FALSE</code></pre>
<div class="figure">
<img src="brokenstick-article_files/figure-html/zscores-1.png" alt="Distribution of height SDS for 200 Dutch children." width="100%"><p class="caption">
Distribution of height SDS for 200 Dutch children.
</p>
</div>
<p>Figure 3 shows that, as expected, the empirical Z-score distribution is close to the standard normal. The few very extremely low heights correspond to pre-term born infants. The next section concentrate on modelling <code>hgt.z</code>.</p>
<p>Function <code><a href="https://rdrr.io/pkg/AGD/man/z2y.html">z2y()</a></code> applies the inverse transformation of <span class="math inline">\(Z\)</span>-scores to the original scale. The following snippet converts <code>hgt.z</code> into the cm scale.</p>
<div class="sourceCode" id="cb17"><pre class="downlit">
<span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">smocc_200</span>, <span class="fu"><a href="https://rdrr.io/pkg/AGD/man/z2y.html">z2y</a></span><span class="op">(</span>z <span class="op">=</span> <span class="va">hgt.z</span>, 
                         x <span class="op">=</span> <span class="va">age</span>, 
                         sex <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">sex</span> <span class="op">==</span> <span class="st">"male"</span>, <span class="st">"M"</span>, <span class="st">"F"</span><span class="op">)</span>, 
                         ref <span class="op">=</span> <span class="va">nl4.hgt</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/all.equal.html">all.equal</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">smocc_200</span><span class="op">$</span><span class="va">hgt</span>, tol <span class="op">=</span> <span class="fl">0.0001</span><span class="op">)</span></pre></div>
<pre><code>## [1] "Mean relative difference: 0.003"</code></pre>
<p>We have used the Dutch 1997 height references here, but there are more choices. The  package also supports the WHO Child Growth Standards.</p>
<p>In practice we found that the model fit is often better when applied to <span class="math inline">\(Z\)</span>-scores. Age-conditional references are common in child growth exists, but could be rare in other fields. An alternative is to apply the broken stick model to the standardized residuals of a preliminary non-linear regression of the outcome on time.</p>
</div>
<div id="model-fitting" class="section level2">
<h2 class="hasAnchor">
<a href="#model-fitting" class="anchor"></a>Model fitting</h2>
<div class="figure">
<img src="brokenstick-article_files/figure-html/plotsds-1.png" alt="Length growth of 52 infants expressed in the Z-score scale." width="100%"><p class="caption">
Length growth of 52 infants expressed in the Z-score scale.
</p>
</div>
<p>Figure 4 displays the growth curves of a subset of 52 children. The <span class="math inline">\(Z\)</span>-score transformation takes away the major time trend, so all trajectories are more or less flat. This display allows us to see an extremely detailed assessment of individual growth. Note how the measurements cluster around ten ages: birth, 1, 2, 3, 6, 9, 12, 15, 18 and 24 months. While the data collectors rigorously followed the study design, variation in timing is inevitable because of weekends, holidays, sickness, and other events.</p>
<div id="fit-one-line" class="section level3">
<h3 class="hasAnchor">
<a href="#fit-one-line" class="anchor"></a>Fit one line</h3>
<p>As a start, let us fit a simple model with just one line anchored at the minimum and maximum age.</p>
<div class="sourceCode" id="cb19"><pre class="downlit">
<span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/brokenstick.html">brokenstick</a></span><span class="op">(</span><span class="va">hgt.z</span> <span class="op">~</span> <span class="va">age</span> <span class="op">|</span> <span class="va">id</span>, <span class="va">smocc_200</span><span class="op">)</span>
<span class="va">ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">10001</span>, <span class="fl">10005</span>, <span class="fl">10022</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">fit</span>, new_data <span class="op">=</span> <span class="va">data</span>, group <span class="op">=</span> <span class="va">ids</span>, what <span class="op">=</span> <span class="st">"all"</span>,
     xlab <span class="op">=</span> <span class="st">"Age (years)"</span>, ylab <span class="op">=</span> <span class="st">"Length (cm)"</span><span class="op">)</span></pre></div>
<div class="figure">
<img src="brokenstick-article_files/figure-html/line1-1.png" alt="Simple linear model with one line anchored at the extremes." width="100%"><p class="caption">
Simple linear model with one line anchored at the extremes.
</p>
</div>
<p>Figure 5 shows the observed (blue) and fitted (red) trajectories of three selected children. Note that this model can only capture the overall age trend. As a result, the approximation to the data is quite bad.</p>
</div>
<div id="fit-two-lines" class="section level3">
<h3 class="hasAnchor">
<a href="#fit-two-lines" class="anchor"></a>Fit two lines</h3>
<p>We now extend to two connected lines. The first line should start at birth and end at the age of one year. The second line spans the period between one to two years. The lines must connect at the age of one year. We estimate and plot the model as follows:</p>
<div class="sourceCode" id="cb20"><pre class="downlit">
<span class="va">fit2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/brokenstick.html">brokenstick</a></span><span class="op">(</span><span class="va">hgt.z</span> <span class="op">~</span> <span class="va">age</span> <span class="op">|</span> <span class="va">id</span>, <span class="va">smocc_200</span>, knots <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">fit2</span>, <span class="va">data</span>, group <span class="op">=</span> <span class="va">ids</span>, 
     xlab <span class="op">=</span> <span class="st">"Age (years)"</span>, ylab <span class="op">=</span> <span class="st">"Length (SDS)"</span><span class="op">)</span></pre></div>
<div class="figure">
<img src="brokenstick-article_files/figure-html/plotfit2z-1.png" alt="Broken stick model with two lines." width="100%"><p class="caption">
Broken stick model with two lines.
</p>
</div>
<p>The <code>fit2</code> object holds the parameter estimates of the model:</p>
<div class="sourceCode" id="cb21"><pre class="downlit">
<span class="va">fit2</span></pre></div>
<pre><code>## Class: brokenstick (lmer)
## Knots: 0 1 2 2.7 
## Means: 0.09 0.04 0.09 0.12 
## Variance-covariance matrix:
##            age_0 age_1 age_2 age_2.6776
## age_0       0.83                       
## age_1       0.42   0.8                 
## age_2       0.44  0.76  0.83           
## age_2.6776 -0.19  0.12  0.23       0.29
## Residual variance:  0.18</code></pre>
<p>The printed output lists the knots of the model at 0, 1, 2 and 2.6776 years. The left and right boundaries are located at 0 and 2.6776, respectively. The <code>means</code> entry lists the fixed effect estimates, which we interpret as the average SDS per time point. The time-to-time variance-covariance matrix cover four random effects (3 visits + 1 end knot). The residual variance measures the variability of the discrepancies between the model and the observed data. These three parameters (fixed, random, residual variance) are well interpretable and fully record the fitted broken stick model.</p>
</div>
<div id="fit-nine-lines" class="section level3">
<h3 class="hasAnchor">
<a href="#fit-nine-lines" class="anchor"></a>Fit nine lines</h3>
<p>The two-line model does not fit well. We substantially refine the model by adding a knot for each scheduled visit. To make model specification independent of the data, we specify the right boundary as a constant of three years. We code and run the model as</p>
<div class="sourceCode" id="cb23"><pre class="downlit">
<span class="va">knots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">6</span>, <span class="fl">9</span>, <span class="fl">12</span>, <span class="fl">15</span>, <span class="fl">18</span>, <span class="fl">24</span><span class="op">)</span><span class="op">/</span><span class="fl">12</span>, <span class="fl">4</span><span class="op">)</span>
<span class="va">fit9</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/brokenstick.html">brokenstick</a></span><span class="op">(</span><span class="va">hgt.z</span> <span class="op">~</span> <span class="va">age</span> <span class="op">|</span> <span class="va">id</span>, data <span class="op">=</span> <span class="va">smocc_200</span>, 
                    knots <span class="op">=</span> <span class="va">knots</span>, boundary <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></pre></div>
<p>This optimization problem is more complicated and time-consuming. As noted before, it is common for the optimization software to issue warnings, often related to the number of random effects relative to the number of observations. While these may be a little discomforting, we have found that the warnings are generally at the conservative side, and that the parameter estimates seem OK. With a small residual variance of 0.059, the nine-line broken stick model fits the observed data very well.</p>
<div class="figure">
<img src="brokenstick-article_files/figure-html/plotfit9-1.png" alt="Broken stick model with nine lines." width="100%"><p class="caption">
Broken stick model with nine lines.
</p>
</div>
<p>The training set includes all subjects. Depending on the study goals, we may wish to further improve the model fit by removing children from the data. For example, there might be children for which few observations are available, children with diseases, or children with trajectories that are very unusual or faulty. Be aware that such removals preserve the external generalisability of the training sample.</p>
</div>
</div>
<div id="prediction" class="section level2">
<h2 class="hasAnchor">
<a href="#prediction" class="anchor"></a>Prediction</h2>
<p>Once we have a fitted model, we may obtain predictions. The subject(s) could be part of the training sample, but could also consist of new children.</p>
<div id="all-subjects" class="section level3">
<h3 class="hasAnchor">
<a href="#all-subjects" class="anchor"></a>All subjects</h3>
<p>The <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code> function obtains predictions from the broken stick model. The function is flexible, and allows for prediction of new subjects at arbitrary ages in a variety of output formats. The simplest call</p>
<div class="sourceCode" id="cb24"><pre class="downlit">
<span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fit9</span>, <span class="va">smocc_200</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">p1</span>, <span class="fl">3</span><span class="op">)</span></pre></div>
<pre><code>##   .pred
## 1  0.57
## 2  0.88
## 3  0.72</code></pre>
<p>produces the predicted value (in <code>.pred</code>) for each row in <code>data</code>.</p>
<p>The predicted values represent a compromise between the person’s data values and the global mean. In general, the fewer and less extreme data points of a person are, the closer the compromise will be toward the global mean. The compromise is called the <em>conditional mean</em> of the posterior distribution, the sum of the fixed and random effects.</p>
<p>We can obtain the locations at which the lines connect by specifying the <code>x = "knots"</code> argument, e.g.</p>
<div class="sourceCode" id="cb26"><pre class="downlit">
<span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fit9</span>, <span class="va">smocc_200</span>, x <span class="op">=</span> <span class="st">"knots"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">p2</span>, <span class="fl">3</span><span class="op">)</span></pre></div>
<pre><code>## # A tibble: 3 x 9
##   .source    id    age sex      ga    bw   hgt hgt.z .pred
##   &lt;chr&gt;   &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1 added   10001 0      &lt;NA&gt;     NA    NA    NA    NA 0.574
## 2 added   10001 0.0833 &lt;NA&gt;     NA    NA    NA    NA 0.883
## 3 added   10001 0.167  &lt;NA&gt;     NA    NA    NA    NA 0.705</code></pre>
<p>This is case 1 in the help of <code><a href="../reference/predict.brokenstick.html">predict.brokenstick()</a></code>. The result <code>p2</code> is a table with 2200 rows (= 11 knots <span class="math inline">\(\times\)</span> 200 subjects). The rows include additional identifying information. Adding the <code>shape = "wide"</code> argument transforms the information into <em>repeated measures</em>, with 200 rows and 12 = 1 + 11 columns, that form supplemental variables for further analyses at the subject level.</p>
<p>We may also obtain both the conditional means as well as predictions at the observation ages for all children by</p>
<div class="sourceCode" id="cb28"><pre class="downlit">
<span class="va">p3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fit9</span>, <span class="va">smocc_200</span>, x <span class="op">=</span> <span class="st">"knots"</span>, strip_data <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">p3</span>, <span class="fl">3</span><span class="op">)</span></pre></div>
<pre><code>## # A tibble: 3 x 9
##   .source    id    age sex       ga    bw   hgt hgt.z .pred
##   &lt;chr&gt;   &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1 data    10001 0      female    40  3960  52   0.575 0.574
## 2 data    10001 0.0821 female    40  3960  55.6 0.888 0.878
## 3 data    10001 0.159  female    40  3960  58.2 0.797 0.721</code></pre>
<p>which contains 4140 rows (= 1940 data points + 2200 added points).</p>
<p>Now suppose that we desire to predict height SDS at other ages, e.g. at 0.42, 1.33 and 4 years. We can do so by (case 4, all groups)</p>
<div class="sourceCode" id="cb30"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fit9</span>, <span class="va">smocc_200</span>, x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.42</span>, <span class="fl">1.33</span>, <span class="fl">4</span><span class="op">)</span>, shape <span class="op">=</span> <span class="st">"wide"</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span></pre></div>
<pre><code>## # A tibble: 3 x 4
##      id `0.42`  `1.33`   `4`
##   &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;
## 1 10001  0.413  0.0524    NA
## 2 10002 -0.261 -0.477     NA
## 3 10003  2.06   1.06      NA</code></pre>
<p>Thus, we have some flexibility to work with times that are not breakpoints. Remember though that the underlying model did not change. For example, we cannot magically predict outside the model at age 4.</p>
</div>
<div id="single-subject" class="section level3">
<h3 class="hasAnchor">
<a href="#single-subject" class="anchor"></a>Single subject</h3>
<p>Obtaining predicted values per subject requires the <code>group</code> argument (case 3). For example</p>
<div class="sourceCode" id="cb32"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fit9</span>, <span class="va">smocc_200</span>, group <span class="op">=</span> <span class="fl">10001</span>, shape <span class="op">=</span> <span class="st">"vector"</span><span class="op">)</span></pre></div>
<pre><code>##  [1]  0.574  0.878  0.721  0.607  0.312 -0.203  0.076  0.128 -0.115  0.155</code></pre>
<p>returns the vector of predictions for child 10001. Remove the <code>shape</code> argument to append the child’s data. Also, here we can predict at other times using the <code>x</code> argument (case 4).</p>
<p>Now suppose that for subject 10001 we have additional height data at ages 0.42 and 1.33 years. Can we predict the child’s trajectory with these new points included? The answer is yes. The command (case 5)</p>
<div class="sourceCode" id="cb34"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">tail</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fit9</span>, <span class="va">smocc_200</span>, x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.42</span>, <span class="fl">1.33</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.5</span>, <span class="op">-</span><span class="fl">1</span><span class="op">)</span>, 
             group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">10001</span>, <span class="fl">10001</span><span class="op">)</span>, strip_data <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span></pre></div>
<pre><code>## # A tibble: 3 x 9
##   .source    id   age sex       ga    bw   hgt  hgt.z   .pred
##   &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;
## 1 data    10001  2.01 female    40  3960  88.3  0.227  0.0765
## 2 added   10001  0.42 &lt;NA&gt;      NA    NA  NA   -0.5    0.230 
## 3 added   10001  1.33 &lt;NA&gt;      NA    NA  NA   -1     -0.244</code></pre>
<p>appends two new records to the data of child 10001, and recalculates the trajectory using all data.</p>
</div>
<div id="new-subject" class="section level3">
<h3 class="hasAnchor">
<a href="#new-subject" class="anchor"></a>New subject</h3>
<p>Suppose we have measured two children, Fred and Alice. We wish to obtain predictions for both using the model <code>fit9</code>. The following snippet calculates predictions at both the observed ages and at the knot locations:</p>
<div class="sourceCode" id="cb36"><pre class="downlit">
<span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
  age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.12</span>, <span class="fl">0.32</span>, <span class="fl">0.62</span>, <span class="fl">1.1</span>, <span class="fl">0.25</span>, <span class="fl">0.46</span><span class="op">)</span>,
  hgt.z <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1.2</span>, <span class="op">-</span><span class="fl">1.8</span>, <span class="op">-</span><span class="fl">1.7</span>, <span class="op">-</span><span class="fl">1.9</span>, <span class="op">-</span><span class="fl">2.1</span>, <span class="op">-</span><span class="fl">1.9</span>, <span class="op">-</span><span class="fl">1.5</span><span class="op">)</span>,
  id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"Fred"</span>, <span class="fl">5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"Alice"</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fit9</span>, <span class="va">data</span>, x <span class="op">=</span> <span class="st">"knots"</span>, strip_data <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></pre></div>
<p>We can plot the trajectories data by</p>
<div class="sourceCode" id="cb37"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">fit9</span>, <span class="va">data</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2.5</span>, <span class="fl">0</span><span class="op">)</span>, xlab <span class="op">=</span> <span class="st">"Age (years)"</span>, ylab <span class="op">=</span> <span class="st">"Length (SDS)"</span><span class="op">)</span></pre></div>
<div class="figure">
<img src="brokenstick-article_files/figure-html/unnamed-chunk-12-1.png" alt="Alice and Fred - observed (blue) and fitted (red) trajectory." width="67%"><p class="caption">
Alice and Fred - observed (blue) and fitted (red) trajectory.
</p>
</div>
<p>Alice contributes only two data points in the first half-year. The model expects that her height SDS will be around -1 SD at the age of two years. Using the data up to 1.1 years, the model predicts that Fred’s growth curve remains around -2.0 SD until Fred is 1.5 years, and then increases to around -1.8 SD. While both predicted trajectories are extreme extrapolations, the example illustrates that it is possible to make informed predictions using just a handful of data points.</p>
<p>The <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code> function does not care about whether <code>new_data</code> is the training data or not. All options are supported in both training and test data, thus providing ample flexibility to suit many use cases.</p>
</div>
</div>
<div id="quality-of-prediction" class="section level2">
<h2 class="hasAnchor">
<a href="#quality-of-prediction" class="anchor"></a>Quality of prediction</h2>
<div class="figure">
<img src="brokenstick-article_files/figure-html/unnamed-chunk-13-1.png" alt="Predicted versus observed values." width="100%"><p class="caption">
Predicted versus observed values.
</p>
</div>
<!-- round(cor(pred, smocc_200$hgt.z, use = "complete.obs")^2, 5) -->
<!-- round(sd(pred - smocc_200$hgt.z, na.rm = TRUE), 3) -->
<!-- r round(cor(y_cm, yhat_cm, use = "complete.obs")^2, 5) -->
<!-- r round(sd(y_cm - yhat_cm, na.rm = TRUE), 3) -->
<p>Figure 9 is the scatterplot of the observed versus predicted values provides a visual representation of the accuracy of the prediction of the model in height SDS and cm scales. Both plots suggest an excellent fit between the observed and fitted data. The percentage of explained variance for the height SDS is high: 97.8%. The standard deviation of the residuals is equal to 0.152 SD, a small value in the <span class="math inline">\(Z\)</span>-scale. When back-converted to centimetres, the scatterplot of the observed versus predicted values is even a little tighter. The proportion of explained variance is close to perfection: 99.9%. The standard deviation of the residuals is 4 mm, about the size of the technical error of measurement (TEM) for duplicate measurements in infants.<span class="citation">(Ismail et al. 2016, Table 2)</span></p>
<p>The model is as good as it can get. The uncertainties associated with the transformation from varying observation times to repeated measures will be small. For all practical purposes, the results from a linear mixed or multilevel model and a repeated measures model are likely to be same.</p>
</div>
<div id="knot-placement-strategies" class="section level2">
<h2 class="hasAnchor">
<a href="#knot-placement-strategies" class="anchor"></a>Knot placement strategies</h2>
<p>Fitting the broken stick model requires a specification of the knots. The choice of the knots influences the quality and usefulness of the solution, so exercise some care in setting appropriate knot locations.</p>
<p>The <code><a href="../reference/brokenstick.html">brokenstick()</a></code> function uses the same set of knots for all subjects. By default, the procedure places the boundary knots at the range of the data and no inner knots, resulting in a model that is linear in time without breakpoints. The <code>k</code> argument is a quick way to add <code>k</code> internal knots at equidense quantiles of the time variable. For example, specifying <code>k = 1</code> puts a knot at the 50th quantile (median), setting <code>k = 3</code> puts knots at the 25th, 50th and 75th quantiles, and so on. While convenient and quick, this option can result in suboptimal knot placement that is not adequate for the problem at hand. In general, it is best to specify explicit values for the <code>knots</code> and <code>boundary</code> arguments.</p>
<p>Here are some suggestions for knot placement:</p>
<ol style="list-style-type: decimal">
<li>If you want to predict at specific ages, then specify knots at those ages. For example, if the scientific interest includes prediction at the age of 1 and 2 years, then include these ages as knots;</li>
<li>Setting knots at scheduled visits is a sensible strategy for obtaining predictions at precisely the scheduled times. Set equidistant knots if the analysis requires a fixed time interval;</li>
<li>Keep the number of knots low, for speed and simplicity. Having many (<span class="math inline">\(\geq 10\)</span>) knots can improve the fit to the data. Still, it will also increase calculation time and may result in unstable solutions. For problems that require more than 10 knots, reduce calculation time by the setting <code>method = "kr"</code> method, and use <code><a href="../reference/control_kr.html">control_kr()</a></code> to improve stability by a correlation model;</li>
<li>Do not place knots in sparsely filled areas of the data, e.g. in-between two visits. Doing so may result in erratic joins;</li>
<li>Define a starting time common to all subjects (e.g. birth) and set the first breakpoint <code>knots[1]</code> equal to the left boundary knot <code>boundary[1]</code>. The <code><a href="../reference/brokenstick.html">brokenstick()</a></code> is already cautions to ensure this;</li>
<li>Order knots in size;</li>
<li>Use the <code><a href="../reference/get_knots.html">get_knots()</a></code> function to extract knots from a fitted model;</li>
<li>Set maximum value in <code>knots</code> to the highest time of scientific interest, but still within the data range. Set boundary knot <code>boundary[2]</code> larger than this value, e.g. equal to the maximum of the time variable. Broken stick estimates at the right boundary knot have no useful interpretation, so exclude those estimates from plots and ignore them in subsequent analyses;</li>
<li>Rule of thumb: Limit the number of knots to the (average) number of data points per subject;</li>
<li>Set knots to explicit values to support generalisation over the time variable in the training data.</li>
</ol>
</div>
</div>
<div id="applications" class="section level1">
<h1 class="hasAnchor">
<a href="#applications" class="anchor"></a>Applications</h1>
<div id="critical-periods" class="section level2">
<h2 class="hasAnchor">
<a href="#critical-periods" class="anchor"></a>Critical periods</h2>
<p>The following question motivated the development of the broken stick model: <em>At what ages do children become overweight?</em> Knowing the answer to this question provides handles for preventive interventions to counter obesity. <span class="citation">Dietz (1994)</span> suggested the existence of three critical periods for obesity at adult age: the prenatal period, the period of adiposity rebound (roughly around the age of 5-6 years), and adolescence. Obesity formed in these periods is likely to increase the obesity risk at adult age and its complications.</p>
<p>A growth period, bounded by ages <span class="math inline">\(T_1\)</span> and <span class="math inline">\(T_2\)</span>, is critical for adult overweight if the following criteria hold: <span class="citation">(de Kroon et al. 2010)</span></p>
<ol style="list-style-type: lower-alpha">
<li>there is a significant difference in mean gain score <span class="math inline">\(Z_2-Z_1\)</span> between subjects with and without adult overweight;</li>
<li>the gain score <span class="math inline">\(Z_2-Z_1\)</span> has an independent contribution over <span class="math inline">\(Z_2\)</span> to the prediction of <span class="math inline">\(Z_{\rm adult}\)</span>. It not only matters where you were at <span class="math inline">\(T_2\)</span> but also how you got there;</li>
<li>
<span class="math inline">\(Z_2\)</span> correlates highly with <span class="math inline">\(Z_{\rm adult}\)</span>, so it is easier (i.e. with higher sensitivity and specificity) to identify children at risk for adult overweight.</li>
</ol>
<p><span class="citation">de Kroon et al. (2010)</span> found that the age interval 2-6 years met all criteria for a critical period. Our re-analysis tests the requirements for the following age intervals: birth-4 months, 4 months-1 year, 1-2 years, 2-4 years, 4-6 years, 6-10 years and 10-14 years. Hence, we define the following break ages:</p>
<div class="sourceCode" id="cb38"><pre class="downlit">
<span class="va">knots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">/</span><span class="fl">3</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">4</span>, <span class="fl">6</span>, <span class="fl">10</span>, <span class="fl">14</span>, <span class="fl">24</span>, <span class="fl">29</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span>
<span class="va">labels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"birth"</span>, <span class="st">"4m"</span>, <span class="st">"1y"</span>, <span class="st">"2y"</span>, <span class="st">"4y"</span>, <span class="st">"6y"</span>, <span class="st">"10y"</span>, <span class="st">"14y"</span>, <span class="st">"24y"</span>, <span class="st">""</span><span class="op">)</span></pre></div>
<div class="figure">
<img src="brokenstick-article_files/figure-html/tbc1-1.png" alt="Body Mass Index (BMI) SDS by log(age + 0.2) (Terneuzen cohort)" width="100%"><p class="caption">
Body Mass Index (BMI) SDS by log(age + 0.2) (Terneuzen cohort)
</p>
</div>
<p>The Terneuzen Birth Cohort <span class="citation">(de Kroon et al. 2008)</span> comprises of 2604 children born around the year 1980 in Terneuzen, The Netherlands. Figure 10 shows the BMI standard deviation scores (SDS) against age in a random subset of 306 children. While we may easily recognise scheduled visits at birth, 1y and 14y, observations at other periods are less structured. Compared to the analysis in <span class="citation">de Kroon et al. (2010)</span>, we removed the knots at 8 days and 18 years (because these appear in sparse data areas) and added knots at 4, 14 and 24 years. We set the right boundary knot to 29y, slightly higher than the maximum age in the data.</p>
<div class="sourceCode" id="cb39"><pre class="downlit">
<span class="va">ctl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/control_brokenstick.html">control_brokenstick</a></span><span class="op">(</span>
  lmer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmerControl.html">lmerControl</a></span><span class="op">(</span>check.conv.grad <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmerControl.html">.makeCC</a></span><span class="op">(</span><span class="st">"warning"</span>, <span class="fl">0.02</span>, <span class="cn">NULL</span><span class="op">)</span>,
                     check.conv.singular <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmerControl.html">.makeCC</a></span><span class="op">(</span><span class="st">"ignore"</span>, <span class="fl">0.001</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">fit_lmer</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/brokenstick.html">brokenstick</a></span><span class="op">(</span><span class="va">bmi.z</span> <span class="op">~</span> <span class="va">age</span> <span class="op">|</span> <span class="va">id</span>, data <span class="op">=</span> <span class="fu">mice</span><span class="fu">::</span><span class="va"><a href="https://amices.github.io/mice/reference/tbc.html">tbc</a></span>,
                        knots <span class="op">=</span> <span class="va">knots</span>, boundary <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">29</span><span class="op">)</span>,
                        control <span class="op">=</span> <span class="va">ctl</span><span class="op">)</span></pre></div>
<p>Depending on the precise specification of the knots, the default <code><a href="../reference/brokenstick.html">brokenstick()</a></code> procedure that calls <code><a href="https://rdrr.io/pkg/lme4/man/lmer.html">lme4::lmer()</a></code> may print the warning <code>Model failed to converge with max|grad| = 0.011882 (tol = 0.002, component 1)</code> or a message <code>boundary (singular) fit: see ?isSingular</code>. These issues arise because of the over-parametrised nature of the default broken stick model, potentially resulting in a singular variance-covariance matrix <code>fit@omega</code>, combined with a sparsity of data. The <code><a href="../reference/control_brokenstick.html">control_brokenstick()</a></code> command can prevent the warning and message.</p>
<div class="sourceCode" id="cb40"><pre class="downlit">
<span class="va">ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">8</span>, <span class="fl">1259</span>, <span class="fl">2447</span>, <span class="fl">7019</span>, <span class="fl">7460</span>, <span class="fl">7646</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">fit_lmer</span>, <span class="fu">mice</span><span class="fu">::</span><span class="va"><a href="https://amices.github.io/mice/reference/tbc.html">tbc</a></span>, group <span class="op">=</span> <span class="va">ids</span>,
     ylab <span class="op">=</span> <span class="st">"BMI SDS"</span>, xlab <span class="op">=</span> <span class="st">"Age (years)"</span><span class="op">)</span></pre></div>
<div class="figure">
<img src="brokenstick-article_files/figure-html/tbc_trajectories_lmer-1.png" alt="Body Mass Index (BMI) SDS trajectories of six subjects, observed (blue) and fitted (red). lmer method." width="100%"><p class="caption">
Body Mass Index (BMI) SDS trajectories of six subjects, observed (blue) and fitted (red). lmer method.
</p>
</div>
<p>Figure 11 shows observed and fitted BMI SDS trajectories for six subjects using the <code>lmer</code> method. In general, the model fits the data well. The per cent explained variance of BMI SDS obtained by <code><a href="../reference/get_r2.html">get_r2(fit_lmer, mice::tbc)</a></code> equals 84 per cent. Note that he fitted trajectory for subject 8 reveals a pretty rough estimate at the age of 24y. Persons 1259 and 7460 have very low (-2.5 SD) and high (+2.5 SD) BMI SDS at adult age, respectively. Note that the model pulls the adult BMI SDS estimates (in red) towards the global mean, due to the well-known bias-variance tradeoff.<span class="citation">(Gelman and Hill 2007, 394)</span> Pulling is more vigorous at the extremes. The effect is negligible for more average trajectories, such as for subject 2447.</p>
<p>The royal way to treat such warnings and message is to simplify the model, e.g., by removing knots. An alternative is to constrain the broken stick model, in particular the covariance matrix. Selecting the <code>kr</code> method applies the Argyle correlation model, at the expense of fit to the data. On the other hand, the fitted trajectories will be much stabler in regions with sparse data. The following snippet applies the <code>kr</code> method.</p>
<div class="sourceCode" id="cb41"><pre class="downlit">
<span class="va">fit_kr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/brokenstick.html">brokenstick</a></span><span class="op">(</span><span class="va">bmi.z</span> <span class="op">~</span> <span class="va">age</span> <span class="op">|</span> <span class="va">id</span>, data <span class="op">=</span> <span class="fu">mice</span><span class="fu">::</span><span class="va"><a href="https://amices.github.io/mice/reference/tbc.html">tbc</a></span>,
                      knots <span class="op">=</span> <span class="va">knots</span>, boundary <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">29</span><span class="op">)</span>,
                      method <span class="op">=</span> <span class="st">"kr"</span>, seed <span class="op">=</span> <span class="fl">41441</span><span class="op">)</span></pre></div>
<div class="figure">
<img src="brokenstick-article_files/figure-html/tbc_trajectories_kr-1.png" alt="Body Mass Index (BMI) SDS trajectories of six subjects, observed (blue) and fitted (red). kr method." width="100%"><p class="caption">
Body Mass Index (BMI) SDS trajectories of six subjects, observed (blue) and fitted (red). kr method.
</p>
</div>
<p>Figure 12 is the equivalent to Figure 11, but now for method <code>kr</code>. The per cent explained variance is the same. Due to the constraint placed on the covariance matrix, the trajectories are slightly smoother and more stable in the adult ages with limited data. The rough estimate for subject 8 has gone. There is still some gravity towards to global mean at knot 24y for persons 1259 and 7460, but it is of lesser magnitude. All fitted trajectories are well behaved. We, therefore, select the <code>kr</code> solution for further analysis.</p>
<p>To identify critical periods, we need to predict adult overweight. In Figure 12, only three out of six subjects had a BMI measurement at adult age. Since we do not want the results to overly depend on fitted extrapolations, we restrict the analysis sample to persons with an adult measurement. The following lines extract the repeated measures for 92 (out of 306) individuals for whom we observed adult BMI.</p>
<div class="sourceCode" id="cb42"><pre class="downlit">
<span class="va">tbc1</span> <span class="op">&lt;-</span> <span class="fu">mice</span><span class="fu">::</span><span class="va"><a href="https://amices.github.io/mice/reference/tbc.html">tbc</a></span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">ao</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">first</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">select</span><span class="op">(</span><span class="va">id</span>, <span class="va">nocc</span>, <span class="va">sex</span><span class="op">)</span>
<span class="va">tbc2</span> <span class="op">&lt;-</span> <span class="fu">mice</span><span class="fu">::</span><span class="va"><a href="https://amices.github.io/mice/reference/tbc.html">tbc.target</a></span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">id</span> <span class="op">%in%</span> <span class="va">tbc1</span><span class="op">$</span><span class="va">id</span><span class="op">)</span>
<span class="va">prd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fit_kr</span>, <span class="fu">mice</span><span class="fu">::</span><span class="va"><a href="https://amices.github.io/mice/reference/tbc.html">tbc</a></span>, x <span class="op">=</span> <span class="st">"knots"</span>, 
               shape <span class="op">=</span> <span class="st">"wide"</span>, group <span class="op">=</span> <span class="va">tbc1</span><span class="op">$</span><span class="va">id</span><span class="op">)</span>
<span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">bind_cols</span><span class="op">(</span><span class="va">prd</span>, 
                  <span class="fu">select</span><span class="op">(</span><span class="va">tbc1</span>, <span class="op">-</span><span class="va">id</span><span class="op">)</span>, 
                  <span class="fu">select</span><span class="op">(</span><span class="va">tbc2</span>, <span class="op">-</span><span class="va">id</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">data</span>, <span class="fl">3</span><span class="op">)</span></pre></div>
<pre><code>## # A tibble: 3 x 15
##      id   `0` `0.333`     `1`    `2`    `4`    `6`   `10`   `14`   `24`   `29`
##   &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
## 1     8 0.371  -0.440  0.366   1.45   1.10   0.606  0.490  0.543 -0.822 -1.18 
## 2    60 0.159  -0.372 -0.0441 -0.361 -0.595 -0.819 -1.03  -1.16  -1.46  -1.40 
## 3    97 1.68    0.569  0.948   1.90   1.28   0.838  0.444  0.238  0.398  0.709
## # … with 4 more variables: nocc &lt;dbl&gt;, sex &lt;dbl&gt;, ao &lt;dbl&gt;, bmi.z.jv &lt;dbl&gt;</code></pre>
<div class="figure">
<img src="brokenstick-article_files/figure-html/tbc_trajectories_all-1.png" alt="Body Mass Index (BMI) SDS trajectories for 92 subjects, coloured by adult overweight status." width="100%"><p class="caption">
Body Mass Index (BMI) SDS trajectories for 92 subjects, coloured by adult overweight status.
</p>
</div>
<p>Figure 13 shows the 92 fitted trajectories coloured by adult overweight status (BMI SDS &gt; 1.3). It is evident that BMI SDS at ages of 14y or 10y is highly predictive of adult overweight, but does that also hold in early childhood? Also, does a change in specific periods predict later overweight? To answer such questions, we fit simple linear models to predict observed (not fitted!) BMI SDS at adult age from the fitted BMI SDS trajectories. The following code block fits two models for the period 4y-6y.</p>
<div class="sourceCode" id="cb44"><pre class="downlit">
<span class="va">m1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">bmi.z.jv</span> <span class="op">~</span> <span class="va">`6`</span>, <span class="va">data</span><span class="op">)</span>
<span class="va">m2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">bmi.z.jv</span> <span class="op">~</span> <span class="va">`6`</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="va">`6`</span><span class="op">-</span><span class="va">`4`</span><span class="op">)</span>, <span class="va">data</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/stats/anova.html">anova</a></span><span class="op">(</span><span class="va">m1</span>, <span class="va">m2</span><span class="op">)</span></pre></div>
<pre><code>## Analysis of Variance Table
## 
## Model 1: bmi.z.jv ~ `6`
## Model 2: bmi.z.jv ~ `6` + I(`6` - `4`)
##   Res.Df  RSS Df Sum of Sq    F  Pr(&gt;F)    
## 1     90 74.3                              
## 2     89 63.5  1      10.8 15.2 0.00019 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
<p>Model <code>m1</code> predicts adult BMI SDS from BMI SDS 6y, and explains 45.3 per cent of the variance. Model <code>m2</code> extends the model with the pre-gain between 4y and 6y. If the pre-gain improves the prediction, then it matters how much you gained between 4y and 6y. In that case, we would call the interval 4y-6y a critical period. Here we found that model 2 explain 53.6 per cent variance, thus 8.3 per cent more. The <code>anova</code> statement performs the formal test. In this case, the pre-gain is significant over the last predictor at 6y. Thus, interval 4y-6y classifies as a critical period. We can repeat these analyses for other age intervals, similar to Table 3 in <span class="citation">Kenward (1987)</span>.</p>
</div>
<div id="time-to-time-correlations" class="section level2">
<h2 class="hasAnchor">
<a href="#time-to-time-correlations" class="anchor"></a>Time-to-time correlations</h2>
<p>The <em>conditional gain score</em> is defined as <span class="citation">(Cole 1995)</span></p>
<p><span class="math display">\[
{\rm conditional}\ Z_{\rm gain} = \frac{Z_2 - rZ_1}{\sqrt{1-r^2}},
\]</span></p>
<p>where <span class="math inline">\(Z_1\)</span> and <span class="math inline">\(Z_2\)</span> are the standard deviation scores at times <span class="math inline">\(T_1\)</span> and <span class="math inline">\(T_2\)</span>, with <span class="math inline">\(T_2&gt;T_1\)</span>, and where <span class="math inline">\(r\)</span> is the correlation between <span class="math inline">\(Z_1\)</span> and <span class="math inline">\(Z_2\)</span>. The conditional gain corrects for regression to the mean, which is its selling point over traditional velocity measures and is less sensitive to measurement error.<span class="citation">(van Buuren 2007)</span> A practical difficulty is to obtain <span class="math inline">\(r\)</span> for a given <span class="math inline">\(T_1\)</span> and <span class="math inline">\(T_2\)</span>. The time-to-time correlation matrix needs to be known. Also, we need to interpolate <span class="math inline">\(r\)</span> if <span class="math inline">\(T_1\)</span> or <span class="math inline">\(T_2\)</span> differs from the tabulated ages.</p>
<p>The broken stick model provides an estimate of the time-to-time correlation matrix. The <code>brokenstick</code> object stores the variance-covariance matrix <span class="math inline">\(\Omega\)</span> of the random effects in the list component <code>fit$omega</code>. For a perfectly fitting model (with <span class="math inline">\(\sigma^2=0\)</span>) <span class="math inline">\(\Omega\)</span> equals the time-to-time covariance matrix, so <code><a href="https://rdrr.io/r/stats/cor.html">cov2cor(fit$omega)</a></code> gives the desired time-to-time correlation matrix. If <span class="math inline">\(\sigma^2 &gt; 0\)</span> then <span class="math inline">\(\Omega\)</span> overestimates the covariances between the observed data. In general, we need to add the within-residual variance estimate to the diagonal, thus <span class="math inline">\(\Omega + \hat\sigma^2 I(n_i)\)</span> to estimate the time-to-time covariance matrix.</p>
<div class="sourceCode" id="cb46"><pre class="downlit">
<span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/brokenstick.html">brokenstick</a></span><span class="op">(</span><span class="va">hgt.z</span> <span class="op">~</span> <span class="va">age</span> <span class="op">|</span> <span class="va">id</span>, data <span class="op">=</span> <span class="va">smocc_200</span>, 
                   knots <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">/</span><span class="fl">2</span>, boundary <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></pre></div>
<pre><code>## boundary (singular) fit: see ?isSingular</code></pre>
<div class="sourceCode" id="cb48"><pre class="downlit">
<span class="va">t2t</span> <span class="op">&lt;-</span> <span class="va">fit</span><span class="op">$</span><span class="va">omega</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">sigma2</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">omega</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cov2cor</a></span><span class="op">(</span><span class="va">t2t</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span></pre></div>
<pre><code>##         age_0 age_0.5 age_1 age_1.5 age_2 age_3
## age_0    1.00    0.52  0.41    0.42  0.35  0.01
## age_0.5  0.52    1.00  0.77    0.73  0.68 -0.30
## age_1    0.41    0.77  1.00    0.81  0.79 -0.16
## age_1.5  0.42    0.73  0.81    1.00  0.84  0.00
## age_2    0.35    0.68  0.79    0.84  1.00  0.07
## age_3    0.01   -0.30 -0.16    0.00  0.07  1.00</code></pre>
<p>In child growth, we expect that the correlation tapers off as the difference between <span class="math inline">\(T_1\)</span> and <span class="math inline">\(T_2\)</span> grows. Also, for a fixed interval <span class="math inline">\(T_2-T_1\)</span> we expect the correlation to increase with age. Ignoring the uninteresting estimate for <code>age_3</code>, we find that both expectations hold. Altering the number and location of the knots may change this. It is often useful to scan the time-to-time correlation matrix for gross deviations of the expectations. If such happens, one could simplify the model, for example, by subjecting <span class="math inline">\(\Omega\)</span> to a correlation model.</p>
<div class="sourceCode" id="cb50"><pre class="downlit">
<span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/brokenstick.html">brokenstick</a></span><span class="op">(</span><span class="va">hgt.z</span> <span class="op">~</span> <span class="va">age</span> <span class="op">|</span> <span class="va">id</span>, data <span class="op">=</span> <span class="va">smocc_200</span>, 
                   knots <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">0.1</span><span class="op">)</span>, boundary <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">3</span><span class="op">)</span>,
                   method <span class="op">=</span> <span class="st">"kr"</span><span class="op">)</span>
<span class="va">t2t</span> <span class="op">&lt;-</span> <span class="va">fit</span><span class="op">$</span><span class="va">omega</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">sigma2</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">omega</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">t2t</span><span class="op">)</span></pre></div>
<pre><code>## [1] 22 22</code></pre>
<p>The above code fits a model with 22 equidistant breakpoints, which is likely large enough for most purposes. It works because it restricts the covariance-matrix by the Argyle correlation model, which summarises the information by just two parameters. We may extract or re-estimate these parameters and create a one-liner for calculating <span class="math inline">\(r\)</span>.</p>
<p>We cannot indefinitely add breakpoints. Suppose we double the number of knots by setting <code>knots = seq(0, 2, 0.05)</code>. Then even <code>kr</code> is not able to cope and will abort with <code>Error: Sigma is symmetric but not positive</code>. Thus, as always, be sensible in what you ask the software to do for you.</p>
</div>
<div id="profile-analysis" class="section level2">
<h2 class="hasAnchor">
<a href="#profile-analysis" class="anchor"></a>Profile analysis</h2>
<p>Profile analysis <span class="citation">(Morrison 1976; Johnson and Wichern 1988)</span> refers linear multivariate linear methods to test for differences in population means or treatment effects, typically by regression analysis or multivariate analysis of variance (MANOVA). These methods assume independence of subjects, organise the data at the subject level, and express parameters of interest by linear combinations of outcomes, like change scores, means or other derived quantities.</p>
<p><span class="citation">Krone et al. (2020)</span> report a statistical analyses using the linear mixed model with time-varying individual subject data. This section re-analyses the data from Figure 4 using the broken stick model. The data are available as the <code><a href="../reference/weightloss.html">brokenstick::weightloss</a></code> object.</p>
<div class="figure">
<img src="brokenstick-article_files/figure-html/weightloss-data-1.png" alt="Daily body weight (KG) for 12 subjects under three conditions." width="100%"><p class="caption">
Daily body weight (KG) for 12 subjects under three conditions.
</p>
</div>
<p>Figure 14 charts daily body weight measurements of twelve individuals who were followed for nine weeks. The investigators subdivided the total duration into three periods of three weeks. Period one (week 1-3) acted as a control period. During period 2 (week 4-6), the investigators stimulated participants to restrict food intake, and during period 3 (week 7-9) the experimenters promoted physical activity. Subjects 4 and 12 received the interventions in the opposite order. See <span class="citation">Krone et al. (2020)</span> for more detail.</p>
<p>Most of these subjects adhere quite well to the data collection design. Some trajectories show gaps due to missed measurements. The most extreme example is the trajectory at the top, which has only scant measures. Other curves display stretches of lines, suggesting that missed measurements were linearly interpolated. One of the series shows some surprising spikes, likely to be measurement errors. All in all, these data perfectly illustrate the inescapable imperfections of real data.</p>
<p>The remainder of the section discusses two ways to estimate the effect of diet and physical activity on body weight.</p>
<div id="constant-model" class="section level3">
<h3 class="hasAnchor">
<a href="#constant-model" class="anchor"></a>Constant model</h3>
<div class="sourceCode" id="cb52"><pre class="downlit">
<span class="va">fit0</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/brokenstick.html">brokenstick</a></span><span class="op">(</span><span class="va">body_weight</span> <span class="op">~</span> <span class="va">day</span> <span class="op">|</span> <span class="va">subject</span>, <span class="va">data</span>, 
                    knots <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">21</span>, <span class="fl">42</span>, <span class="fl">63</span><span class="op">)</span>, degree <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">fit0</span>, <span class="va">data</span>, size_y <span class="op">=</span> <span class="fl">0</span>, color_y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"grey"</span>, <span class="fl">2</span><span class="op">)</span>, what <span class="op">=</span> <span class="st">"all"</span>,
     scales <span class="op">=</span> <span class="st">"free_y"</span>, xlab <span class="op">=</span> <span class="st">"Day"</span>, ylab <span class="op">=</span> <span class="st">"Body weight (KG)"</span>, 
     n_plot <span class="op">=</span> <span class="fl">12</span>, ncol <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></pre></div>
<div class="figure">
<img src="brokenstick-article_files/figure-html/weightloss-constant-1.png" alt="Constant model. Observed and fitted trajectories for a model that summarises each experimental period by a constant." width="100%"><p class="caption">
Constant model. Observed and fitted trajectories for a model that summarises each experimental period by a constant.
</p>
</div>
<p>The model underlying Figure 15 summarises the trajectory within a period by a constant, the mean. We obtain an estimate of these mean by setting the <code>degree = 0</code> argument. This model gives a fair representation of the trajectory of subjects 9 (a persistent downward trend), 1 and 5 (no trend). On the other hand, the model fails to capture patterns for subjects 2, 4 and 8 (rebound in period 3) or 11 (inverse rebound).</p>
<p>It is straightforward quantify the effects of <code>Diet</code> and <code>Activity</code> relative to <code>Control</code>. The next code snippet calculates these effects per person, accounting for the intervention order reversal for subjects 4 and 12.</p>
<div class="sourceCode" id="cb53"><pre class="downlit">
<span class="va">prd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fit0</span>, <span class="va">data</span>, x <span class="op">=</span> <span class="st">"knots"</span>, shape <span class="op">=</span> <span class="st">"wide"</span><span class="op">)</span><span class="op">)</span>
<span class="va">control</span> <span class="op">&lt;-</span> <span class="va">prd</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span>
<span class="va">diet</span> <span class="op">&lt;-</span> <span class="va">prd</span><span class="op">[</span>, <span class="fl">3</span><span class="op">]</span>
<span class="va">diet</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">12</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">prd</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">12</span><span class="op">)</span>, <span class="fl">4</span><span class="op">]</span>
<span class="va">activity</span> <span class="op">&lt;-</span> <span class="va">prd</span><span class="op">[</span>, <span class="fl">4</span><span class="op">]</span>
<span class="va">activity</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">12</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">prd</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">12</span><span class="op">)</span>, <span class="fl">3</span><span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>diet_control <span class="op">=</span> <span class="va">diet</span> <span class="op">-</span> <span class="va">control</span>, 
                 activity_control <span class="op">=</span> <span class="va">activity</span> <span class="op">-</span> <span class="va">control</span>, 
                 activity_diet <span class="op">=</span> <span class="va">activity</span> <span class="op">-</span> <span class="va">diet</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span></pre></div>
<pre><code>##    diet_control activity_control activity_diet
## 1           0.2              0.2           0.0
## 2          -1.1             -1.8          -0.7
## 3           1.0              1.0           0.1
## 4          -1.8             -0.7           1.1
## 5           0.4              0.1          -0.2
## 6          -1.6             -3.3          -1.7
## 7          -0.2             -0.5          -0.4
## 8          -0.6             -1.1          -0.4
## 9          -1.2             -2.0          -0.9
## 10         -0.6             -1.2          -0.6
## 11          0.1             -0.6          -0.6
## 12         -1.3             -0.4           0.9</code></pre>
<p>The average weight under caloric restriction is 0.6 KG lower than control. In contrast, we find a 0.8 KG lower body weight when we stimulate physical activity. We could be tempted to believe that exercise reduces weight more than a diet. However, except for subjects 4 and 12, the investigators administered the activity treatment after the diet treatment, so the difference relative to control represents the <em>combined effect</em> of diet and activity on body weight. It might be more relevant to study the difference between training and diet (third column). The average difference of -0.3 KG suggests that diet is more effective than physical activity. Realise that also this estimate is not entirely satisfactory. First, subjects 4 and 12 had a reversed administration, so the difference does not make sense for them. Second, as anyone who has tried to lose weight can attest, “quick wins” are more likely in period 2 than in period 3. Although it is possible to account for these sequence effects, there is a more intuitive analysis of the data.</p>
</div>
<div id="broken-stick-model-1" class="section level3">
<h3 class="hasAnchor">
<a href="#broken-stick-model-1" class="anchor"></a>Broken stick model</h3>
<div class="sourceCode" id="cb55"><pre class="downlit">
<span class="va">fit1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/brokenstick.html">brokenstick</a></span><span class="op">(</span><span class="va">body_weight</span> <span class="op">~</span> <span class="va">day</span> <span class="op">|</span> <span class="va">subject</span>, <span class="va">data</span>, 
                    knots <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">21</span>, <span class="fl">42</span>, <span class="fl">63</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">fit1</span>, <span class="va">data</span>, size_y <span class="op">=</span> <span class="fl">0</span>, color_y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"grey"</span>, <span class="fl">2</span><span class="op">)</span>, what <span class="op">=</span> <span class="st">"all"</span>,
     size_yhat <span class="op">=</span> <span class="fl">1.5</span>, scales <span class="op">=</span> <span class="st">"free_y"</span>, , xlab <span class="op">=</span> <span class="st">"Day"</span>, ylab <span class="op">=</span> <span class="st">"Body weight (KG)"</span>,
     n_plot <span class="op">=</span> <span class="fl">12</span>, ncol <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></pre></div>
<div class="figure">
<img src="brokenstick-article_files/figure-html/weightloss-slope-1.png" alt="Broken stick model. Observed and fitted trajectories for a model that summarises each experimental period by a line." width="100%"><p class="caption">
Broken stick model. Observed and fitted trajectories for a model that summarises each experimental period by a line.
</p>
</div>
<p>Figure 16 shows the same data as in Figure 15 but now fitted by the broken stick model. This model also suggests a persistent downward trend for subject 9 and an absence of for participants 1 and 5. Also, the model now correctly identifies the prominent zig-zag patterns for persons 2, 4, 8 and 11 across the three experimental periods.</p>
<p>A natural way to quantify the effect of the intervention is to calculate the before-after estimate per period. For example, for person 2 the effect of diet is <span class="math inline">\(60.9 - 63.6 = -2.7\)</span> KG, of activity is <span class="math inline">\(62.6-60.9=+1.7\)</span> KG. The following code accounts for the alternate treatment ordering of subjects 4 and 12.</p>
<div class="sourceCode" id="cb56"><pre class="downlit">
<span class="va">prd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fit1</span>, <span class="va">data</span>, x <span class="op">=</span> <span class="st">"knots"</span>, shape <span class="op">=</span> <span class="st">"wide"</span><span class="op">)</span><span class="op">)</span>
<span class="va">control</span> <span class="op">&lt;-</span> <span class="va">prd</span><span class="op">[</span>, <span class="fl">3</span><span class="op">]</span> <span class="op">-</span> <span class="va">prd</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span>
<span class="va">diet</span> <span class="op">&lt;-</span> <span class="va">prd</span><span class="op">[</span>, <span class="fl">4</span><span class="op">]</span> <span class="op">-</span> <span class="va">prd</span><span class="op">[</span>, <span class="fl">3</span><span class="op">]</span>
<span class="va">diet</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">12</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">prd</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">12</span><span class="op">)</span>, <span class="fl">5</span><span class="op">]</span> <span class="op">-</span> <span class="va">prd</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">12</span><span class="op">)</span>, <span class="fl">4</span><span class="op">]</span>
<span class="va">activity</span> <span class="op">&lt;-</span> <span class="va">prd</span><span class="op">[</span>, <span class="fl">5</span><span class="op">]</span> <span class="op">-</span> <span class="va">prd</span><span class="op">[</span>, <span class="fl">4</span><span class="op">]</span>
<span class="va">activity</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">12</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">prd</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">12</span><span class="op">)</span>, <span class="fl">4</span><span class="op">]</span> <span class="op">-</span> <span class="va">prd</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">12</span><span class="op">)</span>, <span class="fl">3</span><span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>control <span class="op">=</span> <span class="va">control</span>, 
                 diet <span class="op">=</span> <span class="va">diet</span>, 
                 activity <span class="op">=</span> <span class="va">activity</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span></pre></div>
<pre><code>##    control diet activity
## 1     -0.3  0.5     -0.4
## 2      0.1 -2.7      1.7
## 3      0.8  0.5      0.6
## 4      0.1  0.7     -2.2
## 5      0.6 -0.6      0.7
## 6     -0.8 -2.6     -0.8
## 7      0.3 -0.8      0.3
## 8     -0.3 -1.1      0.3
## 9     -1.0 -1.4     -0.4
## 10    -0.2 -1.1     -0.3
## 11    -0.9  0.9     -2.6
## 12    -0.9 -0.4     -0.5</code></pre>
<p>The average effects are -0.2 KG (control), -0.7 KG (diet) and -0.3 KG (activity). Although not statistically significant, the slight decrease of -0.2 KG during the control period suggests that weight monitoring by itself may motivate the participant to lose weight. The effect estimates for diet and activity are of similar magnitude as before. Still, they can be sizeable discrepancies at the individual level, e.g. for subjects 2 or 11.</p>
<p>We may obtain a simple estimate of the sequence effect by linear regression as</p>
<div class="sourceCode" id="cb58"><pre class="downlit">
<span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">diet</span>, <span class="va">activity</span><span class="op">)</span>,
                 act <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>,
                 per2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span>, <span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">7</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">act</span>, data <span class="op">=</span> <span class="va">df</span><span class="op">)</span><span class="op">)</span></pre></div>
<pre><code>## (Intercept)         act 
##       -0.68        0.38</code></pre>
<div class="sourceCode" id="cb60"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">act</span> <span class="op">+</span> <span class="va">per2</span>, data <span class="op">=</span> <span class="va">df</span><span class="op">)</span><span class="op">)</span></pre></div>
<pre><code>## (Intercept)         act        per2 
##       -0.79        0.38        0.12</code></pre>
<p>The result is a little surprising. When applied in period 2, the intervention leads to higher body weight (+123 grammes) as compared to administration in period 3. Of course, bear in mind that we calculated these results on very few individuals. Hence, they are sensitive to substantial estimation error.</p>
<p>This application demonstrates that the broken stick model can effectively capture rapid linear changes in experiments. Even though the actual timing of the observations may be erratic, it is easy to define, interpret and calculate intuitive effect estimates at the individual level. Note that the analysis here assumed an instantaneous effect of the interventions. If we expect a delay, then we may right-shift the knots by a few days and re-estimate the broken stick model. By varying the number of days, we may be able to detect the optimal delay factor.</p>
</div>
</div>
<div id="curve-interpolation" class="section level2">
<h2 class="hasAnchor">
<a href="#curve-interpolation" class="anchor"></a>Curve interpolation</h2>
<div id="problem" class="section level3">
<h3 class="hasAnchor">
<a href="#problem" class="anchor"></a>Problem</h3>
<p>A growth chart visualises the individual trajectory relative to a set of centile lines. We may store a centile line as a set of coordinates with a relatively dense age grid. If we connect the adjacent vertices by a straight line, the centile will appear as smooth in time. However, this plotting method runs into trouble when ages are wide apart. This section shows how we can create a realistic interpolation with sparse time data.</p>
</div>
<div id="interpolation-in-measurement-scale" class="section level3">
<h3 class="hasAnchor">
<a href="#interpolation-in-measurement-scale" class="anchor"></a>Interpolation in measurement scale</h3>
<p>Suppose we measured the length of a boy at the ages of 1 month (52.6 cm) and 14 months (81.7 cm). The following code block uses the <code><a href="https://rdrr.io/pkg/AGD/man/y2z.html">AGD::y2z()</a></code> function to convert the measurements to standard deviation scores (SDS) relative to the reference of the Fourth Dutch Growth Study.</p>
<div class="sourceCode" id="cb62"><pre class="downlit">
<span class="va">boy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">/</span><span class="fl">12</span>, <span class="fl">14</span><span class="op">/</span><span class="fl">12</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">52.6</span>, <span class="fl">81.7</span><span class="op">)</span><span class="op">)</span>
<span class="va">ref</span> <span class="op">&lt;-</span> <span class="fu">AGD</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/AGD/man/References-NL4.html">nl4.hgt</a></span>
<span class="va">boy</span><span class="op">$</span><span class="va">z</span> <span class="op">&lt;-</span> <span class="fu">AGD</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/AGD/man/y2z.html">y2z</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">boy</span><span class="op">$</span><span class="va">y</span>, x <span class="op">=</span> <span class="va">boy</span><span class="op">$</span><span class="va">x</span>, sex <span class="op">=</span> <span class="st">"M"</span>, ref <span class="op">=</span> <span class="va">ref</span><span class="op">)</span>
<span class="va">boy</span><span class="op">$</span><span class="va">z</span></pre></div>
<pre><code>## [1] -0.98  0.99</code></pre>
<div class="figure">
<img src="brokenstick-article_files/figure-html/fig:inter1-1.png" alt="Linear interpolation in the cm scale results in an unrealistic trajectory at intermediate ages." width="100%"><p class="caption">
Linear interpolation in the cm scale results in an unrealistic trajectory at intermediate ages.
</p>
</div>
<p>During the period the boy grows from moderately short (about -1.0 SD at month 1) to relatively tall (about +1.0 SD at month 14). Figure 17 shows the usual representation of the growth chart with a straight line drawn between the two values. Due to the convex shape of the centile lines, the straight line that connects the two measurements starts at -1.0 SD, then touches the -2.0 SD centile around 0.3 yr, is back at -1.0 SD around 0.7 yr, crosses the 0.0 SD line at 1 yr, and ends at +1.0 SD at 1.2 yr. The graph on the right-hand side portrays the interpolated growth curve in the <span class="math inline">\(Z\)</span>-score scale. Since length growth during infancy is not linear in time, finding a real growth curve like this is extremely unlikely. Since we have just two data points smoothing the data does not help either.</p>
</div>
<div id="interpolation-in-the-z-score-scale" class="section level3">
<h3 class="hasAnchor">
<a href="#interpolation-in-the-z-score-scale" class="anchor"></a>Interpolation in the Z-score scale</h3>
<p>A first alternative is to apply the linear interpolation in the <span class="math inline">\(Z\)</span>-score scale. This option is attractive because convexity of centile lines is absent on this scale.</p>
<div class="figure">
<img src="brokenstick-article_files/figure-html/fig:inter2-1.png" alt="Linear interpolation in the Z-score scale results in a more realistic trajectory at intermediate ages." width="100%"><p class="caption">
Linear interpolation in the Z-score scale results in a more realistic trajectory at intermediate ages.
</p>
</div>
<p>Figure 18 illustrates the interpolation in the <span class="math inline">\(Z\)</span>-scale. By definition, the line that connects the measurements is straight in the <span class="math inline">\(Z\)</span>-score scale. In the cm scale, the representation is more realistic and more pleasing to the eye. The curve crosses the 0 SD line about halfway, at about 0.6 yr.</p>
<p>While this approach is a considerable improvement over interpolation in the <span class="math inline">\(Y\)</span>-scale, it is still not ideal. The assumption underlying this interpolation is that the <span class="math inline">\(Z\)</span>-score increment is constant across time. This assumption is false, however. Since length growth is more variable during the first half-year than in the second half-year, we expect that the larger share of the increment to occur during the earlier months. In other words, the cross-over point at 0.6 yr is too late.</p>
</div>
<div id="interpolation-by-the-broken-stick-model" class="section level3">
<h3 class="hasAnchor">
<a href="#interpolation-by-the-broken-stick-model" class="anchor"></a>Interpolation by the broken stick model</h3>
<p>The second alternative is a model-based interpolation. Assuming the availability of a fitted broken stick model, we specify a dense time grid, say every week, and predict the length at these times given the data from the observed trajectory. The expected curve represents the most likely values under the model at the intermediate ages. The following code calculates the relevant estimates from the <code>fit_200</code> fitted model:</p>
<div class="sourceCode" id="cb64"><pre class="downlit">
<span class="co"># prepare data input</span>
<span class="va">age</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">2</span><span class="op">/</span><span class="fl">24</span>, <span class="fl">28</span><span class="op">/</span><span class="fl">24</span>, <span class="fl">1</span><span class="op">/</span><span class="fl">24</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span>
<span class="va">z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">age</span><span class="op">)</span><span class="op">)</span>
<span class="va">z</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">boy</span><span class="op">$</span><span class="va">z</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>; <span class="va">z</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">z</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">boy</span><span class="op">$</span><span class="va">z</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>

<span class="co"># predict with broken stick model</span>
<span class="va">zout</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fit_200</span>, x <span class="op">=</span> <span class="va">age</span>, y <span class="op">=</span> <span class="va">z</span>, shape <span class="op">=</span> <span class="st">"vector"</span><span class="op">)</span>

<span class="co"># convert predicted values to Y-scale</span>
<span class="va">yout</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/AGD/man/z2y.html">z2y</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">age</span>, z <span class="op">=</span> <span class="va">zout</span>, ref <span class="op">=</span> <span class="va">ref</span><span class="op">)</span></pre></div>
<div class="figure">
<img src="brokenstick-article_files/figure-html/fig:inter3-1.png" alt="Broken stick model fitted in the SDS scale results in a most realistic expected trajectory at intermediate ages." width="100%"><p class="caption">
Broken stick model fitted in the SDS scale results in a most realistic expected trajectory at intermediate ages.
</p>
</div>
<p>Figure 19 shows the results of the broken stick model. The predicted curve in the <span class="math inline">\(Y\)</span>-scale represents the most likely course according to the broken stick model. Because growth is more variable during early infancy, the child realises the larger share of the change during the first part of the period. As a result, the cross-over point where the predicted value intersects the 0 SD line is now at 0.4 yr, considerably earlier than obtained by the two other interpolation methods. The plot on the right-hand side confirms the steeper slope in the first part. Note that this method treats rising and declining curves alike. For example, if the boy’s length would be 57 cm at month 1 (+1.0 SD) and 76 cm at month 14 (-1.0 SD), the cross-over point would also be at 0.4 yr.</p>
<p>Observe that we left the world of pure interpolation and moved to an approximation of the data by a model. The observed and predicted lengths are not exactly equal. The difference is so small that we may hardly notice the discrepancy when plotted in the <span class="math inline">\(Y\)</span>-scale, but it is more conspicuous in the <span class="math inline">\(Z\)</span>-score scale. Of the three approaches considered here, the broken stick model provides the most realistic expected trajectory at the intermediate ages.</p>
</div>
</div>
<div id="multiple-imputation" class="section level2">
<h2 class="hasAnchor">
<a href="#multiple-imputation" class="anchor"></a>Multiple imputation</h2>
<p>Remember from section 2 that the broken stick estimates are conditional means. We may be tempted to analyse these estimates as if they were “just data”, but they do not have the same variability as the real data. For example, suppose we calculate the correlation matrix of the broken stick estimates. We know that the values in this matrix will exceed those from the underlying observed data. Not accounting for this fact leads to overconfident predictions and results that are too good to be true.</p>
<p>Multiple imputation <span class="citation">(Rubin 1987; van Buuren 2018)</span> restores variability by adding noise. We may fit standard complete-data software to the imputed data, and obtain valid regression weights, confidence intervals and <span class="math inline">\(P\)</span>-values under a wide range of conditions.</p>
<p>By default, method <code>kr</code> executes 200 iterations of the Kasim-Raudenbush sampler. The <code>imp_skip</code> argument to the <code><a href="../reference/control_kr.html">control_kr()</a></code> function specifies the interval at which the method adds noise to the broken stick estimates. The following code block appends the break ages to the input data and sets <code>imp_skip = 10</code>. The call to the <code><a href="../reference/brokenstick.html">brokenstick()</a></code> function thus creates 20 imputations for each missing outcome (<code>hgt.z</code> here).</p>
<div class="sourceCode" id="cb65"><pre class="downlit">
<span class="va">ctl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/control_brokenstick.html">control_brokenstick</a></span><span class="op">(</span>kr <span class="op">=</span> <span class="fu"><a href="../reference/control_kr.html">control_kr</a></span><span class="op">(</span>imp_skip <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span>
<span class="va">knots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">6</span>, <span class="fl">9</span>, <span class="fl">12</span>, <span class="fl">15</span>, <span class="fl">18</span>, <span class="fl">24</span><span class="op">)</span><span class="op">/</span><span class="fl">12</span>, <span class="fl">4</span><span class="op">)</span>
<span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">bind_rows</span><span class="op">(</span><span class="va">smocc_200</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">smocc_200</span><span class="op">$</span><span class="va">hgt.z</span><span class="op">)</span>, <span class="op">]</span>,
                  <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">smocc_200</span><span class="op">$</span><span class="va">id</span><span class="op">)</span>, age <span class="op">=</span> <span class="va">knots</span><span class="op">)</span><span class="op">)</span>
<span class="va">fit_kr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/brokenstick.html">brokenstick</a></span><span class="op">(</span><span class="va">hgt.z</span> <span class="op">~</span> <span class="va">age</span> <span class="op">|</span> <span class="va">id</span>, data <span class="op">=</span> <span class="va">data</span>,
                      knots <span class="op">=</span> <span class="va">knots</span>, boundary <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">3</span><span class="op">)</span>,
                      method <span class="op">=</span> <span class="st">"kr"</span>, control <span class="op">=</span> <span class="va">ctl</span>, seed <span class="op">=</span> <span class="fl">15244</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">fit_kr</span>, new_data <span class="op">=</span> <span class="va">data</span>, show <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="cn">TRUE</span>, <span class="cn">FALSE</span>, <span class="cn">TRUE</span><span class="op">)</span>,
     group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">10001</span>, <span class="fl">10005</span>, <span class="fl">10022</span><span class="op">)</span>,
     xlab <span class="op">=</span> <span class="st">"Age (years)"</span>, ylab <span class="op">=</span> <span class="st">"Length (SDS)"</span><span class="op">)</span></pre></div>
<div class="figure">
<img src="brokenstick-article_files/figure-html/mi-code-1.png" alt="Observed data plotted on top of 20 imputed trajectories." width="100%"><p class="caption">
Observed data plotted on top of 20 imputed trajectories.
</p>
</div>
<p>Figure 20 displays the observed data from three persons plotted on top of 20 imputed trajectories. The within-person within-time average over the grey trajectories approximates to the broken stick estimate (not shown here). The observed curve in each panel occasionally strays towards the boundaries of the grey bundle. This behaviour is as expected and indicates that the blue curve performs like a grey curve.</p>
<p>Section 5.2 showed how we can estimate the time-to-time correlation matrix. An alternative way is to calculate it from the imputed data, as follows:</p>
<div class="sourceCode" id="cb66"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">smocc_200</span><span class="op">$</span><span class="va">id</span><span class="op">)</span>, age <span class="op">=</span> <span class="va">knots</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">bind_cols</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">fit_kr</span><span class="op">$</span><span class="va">draws</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">pivot_longer</span><span class="op">(</span>cols <span class="op">=</span> <span class="fu">starts_with</span><span class="op">(</span><span class="st">"V"</span><span class="op">)</span>, names_to <span class="op">=</span> <span class="st">"imp"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">pivot_wider</span><span class="op">(</span>id_cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"id"</span>, <span class="st">"imp"</span><span class="op">)</span>, names_from <span class="op">=</span> <span class="st">"age"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">id</span>, <span class="op">-</span><span class="va">imp</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cor</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></pre></div>
<pre><code>##           0 0.0833 0.1667 0.25  0.5 0.75    1 1.25  1.5    2
## 0      1.00   0.68   0.62 0.56 0.46 0.39 0.37 0.35 0.33 0.29
## 0.0833 0.68   1.00   0.81 0.76 0.66 0.56 0.53 0.53 0.50 0.45
## 0.1667 0.62   0.81   1.00 0.84 0.72 0.63 0.58 0.57 0.56 0.51
## 0.25   0.56   0.76   0.84 1.00 0.77 0.68 0.63 0.61 0.59 0.54
## 0.5    0.46   0.66   0.72 0.77 1.00 0.84 0.80 0.76 0.73 0.67
## 0.75   0.39   0.56   0.63 0.68 0.84 1.00 0.86 0.81 0.78 0.72
## 1      0.37   0.53   0.58 0.63 0.80 0.86 1.00 0.86 0.83 0.77
## 1.25   0.35   0.53   0.57 0.61 0.76 0.81 0.86 1.00 0.88 0.81
## 1.5    0.33   0.50   0.56 0.59 0.73 0.78 0.83 0.88 1.00 0.84
## 2      0.29   0.45   0.51 0.54 0.67 0.72 0.77 0.81 0.84 1.00</code></pre>
<p>Another important application of the multiply-imputed curves is to obtain correct confidence intervals and <span class="math inline">\(P\)</span>-values for estimates of scientific interest. The most convenient way to do this is to convert the <code>brokenstick</code> object into an object of class <code>mids</code>, as defined by the  package. The  package currently has no features that perform the conversion.</p>
</div>
<div id="curve-matching" class="section level2">
<h2 class="hasAnchor">
<a href="#curve-matching" class="anchor"></a>Curve matching</h2>
<p>Curve matching <span class="citation">(van Buuren 2014)</span> is a tool to assist in the interpretation and prediction of individual growth curves. The idea is as follows. Suppose we measure the growth of the target child up to half a year and plot the measurements onto his or her growth chart. Curve matching is a nearest-neighbour technique that relies on historical growth data. It finds, say, ten other children who are similar to the target child, and add the curves of those matches to the child’s chart. If the matching is done right, then the bundle of historic growth curves suggests how the target child will develop in the future.</p>
<div class="figure">
<img src="figures/JAMES_tryout.pdf" alt="Curve matching. Predict infant length at 14 months given length data up to 6 months using 10 matches." width="100%"><p class="caption">
Curve matching. Predict infant length at 14 months given length data up to 6 months using 10 matches.
</p>
</div>
<p>Figure 21 from <a href="https://tnochildhealthstatistics.shinyapps.io/james_tryout/" class="uri">https://tnochildhealthstatistics.shinyapps.io/james_tryout/</a> demonstrates curve matching for infant length. The red curve corresponds to five measurements of the target child made during the first six months. The ten grey curves are historic growth curves from the ten matched children. We may define similarity in many ways. Here we use a linear model to predict length at the age of 14m from previous length data. The distance between the target child and another child is equal to the difference between their predicted values. The procedure lifts the data of the matches from the database, and plots the observed growth curves onto the chart as grey curves. This method for finding nearest neighbours is known as <em>predictive mean matching</em> and has grown into a powerful technique for missing data.<span class="citation">(van Buuren 2018)</span> The bundle of grey curves indicates some possible future trajectories of the target child. The mean of the bundle is the most likely path. Graphically it is the dotted blue curve between the last measurement and the age of the outcome.</p>
<p>Let’s look at a numerical example. We split the data into one target child and 199 donor children, and fit a broken stick model to the donor set.</p>
<div class="sourceCode" id="cb68"><pre class="downlit">
<span class="va">donor_data</span> <span class="op">&lt;-</span> <span class="va">smocc_200</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">id</span> <span class="op">!=</span> <span class="st">"10001"</span><span class="op">)</span>
<span class="va">target_data</span> <span class="op">&lt;-</span> <span class="va">smocc_200</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">id</span> <span class="op">==</span> <span class="st">"10001"</span> <span class="op">&amp;</span> <span class="va">age</span> <span class="op">&lt;</span> <span class="fl">0.51</span><span class="op">)</span>

<span class="co"># fit brokenstick model at time level</span>
<span class="va">knots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">6</span>, <span class="fl">9</span>, <span class="fl">12</span>, <span class="fl">15</span>, <span class="fl">18</span>, <span class="fl">24</span><span class="op">)</span><span class="op">/</span><span class="fl">12</span>, <span class="fl">4</span><span class="op">)</span>
<span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/brokenstick.html">brokenstick</a></span><span class="op">(</span><span class="va">hgt.z</span> <span class="op">~</span> <span class="va">age</span> <span class="op">|</span> <span class="va">id</span>, data <span class="op">=</span> <span class="va">donor_data</span>,
                   knots <span class="op">=</span> <span class="va">knots</span>, boundary <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">3</span><span class="op">)</span>,
                   method <span class="op">=</span> <span class="st">"kr"</span>, seed <span class="op">=</span> <span class="fl">15244</span><span class="op">)</span></pre></div>
<p>All timepoints from the donor data enter the broken stick model. Note that the <code>target_data</code> contains only observations from the first five visits.</p>
<p>We now fit the prediction model on the child-level donor data. The prediction model contains the broken stick estimates for length SDS up to 6 months, as well as sex, gestational age and birth weight as covariates.</p>
<div class="sourceCode" id="cb69"><pre class="downlit">
<span class="co"># predict with matching model at child level</span>
<span class="va">covariates</span> <span class="op">&lt;-</span> <span class="va">donor_data</span> <span class="op">%&gt;%</span> 
  <span class="fu">group_by</span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">slice</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
<span class="va">bse</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fit</span>, <span class="va">donor_data</span>, x <span class="op">=</span> <span class="st">"knots"</span>, shape <span class="op">=</span> <span class="st">"wide"</span><span class="op">)</span>
<span class="va">donors</span> <span class="op">&lt;-</span> <span class="fu">bind_cols</span><span class="op">(</span><span class="va">covariates</span>, <span class="fu">select</span><span class="op">(</span><span class="va">bse</span>, <span class="op">-</span><span class="va">id</span><span class="op">)</span><span class="op">)</span>
<span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">`1.25`</span> <span class="op">~</span> <span class="va">`0`</span> <span class="op">+</span> <span class="va">`0.0833`</span> <span class="op">+</span> <span class="va">`0.1667`</span> <span class="op">+</span> <span class="va">`0.25`</span> <span class="op">+</span> <span class="va">`0.5`</span>
            <span class="op">+</span> <span class="va">sex</span> <span class="op">+</span> <span class="va">ga</span> <span class="op">+</span> <span class="va">bw</span>, data <span class="op">=</span> <span class="va">donors</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></pre></div>
<pre><code>## 
## Call:
## lm(formula = `1.25` ~ `0` + `0.0833` + `0.1667` + `0.25` + `0.5` + 
##     sex + ga + bw, data = donors)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -1.3111 -0.2836  0.0034  0.2848  1.4961 
## 
## Coefficients:
##              Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)  1.62e-02   7.31e-01    0.02     0.98    
## `0`          4.18e-02   5.06e-02    0.82     0.41    
## `0.0833`     1.70e-02   1.00e-01    0.17     0.87    
## `0.1667`    -6.85e-02   1.45e-01   -0.47     0.64    
## `0.25`      -2.58e-01   1.41e-01   -1.82     0.07 .  
## `0.5`        1.17e+00   7.98e-02   14.62   &lt;2e-16 ***
## sexmale      9.16e-02   6.38e-02    1.44     0.15    
## ga           6.74e-03   2.22e-02    0.30     0.76    
## bw          -1.05e-04   9.61e-05   -1.09     0.28    
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 0.43 on 190 degrees of freedom
## Multiple R-squared:  0.774,  Adjusted R-squared:  0.764 
## F-statistic: 81.3 on 8 and 190 DF,  p-value: &lt;2e-16</code></pre>
<p>The next step is to extract model predictions for both donors and target and find the ten closest donors.</p>
<div class="sourceCode" id="cb71"><pre class="downlit">
<span class="va">donors_pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">donors_pred</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">donors</span><span class="op">$</span><span class="va">id</span>

<span class="va">target</span> <span class="op">&lt;-</span> <span class="fu">bind_cols</span><span class="op">(</span>
  <span class="fu">slice</span><span class="op">(</span><span class="va">target_data</span>, <span class="fl">1</span><span class="op">)</span>, 
  <span class="fu">select</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fit</span>, <span class="va">target_data</span>, x <span class="op">=</span> <span class="st">"knots"</span>, shape <span class="op">=</span> <span class="st">"wide"</span><span class="op">)</span>, <span class="op">-</span><span class="va">id</span><span class="op">)</span><span class="op">)</span>
<span class="va">target_pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">model</span>, newdata <span class="op">=</span> <span class="va">target</span><span class="op">)</span>

<span class="va">matches</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">donors_pred</span> <span class="op">-</span> <span class="va">target_pred</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span>
<span class="va">matches</span></pre></div>
<pre><code>##  11013  10093  11023  11051  10006  10068  11063  10032  11046  11080 
## 0.0026 0.0376 0.0376 0.0693 0.0771 0.0792 0.0841 0.0852 0.0893 0.0953</code></pre>
<p>Finally, let us study the observed and fitted trajectories of the ten matches.</p>
<div class="sourceCode" id="cb73"><pre class="downlit">
<span class="va">ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">matches</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">fit</span>, new_data <span class="op">=</span> <span class="va">donor_data</span>, group <span class="op">=</span> <span class="va">ids</span>, 
     xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1.4</span><span class="op">)</span>, size_y <span class="op">=</span> <span class="fl">1</span>, size_yhat <span class="op">=</span> <span class="fl">0</span>,
     xlab <span class="op">=</span> <span class="st">"Age (years)"</span>, ylab <span class="op">=</span> <span class="st">"Length (SDS)"</span>, 
     ncol <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></pre></div>
<div class="figure">
<img src="brokenstick-article_files/figure-html/curvematching4-1.png" alt="Curve matching. Observed and fitted trajectories of 10 matches for subject 10001." width="100%"><p class="caption">
Curve matching. Observed and fitted trajectories of 10 matches for subject 10001.
</p>
</div>
<p>The ten trajectories are all are close to the prediction (0.101 SD) for the target child at the age of 1.25y. Note that this does not guarantee that the histories are identical. Most matches have relatively flat curves, but a few (10051, 11023, 11086) show striking rising patterns. Nevertheless, these candidates are the best in terms of the model prediction.</p>
<p>If we wish the curves of the matches during the first six months to be closer to the target case, we could consider alternative metrics. A simple measure is the sum of squares differences of the broken stick estimates. Such a selection may be visually more pleasing, at the expense of prediction accuracy. On the other hand, we are less tied to setting one particular future time point, so other measures may work better when “future” is more vaguely defined as a time interval. It is still an open research question where we strike a balance. Whatever the objectives of preferences from the user might be, the curve matching methodology, as illustrated here, has tremendous flexibility and is easy to adapt.</p>
</div>
</div>
<div id="conclusion" class="section level1">
<h1 class="hasAnchor">
<a href="#conclusion" class="anchor"></a>Conclusion</h1>
<div id="overview" class="section level3">
<h3 class="hasAnchor">
<a href="#overview" class="anchor"></a>Overview</h3>
<p>This paper introduces a new approach to solve the problem of irregular longitudinal data. The method absorbs the time-dependent information into a set of broken stick estimates at the subject level. The primary advantage is that it simplifies the analysis by splitting the modelling problem into two steps. First, solve the timing problem, and then solve the substantive/scientific problem. The method is mathematically simple, using a linear B-spline, conceptually simple, yet principled.</p>
</div>
<div id="distinctive-features" class="section level3">
<h3 class="hasAnchor">
<a href="#distinctive-features" class="anchor"></a>Distinctive features</h3>
<p>The assumptions of the model cover many cases of practical interest: a straight line between breakpoints, a multivariate normal distribution for the random effects, and the MAR assumption including future data. Despite the relatively low number of model parameters, it is possible to obtain a close fit to the data, sometimes almost up to perfect reconstruction (c.f. Figure 9). There is no need to specify equidistant breakpoints. Applications in human growth and development are often more natural using non-uniformly spaced knots, which is very easy to model. Many people find it easier to understand the raw data values than the summaries. The broken stick model invites visualisation of the actual data points against time and makes it is easy to portray uncertainty as a bundle of curves. Such direct visualisation options contribute to the explainable and responsible personalised analyses that appeal to a broad user group.</p>
</div>
<div id="current-limitations" class="section level3">
<h3 class="hasAnchor">
<a href="#current-limitations" class="anchor"></a>Current limitations</h3>
<p>The broken stick model, as presented here, uses just three variables: time, measurement and group. This design choice simplifies interpretation and estimation. The lack of covariates in the model implies that the transformation from irregular data to repeated measures is identical for every subject. As long as the residual error is small, the relations with not-in-the-model variables thus remain intact. The possibility to include covariate in a second-round enhances modular modern analytic pipelines. Yet, some will prefer the direct estimation of all effects in one more extensive analysis. The current package does not support covariates. However, an experienced <code>R</code> user will have no difficulty in extending the formula in section 3.5 to include the covariates of interest.</p>
<p>The method that requires that all subject share the same time axis and breakpoints. In our applications, synchronisation at the start was most natural (e.g. birth, start of experiment), which is easy to do. In some cases, one might wish to anchor in the middle, e.g. at menarche, which occurs at different ages for different individuals.<span class="citation">(Naumova, Must, and Laird 2001)</span> It could also make sense to fasten the end, e.g. at death. However, it will be hard to do meaningful predictive analysis as we cannot anchor alive subjects. The choice of the anchor may matter less for cyclic processes. The broken stick model is not suited for applications where breakpoints vary between individuals. In those cases, it is better to use the linear mixed model directly.</p>
</div>
<div id="software" class="section level3">
<h3 class="hasAnchor">
<a href="#software" class="anchor"></a>Software</h3>
<p>The Kasim-Raudenbush sampler <span class="citation">(Kasim and Raudenbush 1998)</span> is both fast and flexible. It produces estimates of the residual error variance per subject, can accommodate for correlation models and supports multiple imputation out-of-the-box. More research needed to establish its statistical properties especially compared to <code><a href="https://rdrr.io/pkg/lme4/man/lmer.html">lmer()</a></code> and other established methods. It would also be interesting to study the suitability of the correlation models implemented in the  package <span class="citation">(Ziyatdinov et al. 2018)</span>. As no training data are stored, instances of the <code>brokenstick</code> model class are tiny, often 15–20k.</p>
<p>Features not implemented, but that could be useful in future versions include a separate <code>impute()</code> function that inputs class <code>brokenstick</code> and returns class <code>mids</code>, a Trelliscope <span class="citation">(Hafen and Schloerke 2020)</span> viewer to quickly peruse hundreds of individuals model fits, an extension to multivariate time-varying and child-level data, and a generalisation to <code>degree &gt; 1</code> to support quadratic and cubic splines.</p>
</div>
<div id="methodological-advances" class="section level3">
<h3 class="hasAnchor">
<a href="#methodological-advances" class="anchor"></a>Methodological advances</h3>
<p>The primary modelling task for the user is to set the proper knot locations. One might envision scenarios where we want to search for the “best” places. It is not yet clear how we should do this, and how far we could automate knot placement strategies.</p>
<p>We need more insight into the statistical properties of procedures that execute the analysis as a sequence of steps. The relative pro’s and con’s of choices between multiple imputation versus random effects are not yet fully understood.</p>
<p>The current procedure assumes that the within-person error is constant across all time points. However, we might expect that observing more data close to the breakpoint will reduce the uncertainty of its estimate. In some applications, we might require that the estimate should equal the observed data value when the observation time coincides with the breakpoints. While models for such scenarios are considerably more complicated, they could also increase efficiency.</p>
</div>
<div id="conclusion-1" class="section level3">
<h3 class="hasAnchor">
<a href="#conclusion-1" class="anchor"></a>Conclusion</h3>
<p>This paper highlighted various applications of the broken stick model: critical periods, time-to-time correlation, profile analysis, curve interpolation, multiple imputation and personalised prediction. These applications certainly do not exhaust the potential of the model. My hope is that the availability of the software will stimulate creative uses, ideas and experiments.</p>
</div>
</div>
<div id="literature" class="section level1 unnumbered">
<h1 class="hasAnchor">
<a href="#literature" class="anchor"></a>Literature</h1>
<div id="refs" class="references">
<div id="ref-anderson2019">
<p>Anderson, C., R. Hafen, O. Sofrygin, L. Ryan, and HBGDki Community. 2019. “Comparing Predictive Abilities of Longitudinal Child Growth Models.” <em>Statistics in Medicine</em> 38 (19): 3555–70.</p>
</div>
<div id="ref-argyle2008">
<p>Argyle, J., A. H. Seheult, and D. A. Wooff. 2008. “Correlation Models for Monitoring Child Growth.” <em>Statistics in Medicine</em> 27 (6): 888–904.</p>
</div>
<div id="ref-bai2003">
<p>Bai, J., and P. Perron. 2003. “Computation and Analysis of Multiple Structural Change Models.” <em>Journal of Applied Econometrics</em> 18 (1): 1–22.</p>
</div>
<div id="ref-bates2015">
<p>Bates, D., M. Mächler, B. Bolker, and S. Walker. 2015. “Fitting Linear Mixed-Effects Models Using lme4.” <em>Journal of Statistical Software</em> 67 (1): 1–48. <a href="https://doi.org/10.18637/jss.v067.i01">https://doi.org/10.18637/jss.v067.i01</a>.</p>
</div>
<div id="ref-bellman1969">
<p>Bellman, R., and R. Roth. 1969. “Curve Fitting by Segmented Straight Lines.” <em>Journal of the American Statistical Association</em> 64 (327): 1079–84.</p>
</div>
<div id="ref-cole1995">
<p>Cole, T. J. 1995. “Conditional Reference Charts to Assess Weight Gain in British Infants.” <em>Archives of Disease in Childhood</em> 73 (1): 8–16.</p>
</div>
<div id="ref-deboor1978">
<p>de Boor, C. 1978. <em>A Practical Guide to Splines</em>. New York: Springer-Verlag.</p>
</div>
<div id="ref-dekroon2008">
<p>de Kroon, M. L. A., C. M. Renders, E. C. Kuipers, J. P. van Wouwe, S. van Buuren, G. A. de Jonge, and R. A. Hirasing. 2008. “Identifying Metabolic Syndrome Without Blood Tests in Young Adults - the Terneuzen Birth Cohort.” <em>European Journal of Public Health</em> 18 (6): 656–60.</p>
</div>
<div id="ref-dekroon2010">
<p>de Kroon, M. L. A., C. M. Renders, J. P. van Wouwe, S. van Buuren, and R. A. Hirasing. 2010. “The Terneuzen Birth Cohort: BMI Changes Between 2 and 6 Years Correlate Strongest with Adult Overweight.” <em>PloS ONE</em> 5 (2): e9155.</p>
</div>
<div id="ref-dietz1994">
<p>Dietz, W. H. 1994. “Critical Periods in Childhood for the Development of Obesity.” <em>American Journal of Clinical Nutrition</em> 59 (5): 955–59.</p>
</div>
<div id="ref-diggle1988">
<p>Diggle, P. J. 1988. “An Approach to the Analysis of Repeated Measurements.” <em>Biometrics</em>, 959–71.</p>
</div>
<div id="ref-diggle2002">
<p>Diggle, P. J., P. Heagerty, K. Y. Liang, and S. Zeger. 2002. <em>Analysis of Longitudinal Data. Second Edition.</em> Oxford University Press.</p>
</div>
<div id="ref-fitzmaurice2011">
<p>Fitzmaurice, G. M, N. M. Laird, and J. H. Ware. 2011. <em>Applied Longitudinal Analysis. Second Edition.</em> New York: John Wiley &amp; Sons.</p>
</div>
<div id="ref-fredriks2000">
<p>Fredriks, A. M., S. van Buuren, R. J. F. Burgmeijer, J. F. Meulmeester, R. J. Beuker, E. Brugman, M. J. Roede, S. P. Verloove-Vanhorick, and J. M. Wit. 2000. “Continuing Positive Secular Growth Change in the Netherlands 1955-1997.” <em>Pediatric Research</em> 47 (3): 316–23.</p>
</div>
<div id="ref-gelman2007">
<p>Gelman, A., and J. Hill. 2007. <em>Data Analysis Using Regression and Multilevel/Hierarchical Models</em>. Cambridge: Cambridge University Press.</p>
</div>
<div id="ref-hafen2020">
<p>Hafen, R., and B. Schloerke. 2020. <em>Trelliscopejs: Create Interactive Trelliscope Displays</em>. <a href="https://CRAN.R-project.org/package=trelliscopejs">https://CRAN.R-project.org/package=trelliscopejs</a>.</p>
</div>
<div id="ref-hand1987">
<p>Hand, D. J., and C. C. Taylor. 1987. <em>Multivariate Analysis of Variance and Repeated Measures: A Practical Approach for Behavioural Scientists</em>. Vol. 5. Boca Raton, FL: CRC press.</p>
</div>
<div id="ref-herngreen1994">
<p>Herngreen, W. P., S. van Buuren, J. C. van Wieringen, J. D. Reerink, S. P. Verloove-Vanhorick, and J. H. Ruys. 1994. “Growth in Length and Weight from Birth to 2 Years of a Representative Sample of Netherlands Children (Born in 1988-89) Related to Socio-Economic Status and Other Background Characteristics.” <em>Annals of Human Biology</em> 21 (5): 449–63.</p>
</div>
<div id="ref-ismail2016">
<p>Ismail, L. C., F. A. Puglia, E. O. Ohuma, S. T. Ash, D. C. Bishop, R. M. Carew, A. S. Al Dhaheri, and W. C. Chumlea. 2016. “Precision of Recumbent Crown-Heel Length When Using an Infantometer.” <em>BMC Pediatrics</em> 16 (1): 186.</p>
</div>
<div id="ref-johnson1988">
<p>Johnson, R. A., and D. W. Wichern. 1988. <em>Applied Multivariate Statistical Analysis. Second Edition.</em> Englewood Cliffs, NJ: Prentice Hall.</p>
</div>
<div id="ref-kasim1998">
<p>Kasim, R. M., and S. W. Raudenbush. 1998. “Application of Gibbs Sampling to Nested Variance Components Models with Heterogeneous Within-Group Variance.” <em>Journal of Educational and Behavioral Statistics</em> 23 (2): 93–116.</p>
</div>
<div id="ref-kenward1987">
<p>Kenward, M. G. 1987. “A Method for Comparing Profiles of Repeated Measurements.” <em>Journal of the Royal Statistical Society: Series C (Applied Statistics)</em> 36 (3): 296–308.</p>
</div>
<div id="ref-koutsoyiannis2000">
<p>Koutsoyiannis, D. 2000. “Broken Line Smoothing: A Simple Method for Interpolating and Smoothing Data Series.” <em>Environmental Modelling &amp; Software</em> 15 (2): 139–49.</p>
</div>
<div id="ref-krone2020">
<p>Krone, T., R. Boessen, S. Bijlsma, R. van Stokkum, N. D. S. Clabbers, and W. J. Pasman. 2020. “The Possibilities of the Use of N-of-1 and Do-It-Yourself Trials in Nutritional Research.” <em>PloS ONE</em> 15 (5): e0232680.</p>
</div>
<div id="ref-laird1982">
<p>Laird, N. M., and J. H. Ware. 1982. “Random-Effects Models for Longitudinal Data.” <em>Biometrics</em> 38 (4): 963–74.</p>
</div>
<div id="ref-lerman1980">
<p>Lerman, P. M. 1980. “Fitting Segmented Regression Models by Grid Search.” <em>Journal of the Royal Statistical Society: Series C (Applied Statistics)</em> 29 (1): 77–84.</p>
</div>
<div id="ref-lokku2020">
<p>Lokku, A., L. S. Lim, C. S. Birken, E. M. Pullenayegum, and TARGet Kids! Collaboration,. 2020. “Summarizing the Extent of Visit Irregularity in Longitudinal Data.” <em>BMC Medical Research Methodology</em> 20: 1–9.</p>
</div>
<div id="ref-macarthur1957">
<p>MacArthur, R. H. 1957. “On the Relative Abundance of Bird Species.” <em>Proceedings of the National Academy of Sciences of the United States of America</em> 43 (3): 293.</p>
</div>
<div id="ref-morrison1976">
<p>Morrison, D. F. 1976. <em>Multivariate Statistical Methods. Second Edition.</em> Singapore: McGraw-Hill.</p>
</div>
<div id="ref-naumova2001">
<p>Naumova, E. N., A. Must, and N. M. Laird. 2001. “Tutorial in Biostatistics: Evaluating the Impact of ‘Critical Periods’ in Longitudinal Studies of Growth Using Piecewise Mixed Effects Models.” <em>International Journal of Epidemiology</em> 30: 1332–41.</p>
</div>
<div id="ref-pullenayegum2016">
<p>Pullenayegum, E. M., and L. S. H. Lim. 2016. “Longitudinal Data Subject to Irregular Observation: A Review of Methods with a Focus on Visit Processes, Assumptions, and Study Design.” <em>Statistical Methods in Medical Research</em> 25 (6): 2992–3014.</p>
</div>
<div id="ref-r2020">
<p>R Core Team. 2020. <em>R: A Language and Environment for Statistical Computing</em>. Vienna, Austria: R Foundation for Statistical Computing. <a href="https://www.R-project.org/">https://www.R-project.org/</a>.</p>
</div>
<div id="ref-rehfeld2011">
<p>Rehfeld, K., N. Marwan, J. Heitzig, and J. Kurths. 2011. “Comparison of Correlation Analysis Techniques for Irregularly Sampled Time Series.” <em>Nonlinear Processes in Geophysics</em> 18 (3): 389–404.</p>
</div>
<div id="ref-rubin1987">
<p>Rubin, D. B. 1987. <em>Multiple Imputation for Nonresponse in Surveys</em>. New York: John Wiley &amp; Sons.</p>
</div>
<div id="ref-skrondal2009">
<p>Skrondal, A., and S. Rabe‐Hesketh. 2009. “Prediction in Multilevel Generalized Linear Models.” <em>Journal of the Royal Statistical Society: Series A (Statistics in Society)</em> 172 (3): 659–87.</p>
</div>
<div id="ref-toms2003">
<p>Toms, J. D., and M. L. Lesperance. 2003. “Piecewise Regression: A Tool for Identifying Ecological Thresholds.” <em>Ecology</em> 84 (8): 2034–41.</p>
</div>
<div id="ref-towers2014">
<p>Towers, S. 2014. “Potential Fitting Biases Resulting from Grouping Data into Variable Width Bins.” <em>Physics Letters B</em> 735: 146–48.</p>
</div>
<div id="ref-vanbuuren2007c">
<p>van Buuren, S. 2007. “Growth References.” In <em>Growth Disorders 2nd</em>, edited by C. Kelnar, M. Savage, P. Saenger, and C. Cowell, 165–81. London: Hodder Arnold.</p>
</div>
<div id="ref-vanbuuren2014d">
<p>———. 2014. “Curve Matching: A Data-Driven Technique to Improve Individual Prediction of Childhood Growth.” <em>Annals of Nutrition &amp; Metabolism</em> 65 (3): 227–33.</p>
</div>
<div id="ref-vanbuuren2018">
<p>———. 2018. <em>Flexible Imputation of Missing Data. Second Edition</em>. Boca Raton, FL.: CRC Press.</p>
</div>
<div id="ref-vaughan2020">
<p>Vaughan, D., and M. Kuhn. 2020. <em>Hardhat: Construct Modeling Packages</em>. <a href="https://CRAN.R-project.org/package=hardhat">https://CRAN.R-project.org/package=hardhat</a>.</p>
</div>
<div id="ref-ziyatdinov2018">
<p>Ziyatdinov, A., M. Vázquez-Santiago, H. Brunel, A. Martinez-Perez, H. Aschard, and J. M. Soria. 2018. “lme4qtl: Linear Mixed Models with Flexible Covariance Structure for Genetic Studies of Related Individuals.” <em>BMC Bioinformatics</em> 19 (1): 1–5.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="https://stefvanbuuren.name">Stef van Buuren</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
