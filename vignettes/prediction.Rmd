---
title: "Fit and predict"
author: "Stef van Buuren"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    fig_width: 6
    fig_height: 6
vignette: >
  %\VignetteIndexEntry{Fit and predict}
  %\VignetteEngine{knitr::rmarkdown}
  \%\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.cap = TRUE,
                      fig.width = 7, fig.height = 3,
                      dev = "svglite")
```

```{css echo = FALSE}
img {
  border: 0px;
  padding: 10px;
}
```


## Objective

This vignette shows a step-by-step introduction of how to 
- Fit the broken stick model to data;
- Predict observations by the fitted model.

## Get the data

This vignette assumes the `rbokeh`, `AGD`, `brokenstick` packages are installed. See [getting started with `brokenstick`](gettingstarted.html) for the installation procedure.

We will use the `smocc_200` demo data that is built-in into the `brokenstick` package.

```{r lib, include = FALSE}
require("brokenstick")
require("rbokeh")
require("growthstandards")
library("MASS")
library("ggcorrplot")
```

## Calculate $Z$-scores

The broken stick model can fit observations in either the raw scale (cm, kg, and so on) or as a standard deviation score (SDS), or $Z$-score. The results from the analysis of the $Z$-score is preferable for several reasons: 

1. for growth curves, a straight line assumption is more plausible in the $Z$-score scale;
2. the assumption of normality is more plausible in the $Z$-score scale;
3. fitting the $Z$-score data leads to less convergence issues.

It is easy to convert the measurements into the $Z$-score scale, fit the model, and convert back to the raw scale afterwards, if desired. There are several `R` packages that assist in the calculations: [AGD](https://cran.r-project.org/web/packages/AGD/index.html), [anthro](https://cran.r-project.org/web/packages/anthro/index.html), [childsds](https://cran.r-project.org/web/packages/childsds/index.html), [growthstandards](https://github.com/ki-tools/growthstandards) and [zscorer](https://cran.r-project.org/web/packages/zscorer/index.html). 

Here we use 200 children from the SMOCC data [@herngreen1994]. The `smocc_200` data contains the height measurement both in the original scale in cm (`hgt`) and the Z-score scale (`hgt.z`) as calculated against the growth references of the Fourth Dutch Growth study [@fredriks2000].

```{r zscores}
library(brokenstick)
data <- smocc_200
head(data)
```


```{r hgt_age, echo = FALSE, fig.height = 6, fig.width = 6, fig.cap = "Height (cm) by age (years) for 50 children of SMOCC."}
figure(xlab = "Age (year)", ylab = "Height (cm)") %>%
  ly_points(x = data$age, 
            y = data$hgt, 
            hover = c(data$age, data$hgt, data$hgt.z), size = 6) %>% 
  x_range(c(-0.1, 2.3))
```

The scatterplot of height against age clearly reveals the expected rising pattern of height. Also obvious will be the pattern of scheduled visits. Apart from birth, there is some variability in the timing of the visit, and this variability increases with age.

```{r z_age, echo = FALSE, fig.height = 6, fig.width = 6, fig.cap = "Height SDS by age (years) for 50 children of SMOCC."}
figure(xlab = "Age (years)", ylab = "Height SDS") %>%
  ly_zband(x = seq(0, 2.2, 0.2), z = -c(2.5,2,1,0)) %>%
  ly_points(data$age, data$hgt.z, hover = c(data$id, data$hgt), size = 6) %>% 
  x_range(c(-0.1, 2.3))
```

The figure above shows an alternative representation of the same data by replacing height by height SDS, thus revealing additional detail. Note that the data contain some outliers, especially at the lower end. For example, child 10059 was born after a gestational age of 34 weeks and has several extremely low SDS values. Child 10023 was born after 32 weeks of gestation.

## Define knots

The SMOCC study had 10 scheduled visits: at birth, and at ages of 1, 2, 3, 6, 9, 12, 15, 18 and 24 months. Here, we are interested in estimating what the most likely value would have been had the visit occured exactly on the schedules age. We therefore place the knots at the scheduled ages. 

```{r}
knots <- round(c(0, 1, 2, 3, 6, 9, 12, 15, 18, 24)/12, 4)
boundary <- c(0, 3)
```

In order to obtain the properties of the brokenstick model, the first knot should coincide with the left boundary knot (here 0), while the right boundary (here 3) must exceed than the maximum age in the data.

Note that this is not the only way to set knots. Depending of the scientific question at hand, we could place vary the number of knots, or place them at different locations. See the vignette on [knot placement](https://stefvanbuuren.name/brokenstick/articles/knotplacement.html) for a discussion of various options. 

## Fit the model

The `brokenstick()` function performs the actual model fitting, e.g., 

```{r cache = TRUE, eval = FALSE}
fit <- brokenstick(hgt.z ~ age | id, data,
                   knots = knots, boundary = boundary)
```

```{r echo = FALSE}
fit <- brokenstick::fit_200
```

The result is stored in the `fit` object, which has S3 class `brokenstick`. It contains the parameter estimates, as well as additional model specifications like `knots` and `boundary`.

Depending on the `method` argument, behind the scenes the `brokenstick()` function calls `lme4::lmer()` or the internal `kr()` function to estimate the parameters. The fitting algorithm may issue warnings about the number of random effect (too high), or reports the random-effects parameters or residual variance are probably unidentifiable. Despite these warnings, the estimated random effects are still useable, and in fact a good summary of the individual trajectories. Alternatively, the user may wish to simplify the model by removing knots. Above 10 knots, fitting becomes hard. At the least, the user should check the fitted object for plausibility, for example by plotting observed and modelled trajectories together.

## Interpret the model

Let us first extract the fixed effects and the corresponding knot locations.

```{r}
round(fit$beta, 2)
round(get_knots(fit), 2)
```

The fixed effects correspond to the mean of sample of children in the data. The mean development over all 206 children may be plotted as:

```{r meanplot, fig.height=5, fig.width=5, fig.cap = "Mean trajectory over all children"}
figure(xlab = "Age (years)", ylab = "Height (SDS)") %>%
  ly_points(get_knots(fit, "droplast"), fit$beta, hover = c(get_knots(fit), fit$beta)) %>%
  ly_lines(get_knots(fit, "droplast"), fit$beta) %>% 
  x_range(c(-0.1, 2.3)) %>% 
  y_range(c(-0.5, 0.5))
```

At birth, the children are on average 0.21 SD shorter than the Dutch standard. At later agesm the mean height of the children hovers around the values of zero, which is as expected. The last estimate (-0.28 SD) corresponds to the age of 3 years, and is not plotted. This estimate is just there for technical reasons. In general, the last knot of the broken stick model has no interpretation and should be disregarded.

```{r}
fit
```

The diagonal of the variance-covariance matrix contains the variances of the random effects. These numbers are expected to be around 1, since the dependent variable `hgt.z` follows a standard normal distribution with zero mean and standard deviation equal to one. The off-diagonal elements of time-to-time matrix are the covariances of the random effects at different ages.

```{r corplot, fig.width = 4, fig.height = 4, fig.cap = "Time-to-time correlation matrix", echo = FALSE}
cormat <- cov2cor(fit$omega)[-11, -11]
ggcorrplot::ggcorrplot(cormat, show.diag = FALSE, lab = TRUE, colors = c("blue", "white", "orange"), 
                       outline.color = "white", show.legend = FALSE, lab_size = 3, tl.cex = 8, 
                       lab_col = "navy")
```

The time-to-time correlation matrix shows a typically pattern where the higher elements are closer to the diagonal. This matrix preserves the correlation structure of the random effects. Note that we've pruned the right boundary knot.

The variance of the residuals (within-person error) for this model is of 0.05. The discrepancy between observed and fitted trajectories is about one fourth of a standard deviation. At the age of 2 years, the standard deviation in height is about 32 mm, so on average the difference between the model and the observed data is about 6-7 mm.

## Obtain predicted values, all children

The `predict()` function obtains predictions from the broken stick model. The function is extremely flexible, and allows for prediction of new subjects at arbitrary ages in a variety of output formats. The simplest call 

```{r}
p1 <- predict(fit, data)
head(p1, 4)
```

produces the predicted value (in `.pred`) for each rows in `data`. 

The predicted values represent a compromise between the person's data values and the global mean. In general, the fewer and less extreme data points of a person are, the closer the compromise will be toward the global mean. The compromise is called the *conditional mean* of the posterior distribution. In the broken stick model, it is simply calculated as the sum of the fixed and random effects.

We can obtain the locations at which the lines connect by specifying the `x = "knots"` argument, e.g.

```{r}
p2 <- predict(fit, data, x = "knots")
head(p2, 4)
```

Note that the output includes additional identifying information. We may also obtain both types of estimates for all children by using the 

```{r}
p3 <- predict(fit, data, x = "knots", strip_data = FALSE)
head(p3, 4)
```

The fitted trajectories of three selected children are plotted by

```{r traj3plot, fig.height = 3, warning=FALSE}
plot(fit, data, group = c(10001, 10005, 10022), xlim = c(0, 2.1))
```


## Obtain predicted values, single child

Obtaining predicted values for just one subject requires the `group` argument:

```{r}
p1 <- predict(fit, data, group = 10001)
```

The `predict()` function can return additional information by altering these arguments. Type `?predict.brokenstick` at the console to see the documentation. We can plot the original data and the broken stick estimates for child 10001 jointly by

```{r fig3, fig.height = 4, fig.width = 4, warning=FALSE}
plot(fit, data, group = 10001, xlim = c(0, 2.1))
```


## Convert to original scale

Modeling was done in the $Z$-score scale for the reasons given above. We may plot the result in the original scale by back-converting the estimates using the WHO reference, as follows:

```{r}
# convert Z-score to CM
p <- predict(fit, data, group = 10001, strip_data = FALSE)
p$ycm <- round(who_zscore2htcm(years2days(p$age), p$hgt.z, sex = "Female"), 1)
p$yhatcm <- who_zscore2htcm(years2days(p$age), p$.pred, sex = "Female")
head(p)
```

The corresponding figure in the cm scale can be produced as

```{r fig.height=6, fig.width=6}
p <- p[p$age <= 2.5,]
figure(xlab = "Age (years)", ylab = "Height (cm)") %>%
  ly_who(x = seq(0, 750, by = 30), y_var = "htcm",
         x_trans = days2years, sex = "Female", color = "green",
         p = 100 * pnorm(-c(2.5,2,1,0)))%>%
  ly_points(p$age, p$ycm, size = 8) %>%
  ly_lines(p$age, p$yhatcm, col = "orangered") %>%
  ly_points(p$age, p$yhatcm, col = "orangered", size = 5)
```

## Predict from the fitted model

Suppose we have measured a new boy, say Fred. We wish to obtain predictions for Fred using the model in `fit`. The following code calculates predictions at both the observed ages and at the knot locations:

```{r}
# Five age-haz observations for Fred
fred <- data.frame(
  age = c(0, 0.12, 0.32, 0.62, 1.1),
  hgt.z = c(-1.2, -1.8, -1.7, -1.9, -2.1),
  id = 1)
p <- predict(fit, fred, x = "knots", strip_data = FALSE)
p
```

We can plot the trajectories data by

```{r echo = TRUE, fig.height=4, fig.width=4}
plot(fit, fred, xlim = c(0, 2.1))
```

Based on the data up to 1.1 year, the model predicts that Fred's growth curve would remain around -2.0 SD until Fred is 1.5 years, and then increase to around -1.8 SD.


## Predict values, all children in the model

The `brokenstick` object does not store the training data, so we cannot do `predict(fit)`. However, if we have the data stored in a data frame or matrix called `data`, we can easily obtain predictions as follows:

```{r}
p <- predict(fit, data)
dim(p)
head(p, 3)
```

## Assess quality of prediction ($Z$-scale)

The scatterplot of the observed versus predicted values provides a visual representation of the accuracy of the prediction. 

```{r echo = FALSE, fig.height=6, fig.width=6}
eqscplot(x = data$hgt.z, xlab = "Height (SDS)", 
         y = p$.pred, ylab = "Predicted Z-score", 
         pch = ".", xlim = c(-4, 4), ylim = c(-4, 4))
abline(0, 1, col = "grey")
```

The correlation is equal to `r round(cor(p$.pred, data$hgt.z, use = "complete.obs"), 4)`. The standard deviation of the residuals is equal to `r round(sd(p$.pred - data$hgt.z, na.rm = TRUE), 3)`, a small value in the $Z$-scale.

## Assess quality of prediction (cm scale)

When back-converted to centimeters, the scatterplot of the observed versus predicted values is even a little tighter.  

```{r echo = FALSE, fig.width=6, fig.height = 6}
data$sex[data$sex == "male"] <- "Male"
data$sex[data$sex == "female"] <- "Female"
y_cm <- who_zscore2htcm(years2days(data$age), data$hgt.z, data$sex)
yhat_cm <- who_zscore2htcm(years2days(data$age), p$.pred, data$sex)
eqscplot(x = y_cm, xlab = "Height (cm)",
         y = yhat_cm, ylab = "Predicted (cm)", pch = ".")
abline(0, 1, col = "grey")
```

The proportion of explained variance is `r round(cor(y_cm, yhat_cm, use = "complete.obs")^2, 4)`. The standard deviation of the residuals is equal to `r round(sd(y_cm - yhat_cm, na.rm = TRUE), 3)` cm, which is about the size of the measurement error.
